<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aftermarket Kit Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Light gray background */
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #e0e0e0;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .modal-bg { background: rgba(0,0,0,0.5); }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .dark-mode {
            background-color: #1a202c; /* Dark background */
            color: #e2e8f0; /* Light text */
        }
        .dark-mode header {
            background-image: linear-gradient(to right, #2d3748, #4a5568);
        }
        .dark-mode .bg-white {
            background-color: #2d3748;
            color: #e2e8f0;
        }
        .dark-mode .bg-gray-50 {
            background-color: #4a5568;
        }
        .dark-mode .bg-gray-100 {
            background-color: #2d3748;
        }
        .dark-mode .border {
            border-color: #4a5568;
        }
        .dark-mode input, .dark-mode select, .dark-mode textarea {
            background-color: #4a5568;
            border-color: #6b7280;
            color: #e2e8f0;
        }
        .dark-mode table thead th {
            background-color: #4a5568;
        }
        .dark-mode table tbody tr {
            background-color: #2d3748;
        }
        .dark-mode table tbody tr:nth-child(even) {
            background-color: #1a202c;
        }
        .dark-mode .modal-content {
            background-color: #2d3748;
        }
        .dark-mode .text-gray-400 {
            color: #a0aec0;
        }
        .dark-mode .text-gray-600 {
            color: #cbd5e0;
        }
        .dark-mode .text-gray-700 {
            color: #e2e8f0;
        }
        .dark-mode .text-gray-800 {
            color: #f7fafc;
        }
        .dark-mode .text-gray-900 {
            color: #ffffff;
        }
        .dark-mode .bg-blue-100 { background-color: #2c5282; }
        .dark-mode .text-blue-700 { color: #90cdf4; }
        .dark-mode .text-blue-900 { color: #bfdbfe; }
        .dark-mode .bg-green-100 { background-color: #2f855a; }
        .dark-mode .text-green-700 { color: #68d391; }
        .dark-mode .text-green-900 { color: #a7f3d0; }
        .dark-mode .bg-red-100 { background-color: #9b2c2c; }
        .dark-mode .text-red-700 { color: #feb2b2; }
        .dark-mode .text-red-900 { color: #fca5a5; }
        .dark-mode .bg-yellow-100 { background-color: #975a16; }
        .dark-mode .text-yellow-700 { color: #f6e05e; }
        .dark-mode .text-yellow-900 { color: #fcd34d; }
        .dark-mode .bg-blue-50 { background-color: #2a4365; }
        .dark-mode .border-blue-400 { border-color: #63b3ed; }
        .dark-mode .bg-indigo-50 { background-color: #434190; }
        .dark-mode .border-indigo-400 { border-color: #a78bfa; }
        .dark-mode .bg-red-50 { background-color: #4a0e0e; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">

    <header class="bg-gradient-to-r from-blue-600 to-indigo-700 text-white p-4 shadow-lg flex flex-col gap-4">
        <h1 class="text-2xl font-bold mb-2">Kit Management</h1>
        <nav class="flex flex-wrap gap-2 justify-center">
            <button onclick="scrollToSection('dashboard')" class="bg-blue-500 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">Dashboard</button>
            <button onclick="scrollToSection('kit-management')" class="bg-blue-500 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">Kit Management</button>
            <button onclick="scrollToSection('inventory')" class="bg-blue-500 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">Component Inventory</button>
            <button onclick="scrollToSection('reports')" class="bg-blue-500 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">Reports & Analytics</button>
            <button onclick="openSettingsSidebar()" class="bg-blue-500 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">Settings</button>
        </nav>
    </header>

    <main class="flex-1 w-full max-w-[1800px] mx-auto p-4 grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6">
        <section id="dashboard" class="col-span-full scroll-mt-32">
            <div class="bg-white rounded-xl shadow-lg p-6 mb-6 h-full flex flex-col">
                <h2 class="text-2xl font-semibold mb-4">Dashboard Overview</h2>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-blue-100 p-4 rounded-lg flex flex-col items-center">
                        <span class="text-blue-700 font-medium">Total Kits</span>
                        <span class="text-2xl font-bold text-blue-900" id="totalKits">0</span>
                    </div>
                    <div class="bg-green-100 p-4 rounded-lg flex flex-col items-center">
                        <span class="text-green-700 font-medium">Kits Created</span>
                        <span class="text-2xl font-bold text-green-900" id="kitsCreated">0</span>
                    </div>
                    <div class="bg-red-100 p-4 rounded-lg flex flex-col items-center">
                        <span class="text-red-700 font-medium">Kits Broken</span>
                        <span class="text-2xl font-bold text-red-900" id="kitsBroken">0</span>
                    </div>
                    <div class="bg-yellow-100 p-4 rounded-lg flex flex-col items-center">
                        <span class="text-yellow-700 font-medium">Low Stock Kits</span>
                        <span class="text-2xl font-bold text-yellow-900" id="lowStockKits">0</span>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 flex-1">
                    <div class="bg-gray-50 p-4 rounded-lg flex-1">
                        <h3 class="font-semibold mb-2">Kit Activity Trend</h3>
                        <canvas id="kitTrendChart" height="120"></canvas>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg flex-1">
                        <h3 class="font-semibold mb-2">Top 5 Popular Kits</h3>
                        <canvas id="popularKitsChart" height="120"></canvas>
                    </div>
                </div>
            </div>
        </section>

        <section id="kit-management" class="col-span-full scroll-mt-32">
            <div class="bg-white rounded-xl shadow-lg p-6 mb-6 h-full flex flex-col">
                <div class="flex flex-col md:flex-row md:justify-between md:items-center mb-4 gap-2">
                    <h2 class="text-2xl font-semibold">Kit Management</h2>
                    <div class="flex gap-2">
                        <button onclick="openKitModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">Create New Kit</button>
                        <button onclick="openBreakModal()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg">Break Down Kit</button>
                    </div>
                </div>
                <input id="kitSearch" type="text" placeholder="Search kits..." class="p-2 border rounded-lg mb-4 w-full md:w-1/3" oninput="renderKitTable()"/>
                <div class="overflow-x-auto rounded-lg flex-1">
                    <table class="min-w-full text-sm">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-2 py-2">Kit #</th>
                                <th class="px-2 py-2">Date</th>
                                <th class="px-2 py-2">Prefix</th>
                                <th class="px-2 py-2">Kit Part #</th>
                                <th class="px-2 py-2">Description</th>
                                <th class="px-2 py-2">Warehouse</th>
                                <th class="px-2 py-2">Status</th>
                                <th class="px-2 py-2">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="kitTable" class="bg-white"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <div class="col-span-full grid grid-cols-1 lg:grid-cols-2 gap-6">
            <section id="reports" class="lg:col-span-1 scroll-mt-32">
                <div class="bg-white rounded-xl shadow-lg p-6 mb-6 h-full flex flex-col">
                    <h2 class="text-2xl font-semibold mb-4">Reports & Analytics</h2>
                    <div class="flex flex-wrap gap-2 mb-4">
                        <button onclick="showReport('sales')" class="bg-gray-200 hover:bg-gray-300 px-3 py-1 rounded-lg text-sm">Sales Performance</button>
                        <button onclick="showReport('valuation')" class="bg-gray-200 hover:bg-gray-300 px-3 py-1 rounded-lg text-sm">Inventory Valuation</button>
                        <button onclick="showReport('history')" class="bg-gray-200 hover:bg-gray-300 px-3 py-1 rounded-lg text-sm">Activity History</button>
                        <button onclick="showReport('usage')" class="bg-gray-200 hover:bg-gray-300 px-3 py-1 rounded-lg text-sm">Component Usage</button>
                    </div>
                    <div id="reportContent" class="bg-gray-50 p-4 rounded-lg flex-1 flex items-center justify-center text-gray-500 min-h-[200px]">
                        Select a report to view its content.
                    </div>
                    <canvas id="reportsChart" height="120" class="mt-4 hidden"></canvas>
                </div>
            </section>

            <section id="inventory" class="lg:col-span-1 scroll-mt-32">
                <div class="bg-white rounded-xl shadow-lg p-6 mb-6 h-full flex flex-col">
                    <h2 class="text-2xl font-semibold mb-4">Component Inventory</h2>
                    <input id="componentSearch" type="text" placeholder="Search components..." class="p-2 border rounded-lg mb-4 w-full" oninput="renderComponentTable()"/>
                    <div class="overflow-x-auto rounded-lg flex-1">
                        <table class="min-w-full text-sm">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-2 py-2">Component</th>
                                    <th class="px-2 py-2">Stock</th>
                                    <th class="px-2 py-2">Location</th>
                                    <th class="px-2 py-2">Min Stock</th>
                                    <th class="px-2 py-2">Kits Used In</th>
                                    <th class="px-2 py-2">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="componentTable" class="bg-white"></tbody>
                        </table>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <div id="sidebarOverlay" class="fixed inset-0 bg-black bg-opacity-50 z-[90] hidden" onclick="closeSettingsSidebar()"></div>
    <div id="settingsSidebar" class="fixed right-0 top-0 bottom-0 w-80 bg-white shadow-2xl transform translate-x-full transition-transform duration-300 ease-in-out z-[100]">
        <div class="p-6 h-full flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold">Settings</h3>
                <button type="button" onclick="closeSettingsSidebar()" class="text-2xl font-bold text-gray-400 hover:text-gray-600">&times;</button>
            </div>
            <div class="flex flex-col gap-3 flex-1">
                <button onclick="openAppearanceSettingsModal()" class="bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded-lg text-left">Appearance (Theme, Dark/Light Mode)</button>
                <button onclick="openLanguageSettingsModal()" class="bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded-lg text-left">Language Handling</button>
                <button class="bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded-lg text-left">User Management</button>
                <button class="bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded-lg text-left">Kit Categories Configuration</button>
                <button class="bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded-lg text-left">Integration Settings</button>
                <button class="bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded-lg text-left">Unit of Measure Definitions</button>
            </div>
        </div>
    </div>


    <div id="kitModal" class="fixed inset-0 z-[110] hidden items-center justify-center modal-bg">
    <div class="bg-white rounded-xl shadow-xl p-6 w-full max-w-7xl mx-auto max-h-[95vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-semibold">Add New Making Of Kit</h3>
            <button type="button" onclick="closeKitModal()" class="text-2xl font-bold text-gray-400 hover:text-gray-600">&times;</button>
        </div>
        <form id="kitForm" onsubmit="submitKitForm(event)">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block font-medium mb-1">Kit Making # :</label>
                    <input type="text" id="kitMakingNo" class="p-2 border rounded-lg w-full mb-2" placeholder="Auto-generated" readonly />
                </div>
                <div>
                    <label class="block font-medium mb-1">Kit Making Date :</label>
                    <input type="text" id="kitMakingDate" class="p-2 border rounded-lg w-full mb-2" value="30-05-2025" readonly />
                </div>
                <div>
                    <label class="block font-medium mb-1">Kit Part # :</label>
                    <input required type="text" id="kitPartNo" class="p-2 border rounded-lg w-full mb-2" value="VZ1900" />
                </div>
                <div>
                    <label class="block font-medium mb-1">Kit Part Description :</label>
                    <input type="text" id="kitDesc" class="p-2 border rounded-lg w-full mb-2" value="BEARING (KIT)" />
                </div>
                <div>
                    <label class="block font-medium mb-1">Kit Part Free Stock :</label>
                    <input type="number" id="kitFreeStock" class="p-2 border rounded-lg w-full mb-2" value="174" readonly />
                </div>
                <div>
                    <label class="block font-medium mb-1">Number Of Kits To Make :</label>
                    <input type="number" id="kitQty" class="p-2 border rounded-lg w-full mb-2" value="1" min="1" />
                </div>
                <div>
                    <label class="block font-medium mb-1">Ware House :</label>
                    <select id="kitWarehouse" class="p-2 border rounded-lg w-full mb-2">
                        <option value="">-- Select Warehouse --</option>
                        <option value="WH1">WH1</option>
                        <option value="WH2">WH2</option>
                    </select>
                </div>
                <div>
                    <label class="block font-medium mb-1">Remarks:</label>
                    <textarea id="kitRemarks" class="p-2 border rounded-lg w-full mb-2"></textarea>
                </div>
            </div>
            <div class="mb-4">
                <label class="block font-medium mb-2">Available Parts</label>
                <div id="partCardList" class="flex flex-wrap gap-4 mb-4 min-h-[120px] border p-2 bg-gray-50 rounded overflow-y-auto max-h-48"></div>
                <label class="block font-medium mb-2 mt-4">Bill of Materials (Drag & Drop Parts Here)</label>
                <div id="bomArea" class="min-h-[150px] border-2 border-dashed border-blue-400 rounded mb-2 p-2 bg-blue-50 flex flex-wrap gap-2 overflow-y-auto max-h-48">
                    </div>
            </div>
            <div class="flex justify-end gap-2">
                <button type="button" onclick="closeKitModal()" class="px-4 py-2 rounded-lg border">Cancel</button>
                <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">Save Kit</button>
            </div>
        </form>
    </div>
</div>

    <div id="breakModal" class="fixed inset-0 z-[110] hidden items-center justify-center modal-bg">
        <div class="bg-white rounded-xl shadow-xl p-6 w-full max-w-xl mx-auto max-h-[95vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold">Break Down Kit</h3>
                <button type="button" onclick="closeBreakModal()" class="text-2xl font-bold text-gray-400 hover:text-gray-600">&times;</button>
            </div>
            <form id="breakForm" onsubmit="submitBreakForm(event)">
                <label class="block font-medium mb-2">Available Kits to Break (Drag & Drop)</label>
                <div id="availableKitsForBreak" class="flex flex-wrap gap-4 mb-4 min-h-[120px] border p-2 bg-gray-50 rounded overflow-y-auto max-h-48"></div>

                <label class="block font-medium mb-2 mt-4">Drop Kit Here to Breakdown</label>
                <div id="breakKitDropZone" class="min-h-[100px] border-2 border-dashed border-indigo-400 rounded mb-4 p-2 bg-indigo-50 flex items-center justify-center text-gray-500">
                    Drag a kit card here
                </div>

                <div id="selectedKitDisplay" class="mb-4 hidden">
                    <h4 class="font-semibold text-lg mb-2">Selected Kit: <span id="selectedKitName" class="text-blue-700"></span></h4>
                    <label class="block mb-1 font-medium">Select Parts to Return:</label>
                    <div id="breakPartSelect" class="flex flex-wrap gap-2 mb-3"></div>
                </div>

                <div class="flex justify-end gap-2">
                    <button type="button" onclick="closeBreakModal()" class="px-4 py-2 rounded-lg border">Cancel</button>
                    <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg">Break Kit</button>
                </div>
            </form>
        </div>
    </div>

    <footer class="bg-gray-800 text-white p-4 text-center mt-8">
        <div class="container mx-auto">
            <p>&copy; 2025 Aftermarket Solutions. All rights reserved.</p>
        </div>
    </footer>

    <div id="editComponentModal" class="fixed inset-0 z-[110] hidden items-center justify-center modal-bg">
        <div class="bg-white rounded-xl shadow-xl p-6 w-full max-w-md mx-auto max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold">Edit Component</h3>
                <button type="button" onclick="closeEditComponentModal()" class="text-2xl font-bold text-gray-400 hover:text-gray-600">&times;</button>
            </div>
            <form id="editComponentForm" onsubmit="submitEditComponentForm(event)">
                <input type="hidden" id="editComponentNameOriginal">
                <div class="mb-4">
                    <label class="block font-medium mb-1">Component Name:</label>
                    <input type="text" id="editComponentName" class="p-2 border rounded-lg w-full" required>
                </div>
                <div class="mb-4">
                    <label class="block font-medium mb-1">Location:</label>
                    <input type="text" id="editComponentLocation" class="p-2 border rounded-lg w-full">
                </div>
                <div class="mb-4">
                    <label class="block font-medium mb-1">Minimum Stock Alert:</label>
                    <input type="number" id="editComponentMinStock" class="p-2 border rounded-lg w-full" min="0">
                </div>
                <div class="flex justify-end gap-2">
                    <button type="button" onclick="closeEditComponentModal()" class="px-4 py-2 rounded-lg border">Cancel</button>
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <div id="adjustStockModal" class="fixed inset-0 z-[110] hidden items-center justify-center modal-bg">
        <div class="bg-white rounded-xl shadow-xl p-6 w-full max-w-md mx-auto max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold">Adjust Stock</h3>
                <button type="button" onclick="closeAdjustStockModal()" class="text-2xl font-bold text-gray-400 hover:text-gray-600">&times;</button>
            </div>
            <form id="adjustStockForm" onsubmit="submitAdjustStockForm(event)">
                <input type="hidden" id="adjustStockComponentName">
                <div class="mb-4">
                    <label class="block font-medium mb-1">Component:</label>
                    <input type="text" id="adjustStockComponentDisplay" class="p-2 border rounded-lg w-full bg-gray-100" readonly>
                </div>
                <div class="mb-4">
                    <label class="block font-medium mb-1">Current Stock:</label>
                    <input type="number" id="adjustStockCurrentStock" class="p-2 border rounded-lg w-full bg-gray-100" readonly>
                </div>
                <div class="mb-4">
                    <label class="block font-medium mb-1">Adjustment Quantity:</label>
                    <input type="number" id="adjustStockQuantity" class="p-2 border rounded-lg w-full" required value="0">
                    <p class="text-sm text-gray-500 mt-1">Use positive for adding, negative for removing.</p>
                </div>
                <div class="flex justify-end gap-2">
                    <button type="button" onclick="closeAdjustStockModal()" class="px-4 py-2 rounded-lg border">Cancel</button>
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">Apply Adjustment</button>
                </div>
            </form>
        </div>
    </div>

    <div id="appearanceSettingsModal" class="fixed inset-0 z-[110] hidden items-center justify-center modal-bg">
        <div class="bg-white rounded-xl shadow-xl p-6 w-full max-w-md mx-auto max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold">Appearance Settings</h3>
                <button type="button" onclick="closeAppearanceSettingsModal()" class="text-2xl font-bold text-gray-400 hover:text-gray-600">&times;</button>
            </div>
            <div class="mb-4">
                <label class="block font-medium mb-1">Theme:</label>
                <div class="flex items-center space-x-4">
                    <label class="inline-flex items-center">
                        <input type="radio" name="theme" value="light" class="form-radio" checked onchange="toggleDarkMode(false)">
                        <span class="ml-2">Light Mode</span>
                    </label>
                    <label class="inline-flex items-center">
                        <input type="radio" name="theme" value="dark" class="form-radio" onchange="toggleDarkMode(true)">
                        <span class="ml-2">Dark Mode</span>
                    </label>
                </div>
            </div>
            <div class="flex justify-end gap-2">
                <button type="button" onclick="closeAppearanceSettingsModal()" class="px-4 py-2 rounded-lg border">Close</button>
            </div>
        </div>
    </div>

    <div id="languageSettingsModal" class="fixed inset-0 z-[110] hidden items-center justify-center modal-bg">
        <div class="bg-white rounded-xl shadow-xl p-6 w-full max-w-md mx-auto max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold">Language Settings</h3>
                <button type="button" onclick="closeLanguageSettingsModal()" class="text-2xl font-bold text-gray-400 hover:text-gray-600">&times;</button>
            </div>
            <div class="mb-4">
                <label class="block font-medium mb-1">Select Language:</label>
                <select id="languageSelect" class="p-2 border rounded-lg w-full" onchange="changeLanguage(this.value)">
                    <option value="en">English</option>
                    <option value="es">Spanish (Dummy)</option>
                    <option value="fr">French (Dummy)</option>
                </select>
            </div>
            <div class="flex justify-end gap-2">
                <button type="button" onclick="closeLanguageSettingsModal()" class="px-4 py-2 rounded-lg border">Close</button>
            </div>
        </div>
    </div>


    <script>
        // Global variable to hold the kit selected for breaking
        let selectedKitToBreak = null;

        // Add this function at the top of your script block
        function scrollToSection(sectionId) {
            const section = document.getElementById(sectionId);
            if (section) {
                section.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        // Dummy Data
        let kits = [
            { kitNo: "KM177N1V2025", date: "2025-01-13", prefix: "P", partNo: "192200", desc: "BLOWER CASING", warehouse: "177N-17N", status: "Completed", parts: ["Blower", "Casing", "Bolt"] },
            { kitNo: "KM177N1V2024", date: "2025-01-02", prefix: "N", partNo: "G1200853", desc: "FILTER-WATER (NO INHBIT CHG)", warehouse: "177N-17N", status: "In Progress", parts: ["Filter", "Seal"] },
            { kitNo: "KM177N1V2024A", date: "2024-04-30", prefix: "N", partNo: "WF2122", desc: "FILTER, WATER", warehouse: "177N-17N", status: "Pending", parts: ["Filter", "Gasket"] },
            { kitNo: "KM177N1V2023", date: "2023-09-22", prefix: "N", partNo: "G1200853", desc: "FILTER-WATER (NO INHBIT CHG)", warehouse: "177N-17N", status: "Completed", parts: ["Filter", "Seal"] },
            { kitNo: "KM177N1V/09/2023", date: "2023-09-07", prefix: "P", partNo: "G1095046", desc: "ANCRAGE >SS 011604", warehouse: "177N-17N", status: "Pending", parts: ["Anchor", "Screw"] }
        ];
        let components = [
            { name: "Blower", stock: 20, location: "A1", kits: ["KM177N1V2025"], minStock: 5 },
            { name: "Casing", stock: 15, location: "A2", kits: ["KM177N1V2025"], minStock: 5 },
            { name: "Bolt", stock: 50, location: "A3", kits: ["KM177N1V2025"], minStock: 10 },
            { name: "Filter", stock: 10, location: "B1", kits: ["KM177N1V2024", "KM177N1V2024A", "KM177N1V2023"], minStock: 10 },
            { name: "Seal", stock: 8, location: "B2", kits: ["KM177N1V2024", "KM177N1V2023"], minStock: 10 },
            { name: "Gasket", stock: 5, location: "B3", kits: ["KM177N1V2024A"], minStock: 5 },
            { name: "Anchor", stock: 12, location: "C1", kits: ["KM177N1V/09/2023"], minStock: 5 },
            { name: "Screw", stock: 30, location: "C2", kits: ["KM177N1V/09/2023"], minStock: 10 }
        ];

        // Dashboard Stats
        function updateDashboard() {
            document.getElementById("totalKits").textContent = kits.length;
            document.getElementById("kitsCreated").textContent = kits.filter(k => k.status === "Completed").length;
            document.getElementById("kitsBroken").textContent = kits.filter(k => k.status === "Broken").length;
            document.getElementById("lowStockKits").textContent = components.filter(c => c.stock < c.minStock).length;
        }

        // Kit Table
        function renderKitTable() {
            let search = document.getElementById("kitSearch")?.value?.toLowerCase() || "";
            let tbody = document.getElementById("kitTable");
            tbody.innerHTML = "";
            kits.filter(kit =>
                kit.kitNo.toLowerCase().includes(search) ||
                kit.partNo.toLowerCase().includes(search) ||
                kit.desc.toLowerCase().includes(search)
            ).forEach(kit => {
                let tr = document.createElement("tr");
                tr.innerHTML = `
                    <td class="px-2 py-1">${kit.kitNo}</td>
                    <td class="px-2 py-1">${kit.date}</td>
                    <td class="px-2 py-1">${kit.prefix}</td>
                    <td class="px-2 py-1">${kit.partNo}</td>
                    <td class="px-2 py-1">${kit.desc}</td>
                    <td class="px-2 py-1">${kit.warehouse}</td>
                    <td class="px-2 py-1">${kit.status}</td>
                    <td class="px-2 py-1">
                        <button onclick="breakKit('${kit.kitNo}')" class="text-red-600 hover:underline">Break</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // Component Table
        function renderComponentTable() {
            let search = document.getElementById("componentSearch")?.value?.toLowerCase() || "";
            let tbody = document.getElementById("componentTable");
            tbody.innerHTML = "";
            components.filter(c =>
                c.name.toLowerCase().includes(search)
            ).forEach(c => {
                const rowClass = c.stock < c.minStock ? 'bg-red-50' : ''; // Highlight low stock
                let tr = document.createElement("tr");
                tr.className = rowClass;
                tr.innerHTML = `
                    <td class="px-2 py-1">${c.name}</td>
                    <td class="px-2 py-1">${c.stock}</td>
                    <td class="px-2 py-1">${c.location}</td>
                    <td class="px-2 py-1">${c.minStock}</td>
                    <td class="px-2 py-1">${c.kits.join(", ")}</td>
                    <td class="px-2 py-1">
                        <button onclick="openEditComponentModal('${c.name}')" class="text-blue-600 hover:underline mr-2">Edit</button>
                        <button onclick="openAdjustStockModal('${c.name}')" class="text-green-600 hover:underline">Adjust Stock</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // Render part cards for drag and drop (for Kit Making)
        function renderPartCards() {
            const partCardList = document.getElementById('partCardList');
            partCardList.innerHTML = '';
            components.forEach(c => {
                const card = document.createElement('div');
                card.className = "bg-white border rounded-lg shadow p-3 w-56 cursor-move";
                card.draggable = true;
                card.dataset.part = JSON.stringify(c);
                card.innerHTML = `
                    <div class="font-bold text-blue-700">${c.name}</div>
                    <div class="text-xs text-gray-500 mb-1">Location: ${c.location}</div>
                    <div class="text-xs text-gray-500 mb-1">Stock: ${c.stock}</div>
                    <div class="text-xs text-gray-500 mb-1">Used In: ${c.kits.join(', ')}</div>
                    <div class="text-xs text-gray-500">Drag to add</div>
                `;
                card.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('application/json', card.dataset.part);
                });
                partCardList.appendChild(card);
            });
        }

        // Drag and drop for BOM area (combined drop zone and display)
        const bomArea = document.getElementById('bomArea');
        bomArea.addEventListener('dragover', function(e) {
            e.preventDefault();
            bomArea.classList.add('bg-blue-100');
        });
        bomArea.addEventListener('dragleave', function() {
            bomArea.classList.remove('bg-blue-100');
        });
        bomArea.addEventListener('drop', function(e) {
            e.preventDefault();
            bomArea.classList.remove('bg-blue-100');
            try {
                const part = JSON.parse(e.dataTransfer.getData('application/json'));
                addPartToBOMCards(part);
            } catch (error) {
                console.error("Error parsing dropped data:", error);
            }
        });

        // Add part as card to BOM area
        function addPartToBOMCards(part) {
            // Prevent duplicate parts in BOM
            const exists = Array.from(document.querySelectorAll('#bomArea .bom-card')).some(card => card.dataset.partNo === part.name);
            if (exists) {
                console.log(`Part ${part.name} already in BOM.`);
                return;
            }
            const card = document.createElement('div');
            card.className = "bom-card bg-white border-2 border-blue-400 rounded-lg shadow p-3 w-56 relative";
            card.dataset.partNo = part.name;
            card.innerHTML = `
                <div class="font-bold text-blue-700">${part.name}</div>
                <div class="text-xs text-gray-500 mb-1">Location: ${part.location}</div>
                <div class="text-xs text-gray-500 mb-1">Stock: ${part.stock}</div>
                <div class="text-xs text-gray-500 mb-1">Quantity Of BOM: <input type="number" class="border rounded w-16" value="1" min="1"></div>
                <div class="text-xs text-gray-500 mb-1">Quantity Required: <input type="number" class="border rounded w-16" value="1" min="1"></div>
                <button type="button" onclick="removeBOMCard(this)" class="absolute top-1 right-2 text-red-600 hover:underline text-lg">&times;</button>
            `;
            bomArea.appendChild(card); // Append to the combined bomArea
        }

        // Remove BOM card
        function removeBOMCard(btn) {
            btn.closest('.bom-card').remove();
        }

        // Kit Modal (Create Kit)
        function openKitModal() {
            document.getElementById("kitModal").classList.remove("hidden");
            renderPartCards(); // Render available parts for drag and drop
            bomArea.innerHTML = ''; // Clear BOM cards from the combined bomArea
        }
        function closeKitModal() {
            document.getElementById("kitModal").classList.add("hidden");
            document.getElementById("kitForm").reset();
        }

        // Save Kit
        function submitKitForm(e) {
            e.preventDefault();
            // Collect BOM parts from cards in the combined bomArea
            let partNos = Array.from(document.querySelectorAll("#bomArea .bom-card")).map(card => card.dataset.partNo);

            if (partNos.length === 0) {
                console.log("Please drag and drop parts to create the kit.");
                // You might want to show a user-friendly message here instead of just console.log
                return;
            }

            let kit = {
                kitNo: "KM" + Math.random().toString(36).substr(2, 6).toUpperCase(),
                date: new Date().toISOString().slice(0,10),
                prefix: "N",
                partNo: document.getElementById("kitPartNo").value,
                desc: document.getElementById("kitDesc").value,
                warehouse: document.getElementById("kitWarehouse").value,
                status: "Pending",
                parts: partNos
            };
            kits.unshift(kit);
            partNos.forEach(p => {
                let cmp = components.find(c => c.name === p);
                if (cmp) { cmp.stock = Math.max(0, cmp.stock - 1); cmp.kits.push(kit.kitNo); }
            });
            closeKitModal();
            renderKitTable();
            renderComponentTable();
            updateDashboard();
            renderCharts();
        }
        
        // Break Kit Modal
        function openBreakModal() {
            document.getElementById("breakModal").classList.remove("hidden");
            renderAvailableKitsForBreak(); // Render kits for drag and drop
            document.getElementById("breakKitDropZone").innerHTML = 'Drag a kit card here'; // Reset drop zone text
            document.getElementById("selectedKitDisplay").classList.add("hidden"); // Hide selected kit details
            selectedKitToBreak = null; // Clear selected kit
        }

        function closeBreakModal() {
            document.getElementById("breakModal").classList.add("hidden");
            document.getElementById("breakForm").reset();
        }

        // Render available kits for breaking (drag and drop)
        function renderAvailableKitsForBreak() {
            const availableKitsForBreak = document.getElementById('availableKitsForBreak');
            availableKitsForBreak.innerHTML = '';
            kits.filter(k => k.status !== "Broken").forEach(kit => { // Only show kits that are not already broken
                const card = document.createElement('div');
                card.className = "bg-white border rounded-lg shadow p-3 w-56 cursor-move";
                card.draggable = true;
                card.dataset.kit = JSON.stringify(kit);
                card.innerHTML = `
                    <div class="font-bold text-indigo-700">${kit.kitNo}</div>
                    <div class="text-xs text-gray-500 mb-1">${kit.desc}</div>
                    <div class="text-xs text-gray-500 mb-1">Status: ${kit.status}</div>
                    <div class="text-xs text-gray-500">Drag to break</div>
                `;
                card.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('application/json', card.dataset.kit);
                });
                availableKitsForBreak.appendChild(card);
            });
        }

        // Drag and drop for Break Kit Drop Zone
        const breakKitDropZone = document.getElementById('breakKitDropZone');
        breakKitDropZone.addEventListener('dragover', function(e) {
            e.preventDefault();
            breakKitDropZone.classList.add('bg-indigo-100');
            breakKitDropZone.textContent = 'Drop kit here';
        });
        breakKitDropZone.addEventListener('dragleave', function() {
            breakKitDropZone.classList.remove('bg-indigo-100');
            breakKitDropZone.textContent = 'Drag a kit card here';
        });
        breakKitDropZone.addEventListener('drop', function(e) {
            e.preventDefault();
            breakKitDropZone.classList.remove('bg-indigo-100');
            try {
                const droppedKit = JSON.parse(e.dataTransfer.getData('application/json'));
                selectedKitToBreak = droppedKit; // Store the selected kit globally
                displayKitForBreakdown(droppedKit);
            } catch (error) {
                console.error("Error parsing dropped kit data:", error);
                breakKitDropZone.textContent = 'Error dropping kit. Try again.';
            }
        });

        // Display selected kit details and parts for breakdown
        function displayKitForBreakdown(kit) {
            document.getElementById("selectedKitDisplay").classList.remove("hidden");
            document.getElementById("selectedKitName").textContent = `${kit.kitNo} - ${kit.desc}`;
            
            let partDiv = document.getElementById("breakPartSelect");
            partDiv.innerHTML = "";
            if (kit && kit.parts) {
                kit.parts.forEach(p => {
                    let label = document.createElement("label");
                    label.className = "flex items-center gap-1";
                    label.innerHTML = `<input type="checkbox" value="${p}" class="mr-1" checked/>${p}`;
                    partDiv.appendChild(label);
                });
            }
            breakKitDropZone.textContent = `Kit selected: ${kit.kitNo}`; // Update drop zone text
        }

        function submitBreakForm(e) {
            e.preventDefault();
            if (!selectedKitToBreak) {
                console.log("Please drag and drop a kit to break down.");
                return;
            }

            let kitNoToBreak = selectedKitToBreak.kitNo;
            let kitIndex = kits.findIndex(k => k.kitNo === kitNoToBreak);

            if (kitIndex !== -1) {
                let kit = kits[kitIndex];
                let partsToReturn = Array.from(document.querySelectorAll("#breakPartSelect input:checked")).map(cb => cb.value);
                
                kit.status = "Broken"; // Update kit status
                partsToReturn.forEach(p => {
                    let cmp = components.find(c => c.name === p);
                    if (cmp) cmp.stock += 1; // Increment stock for returned parts
                });
                
                // Remove the broken kit from the available kits for breaking list (optional, but logical)
                // kits = kits.filter(k => k.kitNo !== kitNoToBreak); // If you want to remove it entirely
            } else {
                console.log(`Kit with ID ${kitNoToBreak} not found.`);
            }

            closeBreakModal();
            renderKitTable();
            renderComponentTable();
            updateDashboard();
            renderCharts();
        }
        
        // This function is no longer needed as we use drag and drop for breaking
        function breakKit(kitNo) {
            openBreakModal();
            // Instead of setting select value, we'd programmatically drop the kit if needed
            // For now, the user will drag it manually
        }

        // --- Component Inventory Functions ---

        // Open Edit Component Modal
        function openEditComponentModal(componentName) {
            const component = components.find(c => c.name === componentName);
            if (component) {
                document.getElementById('editComponentNameOriginal').value = component.name;
                document.getElementById('editComponentName').value = component.name;
                document.getElementById('editComponentLocation').value = component.location;
                document.getElementById('editComponentMinStock').value = component.minStock;
                document.getElementById('editComponentModal').classList.remove('hidden');
            }
        }

        // Close Edit Component Modal
        function closeEditComponentModal() {
            document.getElementById('editComponentModal').classList.add('hidden');
            document.getElementById('editComponentForm').reset();
        }

        // Submit Edit Component Form
        function submitEditComponentForm(e) {
            e.preventDefault();
            const originalName = document.getElementById('editComponentNameOriginal').value;
            const newName = document.getElementById('editComponentName').value;
            const newLocation = document.getElementById('editComponentLocation').value;
            const newMinStock = parseInt(document.getElementById('editComponentMinStock').value);

            const componentIndex = components.findIndex(c => c.name === originalName);
            if (componentIndex !== -1) {
                components[componentIndex].name = newName;
                components[componentIndex].location = newLocation;
                components[componentIndex].minStock = newMinStock;
            }

            closeEditComponentModal();
            renderComponentTable();
            updateDashboard();
        }

        // Open Adjust Stock Modal
        function openAdjustStockModal(componentName) {
            const component = components.find(c => c.name === componentName);
            if (component) {
                document.getElementById('adjustStockComponentName').value = component.name;
                document.getElementById('adjustStockComponentDisplay').value = component.name;
                document.getElementById('adjustStockCurrentStock').value = component.stock;
                document.getElementById('adjustStockQuantity').value = 0; // Reset quantity
                document.getElementById('adjustStockModal').classList.remove('hidden');
            }
        }

        // Close Adjust Stock Modal
        function closeAdjustStockModal() {
            document.getElementById('adjustStockModal').classList.add('hidden');
            document.getElementById('adjustStockForm').reset();
        }

        // Submit Adjust Stock Form
        function submitAdjustStockForm(e) {
            e.preventDefault();
            const componentName = document.getElementById('adjustStockComponentName').value;
            const adjustment = parseInt(document.getElementById('adjustStockQuantity').value);

            const component = components.find(c => c.name === componentName);
            if (component) {
                component.stock += adjustment;
                if (component.stock < 0) component.stock = 0; // Prevent negative stock
            }

            closeAdjustStockModal();
            renderComponentTable();
            updateDashboard();
        }

        // --- Reports & Analytics Functions ---
        function showReport(reportType) {
            const reportContentDiv = document.getElementById('reportContent');
            const reportsChartCanvas = document.getElementById('reportsChart');
            reportsChartCanvas.classList.add('hidden'); // Hide chart by default

            let content = '';
            switch(reportType) {
                case 'sales':
                    content = `
                        <h4 class="font-bold mb-2">Kit Sales Performance (Dummy Data)</h4>
                        <p>Total Sales: $15,000</p>
                        <p>Top Selling Kit: BLOWER CASING (50 units)</p>
                        <p>Least Selling Kit: FILTER, WATER (5 units)</p>
                        <p class="text-sm text-gray-500 mt-2">Detailed sales data would be displayed here, potentially with filters for date range, kit categories, etc.</p>
                    `;
                    break;
                case 'valuation':
                    content = `
                        <h4 class="font-bold mb-2">Inventory Valuation (Dummy Data)</h4>
                        <p>Total Kit Inventory Value: $25,000</p>
                        <p>Total Component Inventory Value: $10,000</p>
                        <p class="text-sm text-gray-500 mt-2">This report would show the monetary value of all kits and individual components in stock.</p>
                    `;
                    break;
                case 'history':
                    content = `
                        <h4 class="font-bold mb-2">Kit Activity History (Dummy Data)</h4>
                        <ul class="list-disc list-inside">
                            <li>2025-05-29: Kit KMABC123 created (BLOWER CASING)</li>
                            <li>2025-05-28: Kit KMDEF456 broken down (FILTER-WATER)</li>
                            <li>2025-05-27: Kit KMGHI789 created (ANCRAGE)</li>
                        </ul>
                        <p class="text-sm text-gray-500 mt-2">A chronological log of all kit creation and breaking events.</p>
                    `;
                    break;
                case 'usage':
                    content = `
                        <h4 class="font-bold mb-2">Component Usage (Dummy Data)</h4>
                        <p>Most Used Component: Bolt (used in 3 kits)</p>
                        <p>Least Used Component: Gasket (used in 1 kit)</p>
                        <p class="text-sm text-gray-500 mt-2">Insights into which individual components are consumed most frequently in kit assembly.</p>
                    `;
                    break;
                default:
                    content = 'Select a report to view its content.';
            }
            reportContentDiv.innerHTML = content;
            // You can choose to show a chart for specific reports if needed
            // For example, if reportType === 'sales', you might call renderReportsChart() and make the canvas visible
            if (reportType === 'sales' || reportType === 'valuation') { // Example: show chart for sales/valuation
                reportsChartCanvas.classList.remove('hidden');
                renderReportsChart(); // Re-render the chart with relevant data if applicable
            }
        }


        // --- Settings Functions ---

        // Open Appearance Settings Modal
        function openAppearanceSettingsModal() {
            document.getElementById('appearanceSettingsModal').classList.remove('hidden');
            // Set radio button based on current theme
            if (document.body.classList.contains('dark-mode')) {
                document.querySelector('input[name="theme"][value="dark"]').checked = true;
            } else {
                document.querySelector('input[name="theme"][value="light"]').checked = true;
            }
        }

        // Close Appearance Settings Modal
        function closeAppearanceSettingsModal() {
            document.getElementById('appearanceSettingsModal').classList.add('hidden');
        }

        // Toggle Dark/Light Mode
        function toggleDarkMode(isDark) {
            if (isDark) {
                document.body.classList.add('dark-mode');
            } else {
                document.body.classList.remove('dark-mode');
            }
        }

        // Open Language Settings Modal
        function openLanguageSettingsModal() {
            document.getElementById('languageSettingsModal').classList.remove('hidden');
            // You would typically load the current language here
            document.getElementById('languageSelect').value = 'en'; // Default to English for now
        }

        // Close Language Settings Modal
        function closeLanguageSettingsModal() {
            document.getElementById('languageSettingsModal').classList.add('hidden');
        }

        // Change Language (Dummy Function)
        function changeLanguage(lang) {
            console.log(`Language changed to: ${lang}`);
            // In a real application, this would trigger a re-render with translated text
            // For now, it's a console log.
        }

        // New functions for sidebar
        function openSettingsSidebar() {
            document.getElementById('settingsSidebar').classList.remove('translate-x-full');
            document.getElementById('settingsSidebar').classList.add('translate-x-0');
            document.getElementById('sidebarOverlay').classList.remove('hidden');
        }

        function closeSettingsSidebar() {
            document.getElementById('settingsSidebar').classList.remove('translate-x-0');
            document.getElementById('settingsSidebar').classList.add('translate-x-full');
            document.getElementById('sidebarOverlay').classList.add('hidden');
        }


        // Charts
        let kitTrendChart, popularKitsChart, reportsChart;
        function renderCharts() {
            // Kit Activity Trend
            let months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
            let created = Array(12).fill(0), broken = Array(12).fill(0);

            // Add some dummy spikes for demonstration
            // You can adjust these values as needed for a better visual
            created[0] = 2;   // Jan
            created[1] = 1;   // Feb
            created[3] = 3;   // Apr
            created[6] = 2;   // Jul
            created[10] = 4;  // Nov

            // Also add real data from kits
            kits.forEach(k => {
                let m = new Date(k.date).getMonth();
                if (k.status === "Completed") created[m]++;
                if (k.status === "Broken") broken[m]++;
            });

            if (kitTrendChart) kitTrendChart.destroy();
            kitTrendChart = new Chart(document.getElementById("kitTrendChart"), {
                type: "line",
                data: {
                    labels: months,
                    datasets: [
                        { label: "Created", data: created, borderColor: "#2563eb", backgroundColor: "#93c5fd", fill: true },
                        { label: "Broken", data: broken, borderColor: "#dc2626", backgroundColor: "#fecaca", fill: true }
                    ]
                },
                options: { responsive: true, plugins: { legend: { display: true } }, scales: { y: { beginAtZero: true } } }
            });

            // Popular Kits
            let kitCounts = kits.map(k => ({ name: k.desc, count: k.parts.length }));
            kitCounts.sort((a, b) => b.count - a.count);
            let top5 = kitCounts.slice(0, 5);
            if (popularKitsChart) popularKitsChart.destroy();
            popularKitsChart = new Chart(document.getElementById("popularKitsChart"), {
                type: "bar",
                data: {
                    labels: top5.map(k => k.name),
                    datasets: [{ label: "Parts in Kit", data: top5.map(k => k.count), backgroundColor: "#f59e42" }]
                },
                options: { responsive: true, plugins: { legend: { display: false } }, indexAxis: 'y' }
            });
        }

        function renderReportsChart() {
            if (reportsChart) reportsChart.destroy();
            reportsChart = new Chart(document.getElementById("reportsChart"), {
                type: "doughnut",
                data: {
                    labels: ["Sales", "Inventory Value", "Creations", "Breakings"],
                    datasets: [{
                        data: [120, 80, kits.filter(k=>k.status==="Completed").length, kits.filter(k=>k.status==="Broken").length],
                        backgroundColor: ["#2563eb", "#f59e42", "#22c55e", "#dc2626"]
                    }]
                },
                options: { responsive: true, plugins: { legend: { position: "bottom" } } }
            });
        }

        // Initial Render
        updateDashboard();
        renderKitTable();
        renderComponentTable();
        renderCharts();
        renderReportsChart(); // Ensure this is called to initialize the report chart if needed
        showReport('sales'); // Show a default report on load
    </script>
</body>
</html>
