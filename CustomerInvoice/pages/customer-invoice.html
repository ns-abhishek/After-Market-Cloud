<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer Invoice - Invoice Management</title>

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Material Design CSS -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/material-components-web/14.0.0/material-components-web.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="../assets/css/main.css">
    <link rel="stylesheet" href="../assets/css/themes.css">
    <link rel="stylesheet" href="../assets/css/tables.css">
    <link rel="stylesheet" href="../assets/css/material-tables.css">
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="../index.html">
                <i class="fas fa-file-invoice-dollar me-2"></i>
                Invoice Management
            </a>

            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="../index.html">
                            <i class="fas fa-home me-1"></i>Home
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="dashboard.html">
                            <i class="fas fa-chart-pie me-1"></i>Dashboard
                        </a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-plus me-1"></i>Add New
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" onclick="openAddModal('customer')">Customer Invoice</a></li>
                            <li><a class="dropdown-item" href="#" onclick="openAddModal('service-return')">Service Return</a></li>
                            <li><a class="dropdown-item" href="#" onclick="openAddModal('internal')">Internal Invoice</a></li>
                            <li><a class="dropdown-item" href="#" onclick="openAddModal('internal-return')">Internal Return</a></li>
                        </ul>
                    </li>

                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="openAdvancedSearch()">
                            <i class="fas fa-search me-1"></i>Advanced Search
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="openAdvancedFilter()">
                            <i class="fas fa-filter me-1"></i>Advanced Filter
                        </a>
                    </li>
                </ul>

                <ul class="navbar-nav">
                    <li class="nav-item">
                        <button class="btn btn-link nav-link theme-toggle" onclick="toggleTheme()" title="Toggle theme">
                            <i class="fas fa-moon" id="themeIcon"></i>
                        </button>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-globe me-1"></i>Language
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" onclick="setLanguage('en')">English</a></li>
                            <li><a class="dropdown-item" href="#" onclick="setLanguage('es')">Español</a></li>
                            <li><a class="dropdown-item" href="#" onclick="setLanguage('fr')">Français</a></li>
                        </ul>
                    </li>

                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container-fluid">


            <!-- Page Header -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="page-header">
                        <h1 class="display-6 mb-3">
                            <i class="fas fa-user-tie me-3"></i>
                            <span data-translate="customer_invoice">Customer Invoice</span>
                        </h1>
                        <p class="lead" data-translate="customer_invoice_desc">Manage customer invoices and payments</p>
                    </div>
                </div>
            </div>





            <!-- Standardized Table Component -->
            <div class="row">
                <div class="col-12">
                    <div id="customerInvoiceTableContainer">
                        <!-- Table will be rendered here by the component -->
                    </div>
                </div>
            </div>

            <!-- Table Info -->
            <div class="row mt-3">
                <div class="col-md-6">
                    <div class="table-info">
                        <span id="tableInfo">Showing 0 to 0 of 0 entries</span>
                    </div>
                </div>
                <div class="col-md-6">
                    <nav aria-label="Table pagination">
                        <ul class="pagination justify-content-end" id="tablePagination">
                            <!-- Pagination will be generated here -->
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </main>

    <!-- Detail View Modal -->
    <div class="modal fade" id="detailModal" tabindex="-1" aria-labelledby="detailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="detailModalLabel">Invoice Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="detailModalBody">
                    <!-- Details will be loaded here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-outline-success" onclick="exportModalData('pdf')">
                        <i class="fas fa-file-pdf me-1"></i>Export PDF
                    </button>
                    <button type="button" class="btn btn-outline-success" onclick="exportModalData('excel')">
                        <i class="fas fa-file-excel me-1"></i>Export Excel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals and Components will be loaded here -->
    <div id="modal-container"></div>

    <!-- Toast Container -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3" id="toast-container"></div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay d-none">
        <div class="loading-spinner">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3">Loading...</p>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/material-components-web/14.0.0/material-components-web.min.js"></script>

    <script src="../assets/js/main.js"></script>
    <script src="../assets/js/navigation.js"></script>
    <script src="../assets/js/themes.js"></script>
    <script src="../assets/js/language.js"></script>
    <script src="../assets/js/export-utils.js"></script>
    <script src="../assets/js/table-component.js"></script>
    <script src="../assets/js/table-manager.js"></script>

    <script>
        // Page-specific initialization
        document.addEventListener('DOMContentLoaded', function() {
            initializeCustomerInvoicePage();
            initializeMaterialComponents();
        });

        function initializeCustomerInvoicePage() {
            // Initialize the standardized table component
            const tableConfig = {
                title: 'Customer Invoice Management',
                columns: [
                    { key: 'id', label: 'Invoice ID', sortable: true },
                    { key: 'customerName', label: 'Customer Name', sortable: true },
                    { key: 'paymentMode', label: 'Payment Mode', sortable: true, format: (value) => `<span class="badge bg-dark text-white">${value}</span>` },
                    { key: 'date', label: 'Date', sortable: true, format: (value) => formatDate(value) },
                    { key: 'workOrder', label: 'Work Order', sortable: true },
                    { key: 'workOrderDate', label: 'Work Order Date', sortable: true, format: (value) => formatDate(value) },
                    { key: 'serial', label: 'Serial', sortable: true },
                    { key: 'model', label: 'Model', sortable: true },
                    { key: 'draftAmount', label: 'Draft Amount', sortable: true, format: (value) => `$${parseFloat(value).toFixed(2)}` },
                    { key: 'taxAmount', label: 'Tax Amount', sortable: true, format: (value) => `$${parseFloat(value).toFixed(2)}` },
                    { key: 'invoiceAmount', label: 'Invoice Amount', sortable: true, format: (value) => `<strong>$${parseFloat(value).toFixed(2)}</strong>` },
                    { key: 'sapStatus', label: 'SAP Status', sortable: true, format: (value) => `<span class="badge bg-light text-dark border border-dark">${value}</span>` }
                ],
                data: generateCustomerInvoiceData(),
                actions: ['view'],
                exportable: true,
                cardViewEnabled: true,
                defaultView: 'card', // Set card view as default
                searchable: true,
                filterable: true,
                pagination: true,
                pageSize: 25,
                onView: (row) => viewInvoiceDetail(row.id)
            };

            // Create the table
            window.customerInvoiceTable = createInvoiceTable('customerInvoiceTableContainer', tableConfig);
        }

        function initializeMaterialComponents() {
            // Initialize Material Design components
            if (typeof mdc !== 'undefined') {
                // Initialize data table
                const dataTable = document.querySelector('.mdc-data-table');
                if (dataTable) {
                    new mdc.dataTable.MDCDataTable(dataTable);
                }

                // Initialize icon buttons
                const iconButtons = document.querySelectorAll('.mdc-icon-button');
                iconButtons.forEach(button => {
                    new mdc.iconButton.MDCIconButtonToggle(button);
                });

                // Initialize chips
                const chips = document.querySelectorAll('.mdc-chip');
                chips.forEach(chip => {
                    new mdc.chips.MDCChip(chip);
                });
            }

            // Initialize column search functionality
            initializeColumnSearch();
        }

        // Detail modal functionality
        function openDetailModal(invoiceData) {
            const modal = new bootstrap.Modal(document.getElementById('detailModal'));
            const modalBody = document.getElementById('detailModalBody');

            modalBody.innerHTML = createDetailView(invoiceData);
            modal.show();
        }

        function createDetailView(data) {
            return `
                <div class="container-fluid">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="detail-section">
                                <h6 class="detail-section-title">Invoice Information</h6>
                                <div class="detail-item">
                                    <label>Customer Invoice:</label>
                                    <span>${data.customerInvoice}</span>
                                </div>
                                <div class="detail-item">
                                    <label>Customer Name:</label>
                                    <span>${data.customerName}</span>
                                </div>
                                <div class="detail-item">
                                    <label>Payment Mode:</label>
                                    <span>${data.paymentMode}</span>
                                </div>
                                <div class="detail-item">
                                    <label>Date:</label>
                                    <span>${data.date}</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="detail-section">
                                <h6 class="detail-section-title">Work Order Details</h6>
                                <div class="detail-item">
                                    <label>Work Order:</label>
                                    <span>${data.workOrder}</span>
                                </div>
                                <div class="detail-item">
                                    <label>Work Order Date:</label>
                                    <span>${data.workOrderDate}</span>
                                </div>
                                <div class="detail-item">
                                    <label>Serial:</label>
                                    <span>${data.serial}</span>
                                </div>
                                <div class="detail-item">
                                    <label>Model:</label>
                                    <span>${data.model}</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="detail-section">
                                <h6 class="detail-section-title">Financial Information</h6>
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <div class="detail-item">
                                            <label>Draft Invoice Amount:</label>
                                            <span class="text-info">${data.draftAmount}</span>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="detail-item">
                                            <label>Tax Amount:</label>
                                            <span class="text-warning">${data.taxAmount}</span>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="detail-item">
                                            <label>Total Invoice Amount:</label>
                                            <span class="text-success fw-bold">${data.invoiceAmount}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="detail-section">
                                <h6 class="detail-section-title">Status Information</h6>
                                <div class="detail-item">
                                    <label>SAP Status:</label>
                                    <span class="badge ${getSAPStatusClass(data.sapStatus)}">${data.sapStatus}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }





        // Export functions for modal
        function exportModalData(format) {
            const modalBody = document.getElementById('detailModalBody');
            const modalTitle = document.getElementById('detailModalLabel').textContent;

            if (format === 'pdf') {
                exportModalToPDF(modalBody, modalTitle);
            } else if (format === 'excel') {
                exportModalToExcel(modalBody, modalTitle);
            }
        }

        function exportModalToPDF(modalBody, title) {
            // Create a new window for PDF generation
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                    <head>
                        <title>${title}</title>
                        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
                        <style>
                            body {
                                font-family: Arial, sans-serif;
                                margin: 20px;
                                color: #000000;
                            }
                            .detail-section {
                                margin-bottom: 1.5rem;
                                border: 2px solid #000000;
                                padding: 1rem;
                            }
                            .detail-section-title {
                                border-bottom: 2px solid #000000;
                                padding-bottom: 0.5rem;
                                margin-bottom: 1rem;
                                font-weight: bold;
                                background-color: #000000;
                                color: #ffffff;
                                padding: 0.5rem;
                                margin: -1rem -1rem 1rem -1rem;
                            }
                            .detail-item {
                                display: flex;
                                justify-content: space-between;
                                margin-bottom: 0.5rem;
                                border-bottom: 1px solid #000000;
                                padding-bottom: 0.25rem;
                            }
                            .detail-item label {
                                font-weight: bold;
                                color: #000000;
                            }
                            .badge {
                                background-color: #000000 !important;
                                color: #ffffff !important;
                                border: 1px solid #000000;
                                padding: 0.25rem 0.5rem;
                            }
                            @media print {
                                body { margin: 0; }
                                .detail-section { break-inside: avoid; }
                            }
                            h2 {
                                text-align: center;
                                border: 3px solid #000000;
                                padding: 1rem;
                                background-color: #000000;
                                color: #ffffff;
                            }
                        </style>
                    </head>
                    <body>
                        <h2>${title}</h2>
                        ${modalBody.innerHTML}
                        <div style="margin-top: 2rem; text-align: center; border-top: 2px solid #000000; padding-top: 1rem;">
                            <small>Generated on ${new Date().toLocaleString()}</small>
                        </div>
                    </body>
                </html>
            `);
            printWindow.document.close();

            // Wait for content to load then print
            setTimeout(() => {
                printWindow.print();
                showToast('PDF export initiated', 'success');
            }, 500);
        }

        function exportModalToExcel(modalBody, title) {
            // Extract data from modal for Excel export
            const data = extractModalDataForExcel(modalBody);

            // Create CSV content (Excel-compatible)
            let csvContent = `${title}\n`;
            csvContent += `Generated on: ${new Date().toLocaleString()}\n\n`;

            data.forEach(section => {
                csvContent += `${section.title}\n`;
                section.items.forEach(item => {
                    csvContent += `"${item.label}","${item.value}"\n`;
                });
                csvContent += '\n';
            });

            // Create and download file
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `${title.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            showToast('Excel export completed', 'success');
        }

        function extractModalDataForExcel(modalBody) {
            const sections = [];
            const detailSections = modalBody.querySelectorAll('.detail-section');

            detailSections.forEach(section => {
                const title = section.querySelector('.detail-section-title')?.textContent || 'Section';
                const items = [];

                const detailItems = section.querySelectorAll('.detail-item');
                detailItems.forEach(item => {
                    const label = item.querySelector('label')?.textContent || '';
                    const value = item.querySelector('span')?.textContent || '';
                    items.push({ label: label.replace(':', ''), value: value });
                });

                sections.push({ title, items });
            });

            return sections;
        }
        function generateCustomerInvoiceData() {
            const data = [];
            const customers = ['John Doe', 'Jane Smith', 'Bob Johnson', 'Alice Brown', 'Charlie Wilson', 'Diana Prince', 'Bruce Wayne', 'Clark Kent'];
            const paymentModes = ['cash', 'card', 'bank', 'check'];
            const statuses = ['active', 'pending', 'completed', 'cancelled'];

            for (let i = 1; i <= 50; i++) {
                const baseAmount = Math.floor(Math.random() * 5000) + 500;
                const taxAmount = baseAmount * 0.1;
                const totalAmount = baseAmount + taxAmount;

                data.push({
                    id: `CI${String(i).padStart(4, '0')}`,
                    customerName: customers[Math.floor(Math.random() * customers.length)],
                    paymentMode: paymentModes[Math.floor(Math.random() * paymentModes.length)],
                    date: new Date(2024, Math.floor(Math.random() * 12), Math.floor(Math.random() * 28) + 1).toISOString().split('T')[0],
                    workOrder: `WO${String(i).padStart(4, '0')}`,
                    workOrderDate: new Date(2024, Math.floor(Math.random() * 12), Math.floor(Math.random() * 28) + 1).toISOString().split('T')[0],
                    serial: `SN${String(i).padStart(8, '0')}`,
                    model: `Model-${String.fromCharCode(65 + Math.floor(Math.random() * 26))}${i}`,
                    draftAmount: baseAmount,
                    taxAmount: taxAmount,
                    invoiceAmount: totalAmount,
                    sapStatus: statuses[Math.floor(Math.random() * statuses.length)]
                });
            }

            return data;
        }





        // Record operations
        function viewInvoiceDetail(invoiceId) {
            // Find the invoice data
            const data = generateCustomerInvoiceData();
            const invoice = data.find(item => item.id === invoiceId);

            if (invoice) {
                const invoiceData = {
                    customerInvoice: invoice.id,
                    customerName: invoice.customerName,
                    paymentMode: invoice.paymentMode,
                    date: formatDate(invoice.date),
                    workOrder: invoice.workOrder,
                    workOrderDate: formatDate(invoice.workOrderDate),
                    serial: invoice.serial,
                    model: invoice.model,
                    draftAmount: `$${invoice.draftAmount.toFixed(2)}`,
                    taxAmount: `$${invoice.taxAmount.toFixed(2)}`,
                    invoiceAmount: `$${invoice.invoiceAmount.toFixed(2)}`,
                    sapStatus: invoice.sapStatus
                };

                openDetailModal(invoiceData);
            } else {
                showToast('Invoice not found', 'error');
            }
        }

        function editRecord(invoiceId) {
            showToast(`Edit invoice ${invoiceId}`, 'info');
            // This will open edit modal
            console.log('Edit record:', invoiceId);
        }

        function deleteRecord(invoiceId) {
            if (confirm(`Are you sure you want to delete invoice ${invoiceId}?`)) {
                showToast(`Invoice ${invoiceId} deleted`, 'success');
                // This will delete the record
                console.log('Delete record:', invoiceId);
            }
        }

        function sendMail(invoiceId) {
            showToast(`Sending email for invoice ${invoiceId}`, 'info');
            // This will send email
            console.log('Send mail for:', invoiceId);
        }

        // Utility functions
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: '2-digit'
            });
        }

        function getSAPStatusClass(status) {
            const statusClasses = {
                'active': 'bg-success',
                'pending': 'bg-warning',
                'completed': 'bg-primary',
                'cancelled': 'bg-danger'
            };
            return statusClasses[status.toLowerCase()] || 'bg-secondary';
        }

        function initializeColumnSearch() {
            // Column search functionality removed as requested
            console.log('Column search functionality disabled');
        }


    </script>
</body>
</html>
