<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* Lighter blue-gray background */
        }
        .container {
            background-color: #ffffff;
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* shadow-lg */
        }
        .note-card {
            background-color: #ffffff;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border: 1px solid #e5e7eb;
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .note-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .debit-note-card {
            border-left: 4px solid #4f46e5; /* Indigo 600 */
        }
        .credit-note-card {
            border-left: 4px solid #10b981; /* Emerald 500 */
        }
        .summary-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 1rem;
            padding: 2rem;
            text-align: center;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center p-4 sm:p-6 bg-gray-50">



    <div class="container mx-auto p-6 sm:p-8 max-w-7xl w-full">
        <h1 class="text-3xl sm:text-4xl font-bold text-gray-800 mb-8 text-center">Credit & Debit Notes Dashboard</h1>

        <!-- Original Summary Cards -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="summary-card">
                <h3 class="text-lg font-semibold mb-2">Total Debit Notes</h3>
                <p class="text-sm opacity-80 mb-1">(Money Received)</p>
                <p id="total-debit-amount" class="text-3xl font-bold">$0.00</p>
            </div>
            <div class="summary-card">
                <h3 class="text-lg font-semibold mb-2">Total Credit Notes</h3>
                <p class="text-sm opacity-80 mb-1">(Money Paid)</p>
                <p id="total-credit-amount" class="text-3xl font-bold">$0.00</p>
            </div>
            <div class="summary-card">
                <h3 class="text-lg font-semibold mb-2">Net Amount</h3>
                <p class="text-sm opacity-80 mb-1">(Received - Paid)</p>
                <p id="net-amount" class="text-3xl font-bold">$0.00</p>
            </div>
        </div>

        <!-- Time-based Summary Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6 mb-8">
            <!-- Today -->
            <div class="summary-card">
                <h3 class="text-lg font-semibold mb-3">Today</h3>
                <div class="space-y-2">
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-indigo-200">Debit Notes:</span>
                        <span id="today-debit-count" class="text-xl font-bold">0</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-emerald-200">Credit Notes:</span>
                        <span id="today-credit-count" class="text-xl font-bold">0</span>
                    </div>
                </div>
            </div>

            <!-- Weekly Created Notes -->
            <div class="summary-card">
                <h3 class="text-lg font-semibold mb-3">Week</h3>
                <div class="space-y-2">
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-indigo-200">Debit Notes:</span>
                        <span id="week-debit-count" class="text-xl font-bold">0</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-emerald-200">Credit Notes:</span>
                        <span id="week-credit-count" class="text-xl font-bold">0</span>
                    </div>
                </div>
            </div>

            <!-- Monthly Created Notes -->
            <div class="summary-card">
                <h3 class="text-lg font-semibold mb-3">MTD</h3>
                <div class="space-y-2">
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-indigo-200">Debit Notes:</span>
                        <span id="month-debit-count" class="text-xl font-bold">0</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-emerald-200">Credit Notes:</span>
                        <span id="month-credit-count" class="text-xl font-bold">0</span>
                    </div>
                </div>
            </div>

            <!-- Yearly Created Notes -->
            <div class="summary-card">
                <h3 class="text-lg font-semibold mb-3">Year</h3>
                <div class="space-y-2">
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-indigo-200">Debit Notes:</span>
                        <span id="year-debit-count" class="text-xl font-bold">0</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-emerald-200">Credit Notes:</span>
                        <span id="year-credit-count" class="text-xl font-bold">0</span>
                    </div>
                </div>
            </div>

            <!-- Total Created Notes -->
            <div class="summary-card">
                <h3 class="text-lg font-semibold mb-3">Total</h3>
                <div class="space-y-2">
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-indigo-200">Debit Notes:</span>
                        <span id="total-debit-count" class="text-xl font-bold">0</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-emerald-200">Credit Notes:</span>
                        <span id="total-credit-count" class="text-xl font-bold">0</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Created Notes Section -->
        <div class="mb-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">Created Notes Overview</h2>

            <!-- Debit Notes Table -->
            <div class="mb-8">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-semibold text-gray-700 flex items-center">
                        <span class="w-3 h-3 bg-indigo-600 rounded-full mr-2"></span>
                        Debit Notes (Money Received)
                    </h3>
                    <div class="flex items-center space-x-4">
                        <span id="debit-notes-count-badge" class="bg-indigo-100 text-indigo-800 text-sm font-medium px-3 py-1 rounded-full">
                            0 Notes
                        </span>
                        <button id="export-debit-notes" class="text-indigo-600 hover:text-indigo-800" title="Export Debit Notes">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                        </button>
                        <button id="import-debit-notes" class="text-indigo-600 hover:text-indigo-800" title="Import Debit Notes">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"></path>
                            </svg>
                        </button>
                        <button id="refresh-debit-notes" class="text-gray-500 hover:text-gray-700" title="Refresh">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                            </svg>
                        </button>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">View</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Debit Note #</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Document Type</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Customer Name</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Debit Note Amount</th>
                                </tr>
                            </thead>
                            <tbody id="debit-notes-table-body" class="bg-white divide-y divide-gray-200">
                                <tr id="no-debit-notes-row">
                                    <td colspan="6" class="px-6 py-8 text-center text-gray-500">
                                        <div class="flex flex-col items-center">
                                            <svg class="h-12 w-12 text-gray-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                            </svg>
                                            <p class="text-sm">No debit notes created yet</p>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Credit Notes Table -->
            <div class="mb-8">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-semibold text-gray-700 flex items-center">
                        <span class="w-3 h-3 bg-emerald-500 rounded-full mr-2"></span>
                        Credit Notes (Money Paid)
                    </h3>
                    <div class="flex items-center space-x-4">
                        <span id="credit-notes-count-badge" class="bg-emerald-100 text-emerald-800 text-sm font-medium px-3 py-1 rounded-full">
                            0 Notes
                        </span>
                        <button id="export-credit-notes" class="text-emerald-600 hover:text-emerald-800" title="Export Credit Notes">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                        </button>
                        <button id="import-credit-notes" class="text-emerald-600 hover:text-emerald-800" title="Import Credit Notes">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"></path>
                            </svg>
                        </button>
                        <button id="refresh-credit-notes" class="text-gray-500 hover:text-gray-700" title="Refresh">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                            </svg>
                        </button>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">View</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Credit Note #</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Document Type</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Customer Name</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Credit Note Amount</th>
                                </tr>
                            </thead>
                            <tbody id="credit-notes-table-body" class="bg-white divide-y divide-gray-200">
                                <tr id="no-credit-notes-row">
                                    <td colspan="6" class="px-6 py-8 text-center text-gray-500">
                                        <div class="flex flex-col items-center">
                                            <svg class="h-12 w-12 text-gray-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                            </svg>
                                            <p class="text-sm">No credit notes created yet</p>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Party Ledger Section -->
        <div class="mb-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">Party Ledger</h2>
            <div id="party-ledger-container" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                <div id="no-party-ledger" class="col-span-full">
                    <div class="bg-gray-50 border-2 border-dashed border-gray-300 rounded-lg p-8 text-center">
                        <div class="text-gray-400 mb-2">
                            <svg class="mx-auto h-12 w-12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                            </svg>
                        </div>
                        <p class="text-gray-500 text-sm">No party ledger entries yet</p>
                        <p class="text-gray-400 text-xs mt-1">Create debit/credit notes to see customer-wise summaries</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="text-center mt-10 space-y-4">
            <div class="flex flex-col sm:flex-row gap-4 justify-center items-center">
                <a href="CreditDebitUI.html" class="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-300 ease-in-out transform hover:scale-105">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                    </svg>
                    Go to Transaction Management
                </a>
                <button id="party-ledger-btn" class="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-emerald-600 hover:bg-emerald-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-emerald-500 transition duration-300 ease-in-out transform hover:scale-105">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                    </svg>
                    View Party Ledger Details
                </button>
            </div>
        </div>
    </div>

    <!-- Hidden file inputs for import functionality -->
    <input type="file" id="debit-notes-file-input" accept=".csv,.json" style="display: none;">
    <input type="file" id="credit-notes-file-input" accept=".csv,.json" style="display: none;">

    <script>
        /**
         * Formats a number as currency.
         * @param {number} amount - The amount to format.
         * @returns {string} The formatted currency string.
         */
        function formatCurrency(amount) {
            return `$${amount.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        }

        /**
         * Loads saved notes from localStorage and displays them on the dashboard
         */
        function loadAndDisplayNotes() {
            const savedData = localStorage.getItem('creditDebitNotes');

            if (!savedData) {
                console.log('No saved notes found in localStorage');
                return;
            }

            try {
                const notesData = JSON.parse(savedData);
                console.log('Loaded notes data:', notesData);

                displayDebitNotes(notesData.debitNotes || {});
                displayCreditNotes(notesData.creditNotes || {});
                updateSummary(notesData.debitNotes || {}, notesData.creditNotes || {}, notesData.timestamp);
                loadAndDisplayPartyLedger();
            } catch (error) {
                console.error('Error parsing saved notes data:', error);
            }
        }

        /**
         * Loads and displays party ledger data
         */
        function loadAndDisplayPartyLedger() {
            const savedPartyLedger = localStorage.getItem('partyLedger');

            if (!savedPartyLedger) {
                console.log('No party ledger data found');
                return;
            }

            try {
                const partyLedgerData = JSON.parse(savedPartyLedger);
                displayPartyLedger(partyLedgerData);
            } catch (error) {
                console.error('Error parsing party ledger data:', error);
            }
        }

        /**
         * Displays debit notes on the dashboard in table format
         * @param {object} debitNotes - Object containing debit notes data
         */
        function displayDebitNotes(debitNotes) {
            const tableBody = document.getElementById('debit-notes-table-body');
            const noNotesRow = document.getElementById('no-debit-notes-row');
            const countBadge = document.getElementById('debit-notes-count-badge');

            const noteIds = Object.keys(debitNotes);

            if (noteIds.length === 0) {
                noNotesRow.style.display = 'table-row';
                countBadge.textContent = '0 Notes';
                return;
            }

            noNotesRow.style.display = 'none';
            countBadge.textContent = `${noteIds.length} Note${noteIds.length > 1 ? 's' : ''}`;

            // Clear existing content except the no-notes row
            tableBody.innerHTML = '';
            tableBody.appendChild(noNotesRow);

            noteIds.forEach(noteId => {
                const noteData = debitNotes[noteId];
                const noteRow = createDebitNoteTableRow(noteId, noteData);
                tableBody.appendChild(noteRow);
            });
        }

        /**
         * Displays credit notes on the dashboard in table format
         * @param {object} creditNotes - Object containing credit notes data
         */
        function displayCreditNotes(creditNotes) {
            const tableBody = document.getElementById('credit-notes-table-body');
            const noNotesRow = document.getElementById('no-credit-notes-row');
            const countBadge = document.getElementById('credit-notes-count-badge');

            const noteIds = Object.keys(creditNotes);

            if (noteIds.length === 0) {
                noNotesRow.style.display = 'table-row';
                countBadge.textContent = '0 Notes';
                return;
            }

            noNotesRow.style.display = 'none';
            countBadge.textContent = `${noteIds.length} Note${noteIds.length > 1 ? 's' : ''}`;

            // Clear existing content except the no-notes row
            tableBody.innerHTML = '';
            tableBody.appendChild(noNotesRow);

            noteIds.forEach(noteId => {
                const noteData = creditNotes[noteId];
                const noteRow = createCreditNoteTableRow(noteId, noteData);
                tableBody.appendChild(noteRow);
            });
        }

        /**
         * Extracts document type from transaction status or description
         * @param {object} transaction - Transaction object
         * @returns {string} The document type
         */
        function extractDocumentType(transaction) {
            if (!transaction) return 'General';

            const status = transaction.status || '';
            const description = transaction.description || '';

            // Check status first for document type patterns
            if (status.toLowerCase().includes('warranty')) return 'Warranty Claim';
            if (status.toLowerCase().includes('mandatory')) return 'Mandatory';
            if (status.toLowerCase().includes('gdr')) return 'GDR Settlement';
            if (status.toLowerCase().includes('sales invoice')) return 'Sales Invoice';
            if (status.toLowerCase().includes('purchase invoice')) return 'Purchase Invoice';

            // Check description as fallback
            if (description.toLowerCase().includes('warranty')) return 'Warranty Claim';
            if (description.toLowerCase().includes('mandatory')) return 'Mandatory';
            if (description.toLowerCase().includes('gdr')) return 'GDR Settlement';
            if (description.toLowerCase().includes('sales invoice')) return 'Sales Invoice';
            if (description.toLowerCase().includes('purchase invoice')) return 'Purchase Invoice';

            return 'General';
        }

        /**
         * Creates a debit note table row element
         * @param {string} noteId - The note ID
         * @param {object} noteData - The note data
         * @returns {HTMLElement} The table row element
         */
        function createDebitNoteTableRow(noteId, noteData) {
            const row = document.createElement('tr');
            row.className = 'hover:bg-gray-50';

            const totalAmount = noteData.totalAmount || 0;
            const customerName = noteData.transactions && noteData.transactions.length > 0 ?
                noteData.transactions[0].customerName || 'N/A' : 'N/A';

            // Extract document type from the first transaction
            const documentType = noteData.transactions && noteData.transactions.length > 0 ?
                extractDocumentType(noteData.transactions[0]) : 'General';

            const createdDate = noteData.createdAt ?
                new Date(noteData.createdAt).toLocaleDateString('en-GB') :
                new Date().toLocaleDateString('en-GB');

            row.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap">
                    <button class="text-indigo-600 hover:text-indigo-900" title="View Details">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                        </svg>
                    </button>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${noteId}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${createdDate}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${documentType}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${customerName}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-indigo-600">
                    ${formatCurrency(totalAmount)}
                </td>
            `;

            return row;
        }

        /**
         * Creates a credit note table row element
         * @param {string} noteId - The note ID
         * @param {object} noteData - The note data
         * @returns {HTMLElement} The table row element
         */
        function createCreditNoteTableRow(noteId, noteData) {
            const row = document.createElement('tr');
            row.className = 'hover:bg-gray-50';

            const totalAmount = noteData.totalAmount || 0;
            const customerName = noteData.transactions && noteData.transactions.length > 0 ?
                noteData.transactions[0].customerName || 'N/A' : 'N/A';

            // Extract document type from the first transaction
            const documentType = noteData.transactions && noteData.transactions.length > 0 ?
                extractDocumentType(noteData.transactions[0]) : 'General';

            const createdDate = noteData.createdAt ?
                new Date(noteData.createdAt).toLocaleDateString('en-GB') :
                new Date().toLocaleDateString('en-GB');

            row.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap">
                    <button class="text-emerald-600 hover:text-emerald-900" title="View Details">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                        </svg>
                    </button>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${noteId}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${createdDate}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${documentType}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${customerName}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-emerald-600">
                    ${formatCurrency(totalAmount)}
                </td>
            `;

            return row;
        }

        /**
         * Creates a note card element (legacy function for compatibility)
         * @param {string} noteId - The note ID
         * @param {object} noteData - The note data containing transactions and total
         * @param {string} type - 'debit' or 'credit'
         * @returns {HTMLElement} The created note card element
         */
        function createNoteCard(noteId, noteData, type) {
            return createGridNoteCard(noteId, noteData, type);
        }

        /**
         * Gets the start of today
         * @returns {Date} Start of today
         */
        function getStartOfToday() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            return today;
        }

        /**
         * Gets the start of current week (Monday)
         * @returns {Date} Start of current week
         */
        function getStartOfWeek() {
            const today = new Date();
            const day = today.getDay();
            const diff = today.getDate() - day + (day === 0 ? -6 : 1); // Adjust when day is Sunday
            const monday = new Date(today.setDate(diff));
            monday.setHours(0, 0, 0, 0);
            return monday;
        }

        /**
         * Gets the start of current month
         * @returns {Date} Start of current month
         */
        function getStartOfMonth() {
            const today = new Date();
            return new Date(today.getFullYear(), today.getMonth(), 1);
        }

        /**
         * Gets the start of current year
         * @returns {Date} Start of current year
         */
        function getStartOfYear() {
            const today = new Date();
            return new Date(today.getFullYear(), 0, 1);
        }

        /**
         * Checks if a timestamp falls within a date range
         * @param {string} timestamp - ISO timestamp string
         * @param {Date} startDate - Start date for comparison
         * @returns {boolean} True if timestamp is within range
         */
        function isWithinDateRange(timestamp, startDate) {
            const noteDate = new Date(timestamp);
            return noteDate >= startDate;
        }

        /**
         * Displays party ledger data
         * @param {object} partyLedgerData - Party ledger data
         */
        function displayPartyLedger(partyLedgerData) {
            const container = document.getElementById('party-ledger-container');
            const noPartyLedgerMessage = document.getElementById('no-party-ledger');

            const customerIds = Object.keys(partyLedgerData);

            if (customerIds.length === 0) {
                noPartyLedgerMessage.style.display = 'block';
                return;
            }

            noPartyLedgerMessage.style.display = 'none';

            // Clear existing content except the no-party-ledger message
            container.innerHTML = '';
            container.appendChild(noPartyLedgerMessage);

            customerIds.forEach(customerId => {
                const customerData = partyLedgerData[customerId];
                const partyCard = createPartyLedgerCard(customerId, customerData);
                container.appendChild(partyCard);
            });
        }

        /**
         * Creates a party ledger card
         * @param {string} customerId - Customer ID
         * @param {object} customerData - Customer data
         * @returns {HTMLElement} The created party card element
         */
        function createPartyLedgerCard(customerId, customerData) {
            const card = document.createElement('div');
            card.className = 'bg-white rounded-lg shadow-md border-l-4 border-blue-500 p-4 hover:shadow-lg transition-shadow duration-200 cursor-pointer';

            const netAmount = customerData.totalDebit - customerData.totalCredit;
            const netColor = netAmount >= 0 ? 'text-green-600' : 'text-red-600';
            const netLabel = netAmount >= 0 ? 'Net Receivable' : 'Net Payable';

            card.innerHTML = `
                <div class="flex items-start justify-between mb-3">
                    <div class="flex items-center">
                        <div class="bg-blue-50 p-2 rounded-lg mr-3">
                            <svg class="w-4 h-4 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                            </svg>
                        </div>
                        <div>
                            <h4 class="font-semibold text-gray-800 text-sm truncate" title="${customerData.customerName}">${customerData.customerName}</h4>
                            <p class="text-xs text-gray-500">Customer</p>
                        </div>
                    </div>
                </div>

                <div class="space-y-2 mb-3">
                    <div class="flex justify-between items-center">
                        <span class="text-xs text-gray-600">Debit Notes:</span>
                        <span class="text-sm font-medium text-indigo-600">${formatCurrency(customerData.totalDebit)}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-xs text-gray-600">Credit Notes:</span>
                        <span class="text-sm font-medium text-emerald-600">${formatCurrency(customerData.totalCredit)}</span>
                    </div>
                    <div class="border-t pt-2">
                        <div class="flex justify-between items-center">
                            <span class="text-xs font-medium text-gray-700">${netLabel}:</span>
                            <span class="text-sm font-bold ${netColor}">${formatCurrency(Math.abs(netAmount))}</span>
                        </div>
                    </div>
                </div>

                <div class="text-xs text-gray-500 flex justify-between">
                    <span>${customerData.debitNotes.length + customerData.creditNotes.length} transactions</span>
                    <span class="flex items-center">
                        <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                        </svg>
                        View Details
                    </span>
                </div>
            `;

            // Add click event to show customer details
            card.addEventListener('click', () => {
                showCustomerDetailsModal(customerId, customerData);
            });

            return card;
        }

        /**
         * Shows customer details modal
         * @param {string} customerId - Customer ID
         * @param {object} customerData - Customer data
         */
        function showCustomerDetailsModal(customerId, customerData) {
            // Create modal overlay
            const modalOverlay = document.createElement('div');
            modalOverlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';

            const netAmount = customerData.totalDebit - customerData.totalCredit;
            const netColor = netAmount >= 0 ? 'text-green-600' : 'text-red-600';
            const netLabel = netAmount >= 0 ? 'Net Receivable' : 'Net Payable';

            modalOverlay.innerHTML = `
                <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] overflow-hidden">
                    <div class="flex items-center justify-between p-6 border-b border-gray-200">
                        <h3 class="text-xl font-semibold text-gray-800">Party Ledger - ${customerData.customerName}</h3>
                        <button id="close-customer-modal" class="text-gray-400 hover:text-gray-600">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>

                    <div class="p-6 overflow-y-auto max-h-[calc(90vh-120px)]">
                        <!-- Summary -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                            <div class="bg-indigo-50 p-4 rounded-lg">
                                <h4 class="text-sm font-medium text-indigo-800">Total Debit</h4>
                                <p class="text-2xl font-bold text-indigo-600">${formatCurrency(customerData.totalDebit)}</p>
                            </div>
                            <div class="bg-emerald-50 p-4 rounded-lg">
                                <h4 class="text-sm font-medium text-emerald-800">Total Credit</h4>
                                <p class="text-2xl font-bold text-emerald-600">${formatCurrency(customerData.totalCredit)}</p>
                            </div>
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <h4 class="text-sm font-medium text-gray-800">${netLabel}</h4>
                                <p class="text-2xl font-bold ${netColor}">${formatCurrency(Math.abs(netAmount))}</p>
                            </div>
                        </div>

                        <!-- Transactions -->
                        <div class="space-y-6">
                            ${customerData.debitNotes.length > 0 ? `
                                <div>
                                    <h4 class="text-lg font-semibold text-indigo-600 mb-3">Debit Notes (${customerData.debitNotes.length})</h4>
                                    <div class="space-y-2">
                                        ${customerData.debitNotes.map(note => `
                                            <div class="bg-indigo-50 p-3 rounded border-l-4 border-indigo-500">
                                                <div class="flex justify-between items-start">
                                                    <div>
                                                        <p class="font-medium text-gray-800">${note.description}</p>
                                                        <p class="text-sm text-gray-600">Note: ${note.noteId} | Transaction: ${note.transactionId}</p>
                                                        <p class="text-xs text-gray-500">${new Date(note.timestamp).toLocaleString()}</p>
                                                    </div>
                                                    <span class="font-bold text-indigo-600">${formatCurrency(note.amount)}</span>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}

                            ${customerData.creditNotes.length > 0 ? `
                                <div>
                                    <h4 class="text-lg font-semibold text-emerald-600 mb-3">Credit Notes (${customerData.creditNotes.length})</h4>
                                    <div class="space-y-2">
                                        ${customerData.creditNotes.map(note => `
                                            <div class="bg-emerald-50 p-3 rounded border-l-4 border-emerald-500">
                                                <div class="flex justify-between items-start">
                                                    <div>
                                                        <p class="font-medium text-gray-800">${note.description}</p>
                                                        <p class="text-sm text-gray-600">Note: ${note.noteId} | Transaction: ${note.transactionId}</p>
                                                        <p class="text-xs text-gray-500">${new Date(note.timestamp).toLocaleString()}</p>
                                                    </div>
                                                    <span class="font-bold text-emerald-600">${formatCurrency(note.amount)}</span>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(modalOverlay);

            // Add event listeners
            const closeModal = () => {
                document.body.removeChild(modalOverlay);
            };

            modalOverlay.querySelector('#close-customer-modal').addEventListener('click', closeModal);
            modalOverlay.addEventListener('click', (e) => {
                if (e.target === modalOverlay) closeModal();
            });
        }

        /**
         * Exports notes data to CSV format
         * @param {object} notesData - Notes data to export
         * @param {string} type - 'debit' or 'credit'
         */
        function exportNotesToCSV(notesData, type) {
            const noteIds = Object.keys(notesData);
            if (noteIds.length === 0) {
                alert(`No ${type} notes to export`);
                return;
            }

            const csvHeaders = ['Note ID', 'Date', 'Customer Name', 'Document Type', 'Amount', 'Tax Type', 'Tax Rate'];
            const csvRows = [csvHeaders.join(',')];

            noteIds.forEach(noteId => {
                const noteData = notesData[noteId];
                const customerName = noteData.transactions && noteData.transactions.length > 0 ?
                    (noteData.transactions[0].customerName || 'N/A') : 'N/A';
                const documentType = noteData.transactions && noteData.transactions.length > 0 ?
                    (noteData.transactions[0].documentType || 'General') : 'General';
                const createdDate = noteData.createdAt ?
                    new Date(noteData.createdAt).toLocaleDateString('en-GB') :
                    new Date().toLocaleDateString('en-GB');

                const row = [
                    noteId,
                    createdDate,
                    `"${customerName}"`,
                    `"${documentType}"`,
                    noteData.totalAmount || 0,
                    `"${noteData.taxType || 'No Tax'}"`,
                    noteData.taxRate || 0
                ];
                csvRows.push(row.join(','));
            });

            const csvContent = csvRows.join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `${type}_notes_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        /**
         * Exports notes data to JSON format
         * @param {object} notesData - Notes data to export
         * @param {string} type - 'debit' or 'credit'
         */
        function exportNotesToJSON(notesData, type) {
            const noteIds = Object.keys(notesData);
            if (noteIds.length === 0) {
                alert(`No ${type} notes to export`);
                return;
            }

            const jsonContent = JSON.stringify(notesData, null, 2);
            const blob = new Blob([jsonContent], { type: 'application/json;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `${type}_notes_${new Date().toISOString().split('T')[0]}.json`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        /**
         * Shows export format selection modal
         * @param {string} type - 'debit' or 'credit'
         */
        function showExportModal(type) {
            const savedData = localStorage.getItem('creditDebitNotes');
            if (!savedData) {
                alert('No data to export');
                return;
            }

            const notesData = JSON.parse(savedData);
            const targetData = type === 'debit' ? notesData.debitNotes : notesData.creditNotes;

            // Create modal overlay
            const modalOverlay = document.createElement('div');
            modalOverlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';

            modalOverlay.innerHTML = `
                <div class="bg-white rounded-lg shadow-xl w-full max-w-md">
                    <div class="flex items-center justify-between p-6 border-b border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-800">Export ${type.charAt(0).toUpperCase() + type.slice(1)} Notes</h3>
                        <button id="close-export-modal" class="text-gray-400 hover:text-gray-600">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    <div class="p-6">
                        <p class="text-gray-600 mb-4">Choose export format:</p>
                        <div class="space-y-3">
                            <button id="export-csv" class="w-full flex items-center justify-center px-4 py-3 border border-gray-300 rounded-md shadow-sm bg-white text-sm font-medium text-gray-700 hover:bg-gray-50">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                Export as CSV
                            </button>
                            <button id="export-json" class="w-full flex items-center justify-center px-4 py-3 border border-gray-300 rounded-md shadow-sm bg-white text-sm font-medium text-gray-700 hover:bg-gray-50">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"></path>
                                </svg>
                                Export as JSON
                            </button>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(modalOverlay);

            // Add event listeners
            const closeModal = () => {
                document.body.removeChild(modalOverlay);
            };

            modalOverlay.querySelector('#close-export-modal').addEventListener('click', closeModal);
            modalOverlay.addEventListener('click', (e) => {
                if (e.target === modalOverlay) closeModal();
            });

            modalOverlay.querySelector('#export-csv').addEventListener('click', () => {
                exportNotesToCSV(targetData, type);
                closeModal();
            });

            modalOverlay.querySelector('#export-json').addEventListener('click', () => {
                exportNotesToJSON(targetData, type);
                closeModal();
            });
        }

        /**
         * Updates the time-based summary cards with counts
         * @param {object} debitNotes - Debit notes data
         * @param {object} creditNotes - Credit notes data
         * @param {string} timestamp - Creation timestamp from saved data
         */
        function updateSummary(debitNotes, creditNotes, timestamp) {
            const now = new Date();
            const startOfToday = getStartOfToday();
            const startOfWeek = getStartOfWeek();
            const startOfMonth = getStartOfMonth();
            const startOfYear = getStartOfYear();

            // Initialize counters
            let todayDebit = 0, todayCredit = 0;
            let weekDebit = 0, weekCredit = 0;
            let monthDebit = 0, monthCredit = 0;
            let yearDebit = 0, yearCredit = 0;
            let totalDebit = 0, totalCredit = 0;
            let totalDebitAmount = 0, totalCreditAmount = 0;

            // Count debit notes by time periods
            Object.keys(debitNotes).forEach(noteId => {
                totalDebit++;
                const noteData = debitNotes[noteId];
                totalDebitAmount += noteData.totalAmount || 0;

                // For time-based counting, we'll use the current timestamp as creation time
                // In a real application, each note would have its own creation timestamp
                const noteTimestamp = timestamp || new Date().toISOString();

                if (isWithinDateRange(noteTimestamp, startOfToday)) {
                    todayDebit++;
                }
                if (isWithinDateRange(noteTimestamp, startOfWeek)) {
                    weekDebit++;
                }
                if (isWithinDateRange(noteTimestamp, startOfMonth)) {
                    monthDebit++;
                }
                if (isWithinDateRange(noteTimestamp, startOfYear)) {
                    yearDebit++;
                }
            });

            // Count credit notes by time periods
            Object.keys(creditNotes).forEach(noteId => {
                totalCredit++;
                const noteData = creditNotes[noteId];
                totalCreditAmount += noteData.totalAmount || 0;

                // For time-based counting, we'll use the current timestamp as creation time
                const noteTimestamp = timestamp || new Date().toISOString();

                if (isWithinDateRange(noteTimestamp, startOfToday)) {
                    todayCredit++;
                }
                if (isWithinDateRange(noteTimestamp, startOfWeek)) {
                    weekCredit++;
                }
                if (isWithinDateRange(noteTimestamp, startOfMonth)) {
                    monthCredit++;
                }
                if (isWithinDateRange(noteTimestamp, startOfYear)) {
                    yearCredit++;
                }
            });

            // Calculate net amount (Money Received - Money Paid)
            const netAmount = totalDebitAmount - totalCreditAmount;

            // Update the original summary cards with amounts
            document.getElementById('total-debit-amount').textContent = formatCurrency(totalDebitAmount);
            document.getElementById('total-credit-amount').textContent = formatCurrency(totalCreditAmount);
            document.getElementById('net-amount').textContent = formatCurrency(netAmount);

            // Update the time-based summary cards
            document.getElementById('today-debit-count').textContent = todayDebit;
            document.getElementById('today-credit-count').textContent = todayCredit;
            document.getElementById('week-debit-count').textContent = weekDebit;
            document.getElementById('week-credit-count').textContent = weekCredit;
            document.getElementById('month-debit-count').textContent = monthDebit;
            document.getElementById('month-credit-count').textContent = monthCredit;
            document.getElementById('year-debit-count').textContent = yearDebit;
            document.getElementById('year-credit-count').textContent = yearCredit;
            document.getElementById('total-debit-count').textContent = totalDebit;
            document.getElementById('total-credit-count').textContent = totalCredit;
        }

        // Load and display notes when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            loadAndDisplayNotes();

            // Party Ledger button event listener
            const partyLedgerBtn = document.getElementById('party-ledger-btn');
            if (partyLedgerBtn) {
                partyLedgerBtn.addEventListener('click', () => {
                    loadAndDisplayPartyLedger();
                    // Scroll to party ledger section
                    document.getElementById('party-ledger-container').scrollIntoView({
                        behavior: 'smooth'
                    });
                });
            }

            // Refresh buttons event listeners
            const refreshDebitBtn = document.getElementById('refresh-debit-notes');
            if (refreshDebitBtn) {
                refreshDebitBtn.addEventListener('click', () => {
                    loadAndDisplayNotes();
                });
            }

            const refreshCreditBtn = document.getElementById('refresh-credit-notes');
            if (refreshCreditBtn) {
                refreshCreditBtn.addEventListener('click', () => {
                    loadAndDisplayNotes();
                });
            }

            // Export/Import button event listeners
            const exportDebitBtn = document.getElementById('export-debit-notes');
            if (exportDebitBtn) {
                exportDebitBtn.addEventListener('click', () => {
                    showExportModal('debit');
                });
            }

            const exportCreditBtn = document.getElementById('export-credit-notes');
            if (exportCreditBtn) {
                exportCreditBtn.addEventListener('click', () => {
                    showExportModal('credit');
                });
            }

            const importDebitBtn = document.getElementById('import-debit-notes');
            if (importDebitBtn) {
                importDebitBtn.addEventListener('click', () => {
                    document.getElementById('debit-notes-file-input').click();
                });
            }

            const importCreditBtn = document.getElementById('import-credit-notes');
            if (importCreditBtn) {
                importCreditBtn.addEventListener('click', () => {
                    document.getElementById('credit-notes-file-input').click();
                });
            }

            // File input event listeners
            const debitFileInput = document.getElementById('debit-notes-file-input');
            if (debitFileInput) {
                debitFileInput.addEventListener('change', (e) => {
                    handleFileImport(e, 'debit');
                });
            }

            const creditFileInput = document.getElementById('credit-notes-file-input');
            if (creditFileInput) {
                creditFileInput.addEventListener('change', (e) => {
                    handleFileImport(e, 'credit');
                });
            }

            // Refresh data every 5 seconds in case it's updated in another tab
            setInterval(loadAndDisplayNotes, 5000);
        });

        /**
         * Handles file import for notes
         * @param {Event} event - File input change event
         * @param {string} type - 'debit' or 'credit'
         */
        function handleFileImport(event, type) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    let importedData;

                    if (file.name.endsWith('.json')) {
                        importedData = JSON.parse(e.target.result);
                    } else if (file.name.endsWith('.csv')) {
                        importedData = parseCSVToNotes(e.target.result, type);
                    } else {
                        alert('Unsupported file format. Please use CSV or JSON files.');
                        return;
                    }

                    // Validate and merge imported data
                    if (validateImportedData(importedData, type)) {
                        mergeImportedData(importedData, type);
                        loadAndDisplayNotes();
                        alert(`${type.charAt(0).toUpperCase() + type.slice(1)} notes imported successfully!`);
                    } else {
                        alert('Invalid file format or data structure.');
                    }
                } catch (error) {
                    console.error('Import error:', error);
                    alert('Error importing file. Please check the file format.');
                }
            };
            reader.readAsText(file);

            // Reset file input
            event.target.value = '';
        }

        /**
         * Parses CSV content to notes data structure
         * @param {string} csvContent - CSV file content
         * @param {string} type - 'debit' or 'credit'
         * @returns {object} Parsed notes data
         */
        function parseCSVToNotes(csvContent, type) {
            const lines = csvContent.split('\n');
            const headers = lines[0].split(',').map(h => h.trim());
            const notesData = {};

            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;

                const values = line.split(',').map(v => v.trim().replace(/^"|"$/g, ''));

                if (values.length >= 5) {
                    const noteId = values[0];
                    const date = values[1];
                    const customerName = values[2];
                    const documentType = values[3];
                    const amount = parseFloat(values[4]) || 0;
                    const taxType = values[5] || 'No Tax';
                    const taxRate = parseFloat(values[6]) || 0;

                    notesData[noteId] = {
                        transactions: [{
                            id: `imported_${Date.now()}_${i}`,
                            description: `Imported ${type} note`,
                            amount: amount,
                            status: 'Imported',
                            customerName: customerName,
                            documentType: documentType
                        }],
                        totalAmount: amount,
                        taxType: taxType,
                        taxRate: taxRate,
                        createdAt: new Date(date).toISOString() || new Date().toISOString()
                    };
                }
            }

            return notesData;
        }

        /**
         * Validates imported data structure
         * @param {object} data - Imported data
         * @param {string} type - 'debit' or 'credit'
         * @returns {boolean} True if valid
         */
        function validateImportedData(data, type) {
            if (!data || typeof data !== 'object') return false;

            // Check if it's a valid notes data structure
            for (const noteId in data) {
                const noteData = data[noteId];
                if (!noteData.transactions || !Array.isArray(noteData.transactions)) return false;
                if (typeof noteData.totalAmount !== 'number') return false;
            }

            return true;
        }

        /**
         * Merges imported data with existing data
         * @param {object} importedData - Imported notes data
         * @param {string} type - 'debit' or 'credit'
         */
        function mergeImportedData(importedData, type) {
            const savedData = localStorage.getItem('creditDebitNotes');
            let existingData = savedData ? JSON.parse(savedData) : { debitNotes: {}, creditNotes: {} };

            const targetKey = type === 'debit' ? 'debitNotes' : 'creditNotes';

            // Merge imported data with existing data
            Object.assign(existingData[targetKey], importedData);

            // Update timestamp
            existingData.timestamp = new Date().toISOString();

            // Save back to localStorage
            localStorage.setItem('creditDebitNotes', JSON.stringify(existingData));
        }
    </script>

</body>
</html>
