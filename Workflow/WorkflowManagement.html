<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workflow Management - Multi-Tenant SaaS</title>
    <!-- Material Design Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Pure Black & White with Strategic Accent Colors */
            --primary-color: #000000;
            --secondary-color: #333333;
            --accent-color: #007AFF;
            --success-color: #34C759;
            --warning-color: #FF9500;
            --error-color: #FF3B30;
            --info-color: #5AC8FA;
            --background-primary: #ffffff;
            --background-secondary: #f8f9fa;
            --background-tertiary: #f0f0f0;
            --text-primary: #000000;
            --text-secondary: #666666;
            --text-light: #999999;
            --text-white: #ffffff;
            --border-primary: #e0e0e0;
            --border-secondary: #d0d0d0;
            --shadow-light: 0 2px 4px rgba(0, 0, 0, 0.1);
            --shadow-medium: 0 4px 8px rgba(0, 0, 0, 0.15);
            --shadow-heavy: 0 8px 16px rgba(0, 0, 0, 0.2);
            --radius-sm: 4px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --radius-xl: 16px;
            --spacing-xs: 0.25rem;
            --spacing-sm: 0.5rem;
            --spacing-md: 1rem;
            --spacing-lg: 1.5rem;
            --spacing-xl: 2rem;
            --spacing-2xl: 3rem;
            --transition-fast: 0.15s ease;
            --transition-normal: 0.3s ease;
            --transition-slow: 0.5s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--background-secondary);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* Enhanced Header */
        .header.enhanced-header {
            background: linear-gradient(135deg, var(--background-primary) 0%, var(--background-secondary) 100%);
            color: var(--text-primary);
            padding: var(--spacing-md) var(--spacing-xl);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border-primary);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1400px;
            margin: 0 auto;
            gap: var(--spacing-lg);
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }

        .logo-icon {
            font-size: 2.5rem;
            color: var(--accent-color);
            animation: logoRotate 20s linear infinite;
        }

        @keyframes logoRotate {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .title-text h1 {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0;
            line-height: 1.2;
        }

        .header-subtitle {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        .header-center {
            flex: 1;
            max-width: 600px;
            margin: 0 var(--spacing-lg);
        }

        .enhanced-search {
            position: relative;
            width: 100%;
        }

        .global-search {
            width: 100%;
            padding: var(--spacing-sm) var(--spacing-lg) var(--spacing-sm) 3rem;
            border: 2px solid var(--border-primary);
            border-radius: 25px;
            background: var(--background-primary);
            color: var(--text-primary);
            font-size: 0.9rem;
            transition: all var(--transition-normal);
        }

        .global-search:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
        }

        .search-icon {
            position: absolute;
            left: var(--spacing-md);
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
            z-index: 2;
        }

        .search-clear {
            position: absolute;
            right: var(--spacing-sm);
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: var(--spacing-xs);
            border-radius: 50%;
            transition: var(--transition-fast);
        }

        .search-clear:hover {
            background: var(--background-tertiary);
            color: var(--text-primary);
        }

        .search-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--background-primary);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-heavy);
            z-index: 1000;
            max-height: 300px;
            overflow-y: auto;
            margin-top: var(--spacing-xs);
        }

        .header-actions {
            display: flex;
            gap: var(--spacing-sm);
            align-items: center;
        }

        .btn-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--background-tertiary);
            border: 1px solid var(--border-primary);
            color: var(--text-primary);
            cursor: pointer;
            transition: all var(--transition-fast);
            position: relative;
        }

        .btn-icon:hover {
            background: var(--accent-color);
            color: var(--text-white);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3);
        }

        .theme-toggle {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            color: var(--text-white);
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--error-color);
            color: var(--text-white);
            font-size: 0.75rem;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 10px;
            min-width: 18px;
            text-align: center;
            animation: badgePulse 2s ease-in-out infinite;
        }

        @keyframes badgePulse {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.1);
            }
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--radius-lg);
            background: var(--background-tertiary);
            border: 1px solid var(--border-primary);
            cursor: pointer;
            transition: all var(--transition-fast);
            position: relative;
        }

        .user-menu:hover {
            background: var(--background-secondary);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--accent-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-white);
        }

        .user-info {
            display: flex;
            flex-direction: column;
        }

        .user-name {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-primary);
            line-height: 1.2;
        }

        .user-role {
            font-size: 0.75rem;
            color: var(--text-secondary);
            line-height: 1.2;
        }

        /* Main Container */
        .main-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: var(--spacing-xl);
            min-height: calc(100vh - 80px);
        }

        /* Dashboard Cards */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: var(--spacing-lg);
            margin-bottom: var(--spacing-2xl);
        }

        .dashboard-card {
            background: var(--background-primary);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            box-shadow: var(--shadow-light);
            border: 1px solid var(--border-primary);
            cursor: pointer;
            transition: var(--transition-normal);
            position: relative;
            overflow: hidden;
        }

        .dashboard-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
            border-color: var(--accent-color);
        }

        .dashboard-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-md);
        }

        .dashboard-card-title {
            font-size: 1rem;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .dashboard-card-icon {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-white);
        }

        .dashboard-card-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: var(--spacing-xs);
        }

        .dashboard-card-subtitle {
            font-size: 0.875rem;
            color: var(--text-light);
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-xl);
            flex-wrap: wrap;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-xs);
            padding: var(--spacing-sm) var(--spacing-md);
            border: none;
            border-radius: var(--radius-md);
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition-fast);
            text-decoration: none;
            white-space: nowrap;
            height: 40px;
            min-width: 120px;
            justify-content: center;
        }

        .btn-primary {
            background: var(--primary-color);
            color: var(--text-white);
        }

        .btn-primary:hover {
            background: var(--secondary-color);
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: var(--background-primary);
            color: var(--text-primary);
            border: 1px solid var(--border-primary);
        }

        .btn-secondary:hover {
            background: var(--background-tertiary);
            border-color: var(--accent-color);
        }

        .btn-success {
            background: var(--success-color);
            color: var(--text-white);
        }

        .btn-warning {
            background: var(--warning-color);
            color: var(--text-white);
        }

        .btn-danger {
            background: var(--error-color);
            color: var(--text-white);
        }

        /* Workflow Designer */
        .workflow-designer {
            background: var(--background-primary);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-light);
            border: 1px solid var(--border-primary);
            overflow: hidden;
            margin-bottom: var(--spacing-xl);
        }

        .workflow-designer-header {
            background: var(--background-tertiary);
            padding: var(--spacing-md) var(--spacing-lg);
            border-bottom: 1px solid var(--border-primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .workflow-designer-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .workflow-canvas {
            position: relative;
            min-height: 600px;
            background: var(--background-primary);
            background-image:
                radial-gradient(circle, var(--border-primary) 1px, transparent 1px);
            background-size: 20px 20px;
            overflow: auto;
            padding: var(--spacing-xl);
        }

        /* Enhanced Workflow Steps */
        .workflow-step {
            position: absolute;
            background: var(--background-primary);
            border: 2px solid var(--border-primary);
            border-radius: var(--radius-lg);
            padding: var(--spacing-md);
            min-width: 200px;
            max-width: 280px;
            cursor: move;
            box-shadow: var(--shadow-light);
            transition: var(--transition-fast);
            user-select: none;
            overflow: visible;
        }

        .workflow-step:hover {
            border-color: var(--accent-color);
            box-shadow: var(--shadow-medium);
            transform: translateY(-2px);
        }

        .workflow-step.selected {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.2);
            transform: translateY(-2px);
        }

        .workflow-step.dragging {
            opacity: 0.9;
            transform: rotate(1deg) scale(1.02);
            z-index: 1000;
            box-shadow: var(--shadow-heavy);
        }

        .workflow-step.connection-source {
            border-color: var(--success-color);
            box-shadow: 0 0 0 3px rgba(52, 199, 89, 0.3);
        }

        .workflow-step.connection-target {
            border-color: var(--warning-color);
            box-shadow: 0 0 0 3px rgba(255, 149, 0, 0.3);
        }

        .workflow-step.can-connect {
            border-color: var(--success-color);
            animation: pulse-connect 1s infinite;
        }

        @keyframes pulse-connect {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.05);
            }
        }

        /* Connection Handles */
        .connection-handle {
            position: absolute;
            width: 12px;
            height: 12px;
            background: var(--accent-color);
            border: 2px solid var(--background-primary);
            border-radius: 50%;
            cursor: crosshair;
            opacity: 0;
            transition: var(--transition-fast);
            z-index: 10;
        }

        .connection-handle:hover {
            transform: scale(1.3);
            background: var(--success-color);
        }

        .connection-handle.output {
            right: -6px;
            top: 50%;
            transform: translateY(-50%);
        }

        .connection-handle.input {
            left: -6px;
            top: 50%;
            transform: translateY(-50%);
        }

        .connection-handle.top {
            top: -6px;
            left: 50%;
            transform: translateX(-50%);
        }

        .connection-handle.bottom {
            bottom: -6px;
            left: 50%;
            transform: translateX(-50%);
        }

        .workflow-step:hover .connection-handle,
        .workflow-step.selected .connection-handle {
            opacity: 1;
        }

        .connection-handle.active {
            opacity: 1;
            background: var(--success-color);
            animation: pulse-handle 0.8s infinite;
        }

        @keyframes pulse-handle {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.4);
            }
        }

        /* Connection Preview */
        .connection-preview {
            position: absolute;
            pointer-events: none;
            z-index: 5;
        }

        .connection-preview-line {
            stroke: var(--accent-color);
            stroke-width: 3;
            stroke-dasharray: 8, 4;
            fill: none;
            opacity: 0.7;
            animation: dash-flow 1s linear infinite;
        }

        @keyframes dash-flow {
            to {
                stroke-dashoffset: -12;
            }
        }

        /* Enhanced Step Content */
        .step-content {
            position: relative;
            z-index: 2;
        }

        .step-progress {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--background-tertiary);
            border-radius: 0 0 var(--radius-lg) var(--radius-lg);
            overflow: hidden;
        }

        .step-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-color), var(--success-color));
            width: 0%;
            transition: width 0.3s ease;
        }

        .step-status-indicator {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            color: var(--text-white);
            border: 2px solid var(--background-primary);
        }

        .step-status-indicator.pending {
            background: var(--warning-color);
        }

        .step-status-indicator.completed {
            background: var(--success-color);
        }

        .step-status-indicator.error {
            background: var(--error-color);
        }

        .step-status-indicator.in-progress {
            background: var(--info-color);
            animation: spin 2s linear infinite;
        }

        .step-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-sm);
        }

        .step-type {
            font-size: 0.75rem;
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: var(--radius-sm);
            font-weight: 500;
            text-transform: uppercase;
        }

        .step-type.begin {
            background: var(--success-color);
            color: var(--text-white);
        }

        .step-type.intermediate {
            background: var(--info-color);
            color: var(--text-white);
        }

        .step-type.end {
            background: var(--error-color);
            color: var(--text-white);
        }

        .step-title {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: var(--spacing-xs);
        }

        .step-status {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: var(--spacing-sm);
        }

        .step-actions {
            display: flex;
            gap: var(--spacing-xs);
            flex-wrap: wrap;
        }

        .step-action {
            font-size: 0.75rem;
            padding: var(--spacing-xs) var(--spacing-sm);
            background: var(--background-tertiary);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-sm);
            color: var(--text-secondary);
        }

        /* Enhanced Connection Lines */
        .workflow-connection {
            position: absolute;
            pointer-events: none;
            z-index: 1;
        }

        .connection-line {
            stroke: var(--accent-color);
            stroke-width: 2.5;
            fill: none;
            marker-end: url(#arrowhead);
            transition: all 0.3s ease;
            cursor: pointer;
            pointer-events: stroke;
        }

        .connection-line:hover {
            stroke: var(--success-color);
            stroke-width: 3.5;
            filter: drop-shadow(0 0 4px rgba(0, 122, 255, 0.4));
        }

        .connection-line.selected {
            stroke: var(--warning-color);
            stroke-width: 3;
            stroke-dasharray: 6, 3;
            animation: dash-flow 1s linear infinite;
        }

        .connection-line.error {
            stroke: var(--error-color);
            stroke-dasharray: 4, 4;
        }

        .connection-line.success {
            stroke: var(--success-color);
        }

        /* Connection Labels */
        .connection-label {
            position: absolute;
            background: var(--background-primary);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-sm);
            padding: var(--spacing-xs) var(--spacing-sm);
            font-size: 0.75rem;
            color: var(--text-secondary);
            pointer-events: none;
            z-index: 10;
            box-shadow: var(--shadow-light);
            transform: translate(-50%, -50%);
        }

        .connection-label.hover {
            background: var(--accent-color);
            color: var(--text-white);
            border-color: var(--accent-color);
        }

        /* Enhanced Canvas */
        .workflow-canvas {
            position: relative;
            min-height: 700px;
            background: var(--background-primary);
            background-image:
                radial-gradient(circle, var(--border-primary) 1px, transparent 1px),
                radial-gradient(circle, var(--border-primary) 1px, transparent 1px);
            background-size: 20px 20px, 100px 100px;
            background-position: 0 0, 50px 50px;
            overflow: auto;
            padding: var(--spacing-xl);
            border-radius: var(--radius-lg);
        }

        /* Workflow Configuration Panel */
        .workflow-config-panel {
            background: var(--background-primary);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-light);
            border: 1px solid var(--border-primary);
            overflow: hidden;
            margin-bottom: var(--spacing-xl);
        }

        .workflow-config-header {
            background: var(--background-tertiary);
            padding: var(--spacing-md) var(--spacing-lg);
            border-bottom: 1px solid var(--border-primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .workflow-config-content {
            padding: var(--spacing-lg);
        }

        /* Configuration Table */
        .config-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: var(--spacing-lg);
        }

        .config-table th {
            background: var(--background-tertiary);
            padding: var(--spacing-sm) var(--spacing-md);
            text-align: left;
            font-weight: 600;
            color: var(--text-primary);
            border: 1px solid var(--border-primary);
            font-size: 0.875rem;
        }

        .config-table td {
            padding: var(--spacing-sm);
            border: 1px solid var(--border-primary);
            vertical-align: top;
        }

        .config-table tr:hover {
            background: var(--background-tertiary);
        }

        .config-input {
            width: 100%;
            padding: var(--spacing-xs) var(--spacing-sm);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-sm);
            font-size: 0.875rem;
            background: var(--background-primary);
        }

        .config-input:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px rgba(0, 122, 255, 0.1);
        }

        .config-select {
            width: 100%;
            padding: var(--spacing-xs) var(--spacing-sm);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-sm);
            font-size: 0.875rem;
            background: var(--background-primary);
            cursor: pointer;
        }

        .config-select:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px rgba(0, 122, 255, 0.1);
        }

        /* Add/Remove Row Buttons */
        .row-actions {
            display: flex;
            gap: var(--spacing-xs);
            justify-content: center;
        }

        .row-btn {
            width: 28px;
            height: 28px;
            border: none;
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition-fast);
            font-size: 0.875rem;
        }

        .row-btn.add {
            background: var(--success-color);
            color: var(--text-white);
        }

        .row-btn.add:hover {
            background: #2ea043;
            transform: scale(1.1);
        }

        .row-btn.remove {
            background: var(--error-color);
            color: var(--text-white);
        }

        .row-btn.remove:hover {
            background: #d73a49;
            transform: scale(1.1);
        }

        /* Workflow Generation Controls */
        .generation-controls {
            display: flex;
            gap: var(--spacing-md);
            align-items: center;
            padding: var(--spacing-md);
            background: var(--background-tertiary);
            border-radius: var(--radius-md);
            margin-top: var(--spacing-lg);
        }

        .generation-status {
            flex: 1;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .generation-status.success {
            color: var(--success-color);
        }

        .generation-status.error {
            color: var(--error-color);
        }

        /* Auto-generated Steps */
        .auto-step {
            animation: slideInFromLeft 0.5s ease-out;
        }

        @keyframes slideInFromLeft {
            from {
                opacity: 0;
                transform: translateX(-50px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .auto-connection {
            animation: drawConnection 0.8s ease-out;
        }

        @keyframes drawConnection {
            from {
                stroke-dasharray: 1000;
                stroke-dashoffset: 1000;
            }

            to {
                stroke-dasharray: 0;
                stroke-dashoffset: 0;
            }
        }

        /* Step Templates */
        .step-template-selector {
            margin-bottom: var(--spacing-lg);
        }

        .template-options {
            display: flex;
            gap: var(--spacing-sm);
            flex-wrap: wrap;
            margin-top: var(--spacing-sm);
        }

        .template-option {
            padding: var(--spacing-sm) var(--spacing-md);
            background: var(--background-secondary);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: var(--transition-fast);
            font-size: 0.875rem;
        }

        .template-option:hover {
            background: var(--accent-color);
            color: var(--text-white);
            border-color: var(--accent-color);
        }

        .template-option.active {
            background: var(--accent-color);
            color: var(--text-white);
            border-color: var(--accent-color);
        }

        .workflow-canvas.connection-mode {
            cursor: crosshair;
        }

        .workflow-canvas.connection-mode .workflow-step {
            cursor: crosshair;
        }

        /* Canvas Tools */
        .canvas-tools {
            position: absolute;
            top: var(--spacing-md);
            right: var(--spacing-md);
            display: flex;
            gap: var(--spacing-xs);
            z-index: 100;
        }

        .canvas-tool {
            width: 36px;
            height: 36px;
            border-radius: var(--radius-md);
            background: var(--background-primary);
            border: 1px solid var(--border-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition-fast);
            box-shadow: var(--shadow-light);
        }

        .canvas-tool:hover {
            background: var(--accent-color);
            color: var(--text-white);
            border-color: var(--accent-color);
            transform: translateY(-1px);
        }

        .canvas-tool.active {
            background: var(--accent-color);
            color: var(--text-white);
            border-color: var(--accent-color);
        }

        /* Zoom Controls */
        .zoom-controls {
            position: absolute;
            bottom: var(--spacing-md);
            right: var(--spacing-md);
            display: flex;
            flex-direction: column;
            gap: var(--spacing-xs);
            z-index: 100;
        }

        .zoom-control {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-md);
            background: var(--background-primary);
            border: 1px solid var(--border-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition-fast);
            box-shadow: var(--shadow-light);
            font-size: 1.2rem;
        }

        .zoom-control:hover {
            background: var(--accent-color);
            color: var(--text-white);
            border-color: var(--accent-color);
        }

        .zoom-level {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-align: center;
            padding: var(--spacing-xs);
            background: var(--background-primary);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-sm);
        }

        /* Mini Map */
        .mini-map {
            position: absolute;
            bottom: var(--spacing-md);
            left: var(--spacing-md);
            width: 200px;
            height: 120px;
            background: var(--background-primary);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-light);
            z-index: 100;
            overflow: hidden;
        }

        .mini-map-content {
            width: 100%;
            height: 100%;
            background: var(--background-secondary);
            position: relative;
        }

        .mini-map-viewport {
            position: absolute;
            border: 2px solid var(--accent-color);
            background: rgba(0, 122, 255, 0.1);
            cursor: move;
        }

        .mini-map-step {
            position: absolute;
            width: 8px;
            height: 6px;
            background: var(--accent-color);
            border-radius: 1px;
        }

        /* Sidebar */
        .sidebar {
            position: fixed;
            right: -400px;
            top: 0;
            width: 400px;
            height: 100vh;
            background: var(--background-primary);
            box-shadow: var(--shadow-heavy);
            transition: var(--transition-normal);
            z-index: 1001;
            overflow-y: auto;
        }

        .sidebar.open {
            right: 0;
        }

        .sidebar-header {
            background: var(--primary-color);
            color: var(--text-white);
            padding: var(--spacing-lg);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sidebar-content {
            padding: var(--spacing-lg);
        }

        /* Form Elements */
        .form-group {
            margin-bottom: var(--spacing-lg);
        }

        .form-label {
            display: block;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: var(--spacing-xs);
        }

        .form-input {
            width: 100%;
            padding: var(--spacing-sm) var(--spacing-md);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-md);
            font-size: 0.875rem;
            transition: var(--transition-fast);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
        }

        .form-select {
            width: 100%;
            padding: var(--spacing-sm) var(--spacing-md);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-md);
            font-size: 0.875rem;
            background: var(--background-primary);
            cursor: pointer;
        }

        /* Tabs */
        .tabs {
            border-bottom: 1px solid var(--border-primary);
            margin-bottom: var(--spacing-lg);
        }

        .tab-list {
            display: flex;
            gap: var(--spacing-md);
        }

        .tab-button {
            padding: var(--spacing-sm) var(--spacing-md);
            border: none;
            background: none;
            color: var(--text-secondary);
            font-weight: 500;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: var(--transition-fast);
        }

        .tab-button.active {
            color: var(--accent-color);
            border-bottom-color: var(--accent-color);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Queue Management */
        .queue-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: var(--spacing-lg);
            margin-bottom: var(--spacing-xl);
        }

        .queue-card {
            background: var(--background-primary);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-light);
            border: 1px solid var(--border-primary);
            overflow: hidden;
        }

        .queue-header {
            background: var(--background-tertiary);
            padding: var(--spacing-md) var(--spacing-lg);
            border-bottom: 1px solid var(--border-primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .queue-title {
            font-weight: 600;
            color: var(--text-primary);
        }

        .queue-count {
            background: var(--accent-color);
            color: var(--text-white);
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: var(--radius-sm);
            font-size: 0.75rem;
            font-weight: 600;
        }

        .queue-items {
            max-height: 400px;
            overflow-y: auto;
        }

        .queue-item {
            padding: var(--spacing-md) var(--spacing-lg);
            border-bottom: 1px solid var(--border-primary);
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .queue-item:hover {
            background: var(--background-tertiary);
        }

        .queue-item:last-child {
            border-bottom: none;
        }

        .queue-item-title {
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: var(--spacing-xs);
        }

        .queue-item-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        /* Footer */
        .footer {
            background: var(--primary-color);
            color: var(--text-white);
            padding: var(--spacing-lg) var(--spacing-xl);
            text-align: center;
            margin-top: var(--spacing-2xl);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .main-container {
                padding: var(--spacing-md);
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .action-buttons {
                flex-direction: column;
            }

            .btn {
                width: 100%;
            }

            .sidebar {
                width: 100%;
                right: -100%;
            }

            .queue-container {
                grid-template-columns: 1fr;
            }
        }

        /* Loading States */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: var(--text-white);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Advanced Search */
        .search-container {
            position: relative;
            margin-bottom: var(--spacing-lg);
        }

        .search-input {
            width: 100%;
            padding: var(--spacing-sm) var(--spacing-md) var(--spacing-sm) 3rem;
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-md);
            font-size: 0.875rem;
            transition: var(--transition-fast);
        }

        .search-input:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
        }

        .search-icon {
            position: absolute;
            left: var(--spacing-sm);
            top: 27%;
            transform: translateY(-50%);
            color: var(--text-light);
        }

        .search-filters {
            display: flex;
            gap: var(--spacing-sm);
            margin-top: var(--spacing-sm);
            flex-wrap: wrap;
        }

        .filter-chip {
            padding: var(--spacing-xs) var(--spacing-sm);
            background: var(--background-tertiary);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-sm);
            font-size: 0.75rem;
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .filter-chip.active {
            background: var(--accent-color);
            color: var(--text-white);
            border-color: var(--accent-color);
        }

        /* Workflow Templates */
        .templates-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: var(--spacing-lg);
            margin-bottom: var(--spacing-xl);
        }

        .template-card {
            background: var(--background-primary);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            cursor: pointer;
            transition: var(--transition-normal);
            position: relative;
            overflow: hidden;
        }

        .template-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
            border-color: var(--accent-color);
        }

        .template-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--accent-color), var(--success-color));
        }

        .template-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--spacing-md);
        }

        .template-title {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: var(--spacing-xs);
        }

        .template-category {
            font-size: 0.75rem;
            color: var(--text-light);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .template-icon {
            width: 40px;
            height: 40px;
            background: var(--accent-color);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-white);
        }

        .template-description {
            color: var(--text-secondary);
            font-size: 0.875rem;
            line-height: 1.5;
            margin-bottom: var(--spacing-md);
        }

        .template-stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.75rem;
            color: var(--text-light);
        }

        /* Workflow Analytics */
        .analytics-container {
            background: var(--background-primary);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-light);
            border: 1px solid var(--border-primary);
            overflow: hidden;
            margin-bottom: var(--spacing-xl);
        }

        .analytics-header {
            background: var(--background-tertiary);
            padding: var(--spacing-md) var(--spacing-lg);
            border-bottom: 1px solid var(--border-primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .analytics-content {
            padding: var(--spacing-lg);
        }

        .chart-container {
            height: 300px;
            margin-bottom: var(--spacing-lg);
            background: var(--background-secondary);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-light);
        }

        /* Step Palette */
        .step-palette {
            position: fixed;
            left: -300px;
            top: 80px;
            width: 280px;
            height: calc(100vh - 80px);
            background: var(--background-primary);
            box-shadow: var(--shadow-heavy);
            transition: var(--transition-normal);
            z-index: 1001;
            overflow-y: auto;
        }

        .step-palette.open {
            left: 0;
        }

        .palette-header {
            background: var(--primary-color);
            color: var(--text-white);
            padding: var(--spacing-md);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .palette-content {
            padding: var(--spacing-md);
        }

        .palette-section {
            margin-bottom: var(--spacing-lg);
        }

        .palette-section-title {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: var(--spacing-sm);
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .palette-item {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-sm);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-md);
            margin-bottom: var(--spacing-sm);
            cursor: grab;
            transition: var(--transition-fast);
            background: var(--background-primary);
        }

        .palette-item:hover {
            border-color: var(--accent-color);
            background: var(--background-tertiary);
        }

        .palette-item:active {
            cursor: grabbing;
        }

        .palette-item-icon {
            width: 32px;
            height: 32px;
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-white);
            font-size: 1rem;
        }

        .palette-item-info {
            flex: 1;
        }

        .palette-item-title {
            font-weight: 500;
            color: var(--text-primary);
            font-size: 0.875rem;
        }

        .palette-item-desc {
            font-size: 0.75rem;
            color: var(--text-light);
        }

        /* Workflow History */
        .history-panel {
            background: var(--background-primary);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-light);
            border: 1px solid var(--border-primary);
            overflow: hidden;
            margin-bottom: var(--spacing-xl);
        }

        .history-header {
            background: var(--background-tertiary);
            padding: var(--spacing-md) var(--spacing-lg);
            border-bottom: 1px solid var(--border-primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .history-timeline {
            padding: var(--spacing-lg);
        }

        .timeline-item {
            display: flex;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
            position: relative;
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: 20px;
            top: 40px;
            bottom: -20px;
            width: 2px;
            background: var(--border-primary);
        }

        .timeline-item:last-child::before {
            display: none;
        }

        .timeline-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-white);
            font-size: 1rem;
            flex-shrink: 0;
        }

        .timeline-content {
            flex: 1;
            padding-top: var(--spacing-xs);
        }

        .timeline-title {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: var(--spacing-xs);
        }

        .timeline-description {
            color: var(--text-secondary);
            font-size: 0.875rem;
            margin-bottom: var(--spacing-xs);
        }

        .timeline-meta {
            font-size: 0.75rem;
            color: var(--text-light);
        }

        /* Collaboration Features */
        .collaboration-panel {
            background: var(--background-primary);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-light);
            border: 1px solid var(--border-primary);
            overflow: hidden;
            margin-bottom: var(--spacing-xl);
        }

        .collaboration-header {
            background: var(--background-tertiary);
            padding: var(--spacing-md) var(--spacing-lg);
            border-bottom: 1px solid var(--border-primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .user-avatars {
            display: flex;
            gap: var(--spacing-xs);
            margin-bottom: var(--spacing-md);
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--accent-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-white);
            font-size: 0.75rem;
            font-weight: 600;
            border: 2px solid var(--background-primary);
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .user-avatar:hover {
            transform: scale(1.1);
        }

        .comment-section {
            padding: var(--spacing-lg);
        }

        .comment-item {
            display: flex;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-md);
        }

        .comment-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--secondary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-white);
            font-size: 0.75rem;
            font-weight: 600;
            flex-shrink: 0;
        }

        .comment-content {
            flex: 1;
            background: var(--background-tertiary);
            border-radius: var(--radius-md);
            padding: var(--spacing-sm) var(--spacing-md);
        }

        .comment-author {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.875rem;
            margin-bottom: var(--spacing-xs);
        }

        .comment-text {
            color: var(--text-secondary);
            font-size: 0.875rem;
            line-height: 1.4;
        }

        .comment-time {
            font-size: 0.75rem;
            color: var(--text-light);
            margin-top: var(--spacing-xs);
        }

        .comment-input {
            display: flex;
            gap: var(--spacing-sm);
            margin-top: var(--spacing-md);
        }

        .comment-input input {
            flex: 1;
            padding: var(--spacing-sm) var(--spacing-md);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-md);
            font-size: 0.875rem;
        }

        /* Workflow Validation */
        .validation-panel {
            background: var(--background-primary);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-light);
            border: 1px solid var(--border-primary);
            overflow: hidden;
            margin-bottom: var(--spacing-xl);
        }

        .validation-item {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-sm) var(--spacing-lg);
            border-bottom: 1px solid var(--border-primary);
        }

        .validation-item:last-child {
            border-bottom: none;
        }

        .validation-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-white);
            font-size: 0.875rem;
        }

        .validation-icon.success {
            background: var(--success-color);
        }

        .validation-icon.warning {
            background: var(--warning-color);
        }

        .validation-icon.error {
            background: var(--error-color);
        }

        .validation-text {
            flex: 1;
            font-size: 0.875rem;
        }

        .validation-text.success {
            color: var(--success-color);
        }

        .validation-text.warning {
            color: var(--warning-color);
        }

        .validation-text.error {
            color: var(--error-color);
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--background-primary);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-md);
            padding: var(--spacing-md);
            box-shadow: var(--shadow-medium);
            z-index: 1002;
            transform: translateX(400px);
            transition: var(--transition-normal);
            min-width: 300px;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            border-left: 4px solid var(--success-color);
        }

        .notification.error {
            border-left: 4px solid var(--error-color);
        }

        .notification.warning {
            border-left: 4px solid var(--warning-color);
        }

        .notification.info {
            border-left: 4px solid var(--info-color);
        }

        .notification-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-xs);
        }

        .notification-title {
            font-weight: 600;
            color: var(--text-primary);
        }

        .notification-close {
            background: none;
            border: none;
            color: var(--text-light);
            cursor: pointer;
            padding: 0;
        }

        .notification-content {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        /* Floating Action Button */
        .fab {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: var(--accent-color);
            color: var(--text-white);
            border: none;
            box-shadow: var(--shadow-heavy);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            transition: var(--transition-normal);
            z-index: 1000;
        }

        .fab:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 20px rgba(0, 122, 255, 0.3);
        }

        /* Contextual Menu */
        .context-menu {
            position: fixed;
            background: var(--background-primary);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-heavy);
            z-index: 1003;
            min-width: 200px;
            display: none;
        }

        .context-menu-item {
            padding: var(--spacing-sm) var(--spacing-md);
            cursor: pointer;
            transition: var(--transition-fast);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            font-size: 0.875rem;
        }

        .context-menu-item:hover {
            background: var(--background-tertiary);
        }

        .context-menu-item:first-child {
            border-radius: var(--radius-md) var(--radius-md) 0 0;
        }

        .context-menu-item:last-child {
            border-radius: 0 0 var(--radius-md) var(--radius-md);
        }

        .context-menu-separator {
            height: 1px;
            background: var(--border-primary);
            margin: var(--spacing-xs) 0;
        }

        /* Progress Indicators */
        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--background-tertiary);
            border-radius: var(--radius-sm);
            overflow: hidden;
            margin: var(--spacing-sm) 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-color), var(--success-color));
            border-radius: var(--radius-sm);
            transition: width 0.3s ease;
        }

        /* Tooltips */
        .tooltip {
            position: relative;
            cursor: help;
        }

        .tooltip::before {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--primary-color);
            color: var(--text-white);
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: var(--radius-sm);
            font-size: 0.75rem;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: var(--transition-fast);
            z-index: 1004;
        }

        .tooltip:hover::before {
            opacity: 1;
        }

        /* Enhanced Template Styles */
        .enhanced-template {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-md);
            background: var(--background-primary);
            border: 2px solid var(--border-primary);
            border-radius: var(--radius-lg);
            cursor: pointer;
            transition: all var(--transition-normal);
            position: relative;
            overflow: hidden;
        }

        .enhanced-template::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--accent-color), var(--success-color));
            transform: scaleX(0);
            transition: transform var(--transition-normal);
        }

        .enhanced-template:hover {
            border-color: var(--accent-color);
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }

        .enhanced-template:hover::before {
            transform: scaleX(1);
        }

        .enhanced-template.active {
            border-color: var(--accent-color);
            background: rgba(0, 122, 255, 0.05);
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }

        .enhanced-template.active::before {
            transform: scaleX(1);
        }

        .template-icon-wrapper {
            width: 48px;
            height: 48px;
            border-radius: var(--radius-md);
            background: var(--accent-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-white);
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        .template-info {
            flex: 1;
        }

        .template-name {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: var(--spacing-xs);
        }

        .template-desc {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        /* Enhanced Configuration Form */
        .config-form-container {
            margin-top: var(--spacing-xl);
            background: var(--background-primary);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-primary);
            overflow: hidden;
        }

        .config-form-header {
            background: var(--background-tertiary);
            padding: var(--spacing-lg);
            border-bottom: 1px solid var(--border-primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .config-stats {
            display: flex;
            gap: var(--spacing-lg);
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .stat-item .material-icons {
            font-size: 1rem;
        }

        .config-table-wrapper {
            overflow-x: auto;
            max-height: 400px;
            overflow-y: auto;
        }

        .enhanced-table {
            width: 100%;
            border-collapse: collapse;
        }

        .enhanced-table th {
            background: var(--background-tertiary);
            padding: var(--spacing-md);
            text-align: left;
            font-weight: 600;
            color: var(--text-primary);
            border-bottom: 2px solid var(--border-primary);
            font-size: 0.875rem;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .enhanced-table th .material-icons {
            font-size: 1rem;
            vertical-align: middle;
            margin-right: var(--spacing-xs);
        }

        .enhanced-table td {
            padding: var(--spacing-sm);
            border-bottom: 1px solid var(--border-primary);
            vertical-align: middle;
        }

        .enhanced-table tr:hover {
            background: var(--background-tertiary);
        }

        .enhanced-table tr:last-child td {
            border-bottom: none;
        }

        .add-row-section {
            padding: var(--spacing-lg);
            text-align: center;
            border-top: 1px solid var(--border-primary);
            background: var(--background-secondary);
        }

        .add-row-btn {
            min-width: 200px;
        }

        /* Enhanced Generation Controls */
        .enhanced-controls {
            background: var(--background-primary);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-primary);
            margin-top: var(--spacing-xl);
            overflow: hidden;
        }

        .generation-status-wrapper {
            padding: var(--spacing-lg);
            border-bottom: 1px solid var(--border-primary);
        }

        .generation-status {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: var(--spacing-sm);
        }

        .generation-status.success {
            color: var(--success-color);
        }

        .generation-status.error {
            color: var(--error-color);
        }

        .status-icon {
            font-size: 1.2rem;
        }

        .generation-progress {
            margin-top: var(--spacing-md);
        }

        .progress-text {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-top: var(--spacing-xs);
        }

        .generation-actions {
            padding: var(--spacing-lg);
            display: flex;
            gap: var(--spacing-sm);
            justify-content: center;
            background: var(--background-tertiary);
        }

        .generate-btn {
            min-width: 200px;
            font-weight: 600;
        }

        /* Enhanced Input Styles */
        .config-input,
        .config-select {
            width: 100%;
            padding: var(--spacing-sm);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-md);
            font-size: 0.875rem;
            background: var(--background-primary);
            transition: var(--transition-fast);
        }

        .config-input:focus,
        .config-select:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
        }

        .config-input:hover,
        .config-select:hover {
            border-color: var(--accent-color);
        }

        /* Enhanced Row Actions */
        .row-actions {
            display: flex;
            gap: var(--spacing-xs);
            justify-content: center;
        }

        .row-btn {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition-fast);
            font-size: 0.875rem;
        }

        .row-btn.add {
            background: var(--success-color);
            color: var(--text-white);
        }

        .row-btn.add:hover {
            background: #2ea043;
            transform: scale(1.1);
        }

        .row-btn.remove {
            background: var(--error-color);
            color: var(--text-white);
        }

        .row-btn.remove:hover {
            background: #d73a49;
            transform: scale(1.1);
        }

        /* Animation for new rows */
        .config-row-enter {
            animation: slideInFromTop 0.3s ease-out;
        }

        @keyframes slideInFromTop {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Enhanced Workflow Designer */
        .workflow-designer {
            margin-top: var(--spacing-xl);
        }

        .workflow-designer-header {
            background: var(--primary-color);
            color: var(--text-white);
            padding: var(--spacing-lg);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .workflow-designer-title {
            font-size: 1.25rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        /* Progress Bar Styles */
        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--background-tertiary);
            border-radius: var(--radius-sm);
            overflow: hidden;
            margin-bottom: var(--spacing-sm);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-color), var(--success-color));
            width: 0%;
            transition: width 0.3s ease;
            border-radius: var(--radius-sm);
        }

        /* Live Workflow Preview Styles */
        .live-workflow-preview {
            margin-top: var(--spacing-xl);
            background: var(--background-primary);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-primary);
            overflow: hidden;
        }

        .live-preview-header {
            background: var(--background-tertiary);
            padding: var(--spacing-lg);
            border-bottom: 1px solid var(--border-primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .live-preview-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .live-preview-stats {
            display: flex;
            gap: var(--spacing-lg);
        }

        .live-preview-content {
            min-height: 400px;
            position: relative;
        }

        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 400px;
            color: var(--text-secondary);
            text-align: center;
        }

        .empty-state .material-icons {
            font-size: 4rem;
            margin-bottom: var(--spacing-lg);
            opacity: 0.5;
        }

        .empty-state-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: var(--spacing-sm);
            color: var(--text-primary);
        }

        .empty-state-description {
            font-size: 0.875rem;
            max-width: 400px;
        }

        .live-workflow-canvas {
            padding: var(--spacing-xl);
            min-height: 500px;
            position: relative;
            overflow: auto;
            background: linear-gradient(135deg, var(--background-secondary) 0%, var(--background-tertiary) 100%);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-primary);
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        /* Enhanced Live Workflow Step Styles */
        .live-workflow-step {
            position: absolute;
            background: var(--background-primary);
            border: 2px solid var(--border-primary);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            width: 220px;
            min-height: 120px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transition: all var(--transition-normal);
            cursor: pointer;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            backdrop-filter: blur(10px);
            border-left: 4px solid var(--accent-color);
        }

        .live-workflow-step:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 8px 25px rgba(0, 122, 255, 0.2);
            border-color: var(--accent-color);
            z-index: 10;
        }

        .live-workflow-step.begin {
            border-left-color: var(--success-color);
            background: linear-gradient(135deg, var(--background-primary) 0%, rgba(34, 197, 94, 0.05) 100%);
        }

        .live-workflow-step.end {
            border-left-color: var(--error-color);
            background: linear-gradient(135deg, var(--background-primary) 0%, rgba(239, 68, 68, 0.05) 100%);
        }

        .live-workflow-step.approval {
            border-left-color: var(--warning-color);
            background: linear-gradient(135deg, var(--background-primary) 0%, rgba(245, 158, 11, 0.05) 100%);
        }

        .live-workflow-step.intermediate {
            border-left-color: var(--info-color);
            background: linear-gradient(135deg, var(--background-primary) 0%, rgba(59, 130, 246, 0.05) 100%);
        }

        .live-step-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-sm);
        }

        .live-step-type {
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: var(--radius-sm);
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .live-step-type.begin {
            background: var(--success-color);
            color: var(--text-white);
        }

        .live-step-type.intermediate {
            background: var(--accent-color);
            color: var(--text-white);
        }

        .live-step-type.end {
            background: var(--error-color);
            color: var(--text-white);
        }

        .live-step-type.approval {
            background: var(--warning-color);
            color: var(--text-white);
        }

        .live-step-type.decision {
            background: var(--info-color);
            color: var(--text-white);
        }

        .live-step-title {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: var(--spacing-xs);
            font-size: 0.9rem;
        }

        .live-step-team {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: var(--spacing-sm);
        }

        .live-step-actions {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-xs);
        }

        .live-step-action {
            background: var(--background-tertiary);
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: var(--radius-sm);
            font-size: 0.75rem;
            color: var(--text-secondary);
            border: 1px solid var(--border-primary);
        }

        /* Live Connection Lines */
        .live-connection-svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }

        .live-connection-line {
            stroke: #007AFF;
            stroke-width: 2;
            fill: none;
            marker-end: url(#live-arrowhead);
            stroke-dasharray: 5, 3;
            animation: connectionFlow 3s linear infinite;
            opacity: 1;
            pointer-events: stroke;
        }

        .live-connection-line:hover {
            stroke-width: 4;
            opacity: 1;
            stroke-dasharray: 12, 6;
            animation-duration: 1.5s;
        }

        /* Connection Flow Animation */
        @keyframes connectionFlow {
            0% {
                stroke-dashoffset: 0;
            }

            100% {
                stroke-dashoffset: 24;
            }
        }

        /* Connection Appearance Animation */
        @keyframes connectionAppear {
            0% {
                opacity: 0;
                stroke-dasharray: 0, 1000;
            }

            50% {
                opacity: 0.5;
            }

            100% {
                opacity: 0.8;
                stroke-dasharray: 8, 4;
            }
        }

        /* Label Appearance Animation */
        @keyframes labelAppear {
            0% {
                opacity: 0;
                transform: translateX(-50%) translateY(-50%) scale(0.5);
            }

            100% {
                opacity: 0.9;
                transform: translateX(-50%) translateY(-50%) scale(1);
            }
        }

        /* Enhanced Connection Lines with Glow Effect */
        .live-connection-line.success {
            stroke: var(--success-color);
            filter: drop-shadow(0 2px 6px rgba(34, 197, 94, 0.4));
        }

        .live-connection-line.warning {
            stroke: var(--warning-color);
            filter: drop-shadow(0 2px 6px rgba(251, 191, 36, 0.4));
        }

        .live-connection-line.error {
            stroke: var(--error-color);
            filter: drop-shadow(0 2px 6px rgba(239, 68, 68, 0.4));
        }

        .live-connection-label {
            position: absolute;
            background: var(--accent-color);
            color: var(--text-white);
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: var(--radius-sm);
            font-size: 0.75rem;
            font-weight: 500;
            z-index: 2;
            pointer-events: none;
            box-shadow: var(--shadow-small);
            border: 1px solid rgba(255, 255, 255, 0.2);
            animation: labelPulse 2s ease-in-out infinite;
            transform: translateX(-50%) translateY(-50%);
        }

        .live-connection-label:hover {
            transform: translateX(-50%) translateY(-50%) scale(1.1);
            box-shadow: var(--shadow-medium);
        }

        @keyframes labelPulse {

            0%,
            100% {
                opacity: 0.9;
                transform: translateX(-50%) translateY(-50%) scale(1);
            }

            50% {
                opacity: 1;
                transform: translateX(-50%) translateY(-50%) scale(1.05);
            }
        }

        /* Enhanced Connection Label Colors */
        .live-connection-label.success {
            background: var(--success-color);
            border-color: rgba(34, 197, 94, 0.3);
        }

        .live-connection-label.error {
            background: var(--error-color);
            border-color: rgba(239, 68, 68, 0.3);
        }

        .live-connection-label.warning {
            background: var(--warning-color);
            border-color: rgba(251, 191, 36, 0.3);
        }

        .live-connection-label.default {
            background: var(--accent-color);
            border-color: rgba(0, 122, 255, 0.3);
        }

        /* Enhanced Dotted Connection Lines */
        .simple-connection-line {
            position: absolute;
            border-top: 3px dotted #007AFF;
            background: transparent;
            transition: all 0.3s ease;
            animation: connectionFlow 3s linear infinite;
            opacity: 0.9;
            filter: drop-shadow(0 1px 3px rgba(0, 122, 255, 0.3));
        }

        .simple-connection-line:hover {
            border-top: 4px dotted #007AFF;
            opacity: 1;
            filter: drop-shadow(0 2px 6px rgba(0, 122, 255, 0.5));
            animation-duration: 2s;
        }

        .simple-connection-line.success {
            border-top-color: #22C55E;
            filter: drop-shadow(0 1px 3px rgba(34, 197, 94, 0.3));
        }

        .simple-connection-line.error {
            border-top-color: #EF4444;
            filter: drop-shadow(0 1px 3px rgba(239, 68, 68, 0.3));
        }

        .simple-connection-line.warning {
            border-top-color: #F59E0B;
            filter: drop-shadow(0 1px 3px rgba(245, 158, 11, 0.3));
        }

        /* Enhanced Connection Flow Animation */
        @keyframes connectionFlow {
            0% {
                border-top-style: dotted;
                opacity: 0.7;
            }

            25% {
                border-top-style: dashed;
                opacity: 0.9;
            }

            50% {
                border-top-style: dotted;
                opacity: 1;
            }

            75% {
                border-top-style: dashed;
                opacity: 0.9;
            }

            100% {
                border-top-style: dotted;
                opacity: 0.7;
            }
        }

        /* Connection Arrow Indicators */
        .simple-connection-line::after {
            content: '→';
            position: absolute;
            right: -10px;
            top: -12px;
            color: inherit;
            font-size: 16px;
            font-weight: bold;
            animation: arrowPulse 2s ease-in-out infinite;
        }

        @keyframes arrowPulse {

            0%,
            100% {
                transform: scale(1);
                opacity: 0.8;
            }

            50% {
                transform: scale(1.2);
                opacity: 1;
            }
        }

        /* Animation for live updates */
        .live-step-enter {
            animation: liveStepFadeIn 0.5s ease-out;
        }

        @keyframes liveStepFadeIn {
            from {
                opacity: 0;
                transform: scale(0.8) translateY(20px);
            }

            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        /* Responsive Design Enhancements */
        @media (max-width: 768px) {
            .template-options {
                grid-template-columns: 1fr;
            }

            .enhanced-template {
                flex-direction: column;
                text-align: center;
            }

            .config-stats {
                flex-direction: column;
                gap: var(--spacing-sm);
            }

            .generation-actions {
                flex-direction: column;
            }

            .config-table-wrapper {
                font-size: 0.75rem;
            }

            .live-preview-header {
                flex-direction: column;
                gap: var(--spacing-sm);
                text-align: center;
            }

            .live-preview-stats {
                justify-content: center;
            }

            .live-workflow-step {
                position: relative !important;
                margin-bottom: var(--spacing-lg);
                transform: none !important;
                width: 100% !important;
                max-width: 300px;
                margin-left: auto;
                margin-right: auto;
            }

            .simple-connection-line {
                display: none !important;
            }

            .live-connection-label {
                position: relative !important;
                transform: none !important;
                margin: var(--spacing-sm) 0;
                text-align: center;
                display: block;
            }

            .live-workflow-canvas {
                padding: var(--spacing-md);
                min-height: auto;
            }
        }

        /* Enhanced Modal Styles */
        .workflow-library-modal,
        .export-modal,
        .notification-panel {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .workflow-library-modal.show,
        .export-modal.show,
        .notification-panel.show {
            opacity: 1;
            visibility: visible;
        }

        .modal-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            background: var(--background-primary);
            border-radius: var(--radius-lg);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 90vw;
            max-height: 90vh;
            overflow: hidden;
            transition: transform 0.3s ease;
        }

        .workflow-library-modal.show .modal-content,
        .export-modal.show .modal-content {
            transform: translate(-50%, -50%) scale(1);
        }

        .modal-header {
            background: var(--background-tertiary);
            padding: var(--spacing-lg);
            border-bottom: 1px solid var(--border-primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
            color: var(--text-primary);
            font-size: 1.5rem;
            font-weight: 600;
        }

        .modal-body {
            padding: var(--spacing-lg);
            max-height: 70vh;
            overflow-y: auto;
        }

        /* Workflow Library Styles */
        .library-filters {
            display: flex;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
        }

        .library-search {
            flex: 1;
            padding: var(--spacing-sm) var(--spacing-md);
            border: 2px solid var(--border-primary);
            border-radius: var(--radius-md);
            background: var(--background-primary);
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .library-search:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        .library-category-filter {
            padding: var(--spacing-sm) var(--spacing-md);
            border: 2px solid var(--border-primary);
            border-radius: var(--radius-md);
            background: var(--background-primary);
            color: var(--text-primary);
            font-size: 0.9rem;
            min-width: 150px;
        }

        .library-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: var(--spacing-lg);
        }

        .library-item {
            background: var(--background-primary);
            border: 2px solid var(--border-primary);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            cursor: pointer;
            transition: all var(--transition-normal);
            position: relative;
            overflow: hidden;
        }

        .library-item:hover {
            border-color: var(--accent-color);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 122, 255, 0.15);
        }

        .library-item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--spacing-md);
        }

        .library-item-header h4 {
            margin: 0;
            color: var(--text-primary);
            font-size: 1.1rem;
            font-weight: 600;
            line-height: 1.3;
        }

        .status-badge {
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: var(--radius-sm);
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-badge.active {
            background: var(--success-color);
            color: var(--text-white);
        }

        .status-badge.draft {
            background: var(--warning-color);
            color: var(--text-white);
        }

        .library-item-details {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
        }

        .detail-item {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .detail-item .material-icons {
            font-size: 1rem;
            color: var(--accent-color);
        }

        /* Export Modal Styles */
        .export-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--spacing-lg);
        }

        .export-option {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            padding: var(--spacing-lg);
            border: 2px solid var(--border-primary);
            border-radius: var(--radius-lg);
            background: var(--background-primary);
            cursor: pointer;
            transition: all var(--transition-normal);
        }

        .export-option:hover {
            border-color: var(--accent-color);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 122, 255, 0.15);
        }

        .export-option .material-icons {
            font-size: 2.5rem;
            color: var(--accent-color);
        }

        .export-option-text h4 {
            margin: 0 0 var(--spacing-xs) 0;
            color: var(--text-primary);
            font-size: 1.1rem;
            font-weight: 600;
        }

        .export-option-text p {
            margin: 0;
            color: var(--text-secondary);
            font-size: 0.875rem;
            line-height: 1.4;
        }

        /* Notification Panel Styles */
        .notification-panel {
            top: auto;
            bottom: 0;
            right: 0;
            width: 400px;
            height: auto;
            max-height: 80vh;
            background: var(--background-primary);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-lg) var(--radius-lg) 0 0;
            box-shadow: 0 -10px 40px rgba(0, 0, 0, 0.2);
            transform: translateY(100%);
        }

        .notification-panel.show {
            transform: translateY(0);
        }

        .notification-panel-header {
            background: var(--background-tertiary);
            padding: var(--spacing-lg);
            border-bottom: 1px solid var(--border-primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .notification-panel-header h3 {
            margin: 0;
            color: var(--text-primary);
            font-size: 1.25rem;
            font-weight: 600;
        }

        .notification-panel-content {
            padding: var(--spacing-md);
            max-height: 400px;
            overflow-y: auto;
        }

        .notification-item {
            display: flex;
            gap: var(--spacing-md);
            padding: var(--spacing-md);
            border-radius: var(--radius-md);
            margin-bottom: var(--spacing-sm);
            transition: var(--transition-fast);
        }

        .notification-item:hover {
            background: var(--background-tertiary);
        }

        .notification-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-white);
            flex-shrink: 0;
        }

        .notification-item.success .notification-icon {
            background: var(--success-color);
        }

        .notification-item.warning .notification-icon {
            background: var(--warning-color);
        }

        .notification-item.info .notification-icon {
            background: var(--info-color);
        }

        .notification-item.error .notification-icon {
            background: var(--error-color);
        }

        .notification-content {
            flex: 1;
        }

        .notification-title {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: var(--spacing-xs);
            font-size: 0.9rem;
        }

        .notification-message {
            color: var(--text-secondary);
            font-size: 0.875rem;
            line-height: 1.4;
            margin-bottom: var(--spacing-xs);
        }

        .notification-time {
            color: var(--text-light);
            font-size: 0.75rem;
        }

        .notification-panel-footer {
            padding: var(--spacing-lg);
            border-top: 1px solid var(--border-primary);
            background: var(--background-tertiary);
        }

        /* Search Suggestions Styles */
        .search-suggestion {
            padding: var(--spacing-sm) var(--spacing-md);
            cursor: pointer;
            transition: var(--transition-fast);
            border-bottom: 1px solid var(--border-primary);
        }

        .search-suggestion:hover {
            background: var(--background-tertiary);
        }

        .search-suggestion:last-child {
            border-bottom: none;
        }

        /* Enhanced Notification Styles */
        .enhanced-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--background-primary);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            z-index: 10000;
            min-width: 320px;
            max-width: 420px;
            display: flex;
            align-items: flex-start;
            gap: var(--spacing-md);
            transform: translateX(100%);
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(10px);
        }

        .enhanced-notification.show {
            transform: translateX(0);
            opacity: 1;
        }

        .enhanced-notification.hiding {
            transform: translateX(100%);
            opacity: 0;
        }

        .enhanced-notification.success {
            border-left: 4px solid var(--success-color);
            background: linear-gradient(135deg, var(--background-primary) 0%, rgba(34, 197, 94, 0.05) 100%);
        }

        .enhanced-notification.error {
            border-left: 4px solid var(--error-color);
            background: linear-gradient(135deg, var(--background-primary) 0%, rgba(239, 68, 68, 0.05) 100%);
        }

        .enhanced-notification.warning {
            border-left: 4px solid var(--warning-color);
            background: linear-gradient(135deg, var(--background-primary) 0%, rgba(245, 158, 11, 0.05) 100%);
        }

        .enhanced-notification.info {
            border-left: 4px solid var(--info-color);
            background: linear-gradient(135deg, var(--background-primary) 0%, rgba(59, 130, 246, 0.05) 100%);
        }

        .notification-icon {
            flex-shrink: 0;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-white);
        }

        .enhanced-notification.success .notification-icon {
            background: var(--success-color);
        }

        .enhanced-notification.error .notification-icon {
            background: var(--error-color);
        }

        .enhanced-notification.warning .notification-icon {
            background: var(--warning-color);
        }

        .enhanced-notification.info .notification-icon {
            background: var(--info-color);
        }

        .notification-content {
            flex: 1;
        }

        .notification-title {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: var(--spacing-xs);
            font-size: 0.95rem;
        }

        .notification-message {
            color: var(--text-secondary);
            font-size: 0.875rem;
            line-height: 1.4;
        }

        .notification-close {
            background: none;
            border: none;
            color: var(--text-light);
            cursor: pointer;
            padding: var(--spacing-xs);
            border-radius: var(--radius-sm);
            transition: var(--transition-fast);
            flex-shrink: 0;
            margin-left: var(--spacing-sm);
        }

        .notification-close:hover {
            background: var(--background-tertiary);
            color: var(--text-primary);
        }

        .notification-progress {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 0 0 var(--radius-lg) var(--radius-lg);
            overflow: hidden;
        }

        .notification-progress-fill {
            height: 100%;
            background: var(--accent-color);
            transition: width linear;
        }

        .enhanced-notification.success .notification-progress-fill {
            background: var(--success-color);
        }

        .enhanced-notification.error .notification-progress-fill {
            background: var(--error-color);
        }

        .enhanced-notification.warning .notification-progress-fill {
            background: var(--warning-color);
        }

        /* Dark Theme Support */
        .dark-theme {
            --background-primary: #1a1a1a;
            --background-secondary: #2d2d2d;
            --background-tertiary: #3a3a3a;
            --text-primary: #ffffff;
            --text-secondary: #cccccc;
            --text-light: #999999;
            --border-primary: #404040;
            --border-secondary: #505050;
        }

        /* Responsive Design for Modals */
        @media (max-width: 768px) {
            .modal-content {
                max-width: 95vw;
                max-height: 95vh;
            }

            .library-grid {
                grid-template-columns: 1fr;
            }

            .export-options {
                grid-template-columns: 1fr;
            }

            .notification-panel {
                width: 100%;
                right: 0;
            }

            .library-filters {
                flex-direction: column;
            }

            /* Mobile notification styles */
            .enhanced-notification {
                top: 10px;
                right: 10px;
                left: 10px;
                min-width: auto;
                max-width: none;
                transform: translateY(-100%);
            }

            .enhanced-notification.show {
                transform: translateY(0);
            }

            .enhanced-notification.hiding {
                transform: translateY(-100%);
            }
        }
    </style>
</head>

<body>
    <!-- Enhanced Header -->
    <header class="header enhanced-header">
        <div class="header-content">
            <div class="header-title">
                <div class="logo-container">
                    <span class="material-icons logo-icon">account_tree</span>
                    <div class="title-text">
                        <h1>Workflow Management</h1>
                        <div class="header-subtitle">Design, Configure & Visualize Business Workflows</div>
                    </div>
                </div>
            </div>
            <div class="header-center">
                <div class="search-container enhanced-search">
                    <span class="material-icons search-icon" style="top: 50%;">search</span>
                    <input type="text" id="globalSearch" placeholder="Search workflows, steps, actions..."
                        class="global-search">
                    <button class="search-clear" onclick="clearGlobalSearch()" style="display: none;">
                        <span class="material-icons">clear</span>
                    </button>
                    <div class="search-suggestions" id="searchSuggestions" style="display: none;">
                        <!-- Search suggestions will appear here -->
                    </div>
                </div>
            </div>
            <div class="header-actions">
                <button class="btn btn-icon theme-toggle" onclick="toggleTheme()" title="Toggle Theme">
                    <span class="material-icons" id="themeIcon">dark_mode</span>
                </button>
                <button class="btn btn-icon" onclick="toggleFullscreen()" title="Fullscreen">
                    <span class="material-icons">fullscreen</span>
                </button>
                <button class="btn btn-icon" onclick="showNotifications()" title="Notifications">
                    <span class="material-icons">notifications</span>
                    <div class="notification-badge">3</div>
                </button>
                <button class="btn btn-secondary" onclick="showWorkflowLibrary()">
                    <span class="material-icons">library_books</span>
                    Library
                </button>
                <button class="btn btn-secondary" onclick="showHelp()">
                    <span class="material-icons">help_outline</span>
                    Help
                </button>
                <div class="user-menu" onclick="toggleUserMenu()">
                    <div class="user-avatar">
                        <span class="material-icons">person</span>
                    </div>
                    <div class="user-info">
                        <div class="user-name">John Doe</div>
                        <div class="user-role">Admin</div>
                    </div>
                    <span class="material-icons">expand_more</span>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Container -->
    <main class="main-container">
        <!-- Dashboard Cards -->
        <div class="dashboard-grid">
            <div class="dashboard-card" onclick="showWorkflowList()">
                <div class="dashboard-card-header">
                    <div class="dashboard-card-title">Active Workflows</div>
                    <div class="dashboard-card-icon" style="background: var(--success-color);">
                        <span class="material-icons">play_arrow</span>
                    </div>
                </div>
                <div class="dashboard-card-value">24</div>
                <div class="dashboard-card-subtitle">Currently running</div>
            </div>

            <div class="dashboard-card" onclick="showQueueManagement()">
                <div class="dashboard-card-header">
                    <div class="dashboard-card-title">Pending Tasks</div>
                    <div class="dashboard-card-icon" style="background: var(--warning-color);">
                        <span class="material-icons">pending_actions</span>
                    </div>
                </div>
                <div class="dashboard-card-value">156</div>
                <div class="dashboard-card-subtitle">Awaiting action</div>
            </div>

            <div class="dashboard-card" onclick="showCompletedTasks()">
                <div class="dashboard-card-header">
                    <div class="dashboard-card-title">Completed Today</div>
                    <div class="dashboard-card-icon" style="background: var(--info-color);">
                        <span class="material-icons">task_alt</span>
                    </div>
                </div>
                <div class="dashboard-card-value">89</div>
                <div class="dashboard-card-subtitle">Tasks finished</div>
            </div>

            <div class="dashboard-card" onclick="showAnalytics()">
                <div class="dashboard-card-header">
                    <div class="dashboard-card-title">Efficiency Rate</div>
                    <div class="dashboard-card-icon" style="background: var(--accent-color);">
                        <span class="material-icons">trending_up</span>
                    </div>
                </div>
                <div class="dashboard-card-value">94%</div>
                <div class="dashboard-card-subtitle">This month</div>
            </div>
        </div>

        <!-- Advanced Search -->
        <div class="search-container">
            <span class="material-icons search-icon">search</span>
            <input type="text" class="search-input" placeholder="Search workflows, tasks, or users..."
                id="globalSearch">
            <div class="search-filters">
                <div class="filter-chip active" onclick="toggleFilter(this, 'all')">All</div>
                <div class="filter-chip" onclick="toggleFilter(this, 'active')">Active</div>
                <div class="filter-chip" onclick="toggleFilter(this, 'pending')">Pending</div>
                <div class="filter-chip" onclick="toggleFilter(this, 'completed')">Completed</div>
                <div class="filter-chip" onclick="toggleFilter(this, 'overdue')">Overdue</div>
                <div class="filter-chip" onclick="toggleFilter(this, 'my-tasks')">My Tasks</div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons">
            <button class="btn btn-primary" onclick="showWorkflowConfiguration()">
                <span class="material-icons">settings</span>
                Configure Workflow
            </button>
            <button class="btn btn-secondary" onclick="refreshData()">
                <span class="material-icons">refresh</span>
                Refresh
            </button>
        </div>



        <!-- Enhanced Workflow Configuration Panel -->
        <div class="workflow-config-panel" id="workflowConfigPanel" style="display: block;">
            <div class="workflow-config-header">
                <div
                    style="font-weight: 600; color: var(--text-primary); display: flex; align-items: center; gap: var(--spacing-sm);">
                    <span class="material-icons">settings</span>
                    Enhanced Workflow Configuration
                </div>
                <div style="display: flex; gap: var(--spacing-sm);">
                    <button class="btn btn-secondary" onclick="importExcelData()">
                        <span class="material-icons">upload_file</span>
                        Import Excel
                    </button>
                    <button class="btn btn-secondary" onclick="clearConfiguration()">
                        <span class="material-icons">clear_all</span>
                        Clear All
                    </button>
                </div>
            </div>
            <div class="workflow-config-content">
                <!-- Enhanced Step Template Selector -->
                <div class="step-template-selector">
                    <label class="form-label"
                        style="font-size: 1.1rem; font-weight: 600; margin-bottom: var(--spacing-md);">
                        <span class="material-icons"
                            style="vertical-align: middle; margin-right: var(--spacing-xs);">library_books</span>
                        Quick Start Templates
                    </label>
                    <div class="template-options"
                        style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--spacing-sm);">
                        <div class="template-option enhanced-template" onclick="loadQuickTemplate('warranty')"
                            data-template="warranty">
                            <div class="template-icon-wrapper">
                                <span class="material-icons">build</span>
                            </div>
                            <div class="template-info">
                                <div class="template-name">Warranty Claim</div>
                                <div class="template-desc">Multi-level approval process</div>
                            </div>
                        </div>
                        <div class="template-option enhanced-template" onclick="loadQuickTemplate('approval')"
                            data-template="approval">
                            <div class="template-icon-wrapper">
                                <span class="material-icons">thumb_up</span>
                            </div>
                            <div class="template-info">
                                <div class="template-name">Approval Process</div>
                                <div class="template-desc">Simple approval workflow</div>
                            </div>
                        </div>
                        <div class="template-option enhanced-template" onclick="loadQuickTemplate('review')"
                            data-template="review">
                            <div class="template-icon-wrapper">
                                <span class="material-icons">rate_review</span>
                            </div>
                            <div class="template-info">
                                <div class="template-name">Review Process</div>
                                <div class="template-desc">Peer and manager review</div>
                            </div>
                        </div>
                        <div class="template-option enhanced-template" onclick="loadQuickTemplate('escalation')"
                            data-template="escalation">
                            <div class="template-icon-wrapper">
                                <span class="material-icons">trending_up</span>
                            </div>
                            <div class="template-info">
                                <div class="template-name">Escalation Process</div>
                                <div class="template-desc">Multi-tier support escalation</div>
                            </div>
                        </div>
                        <div class="template-option enhanced-template" onclick="loadQuickTemplate('custom')"
                            data-template="custom">
                            <div class="template-icon-wrapper">
                                <span class="material-icons">add_circle</span>
                            </div>
                            <div class="template-info">
                                <div class="template-name">Custom Process</div>
                                <div class="template-desc">Start from scratch</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Enhanced Configuration Form -->
                <div class="config-form-container">
                    <div class="config-form-header">
                        <h3 style="margin: 0; display: flex; align-items: center; gap: var(--spacing-sm);">
                            <span class="material-icons">account_tree</span>
                            Workflow Steps Configuration
                        </h3>
                        <div class="config-stats" id="configStats">
                            <span class="stat-item">
                                <span class="material-icons">layers</span>
                                <span id="stepCount">0</span> Steps
                            </span>
                            <span class="stat-item">
                                <span class="material-icons">link</span>
                                <span id="connectionCount">0</span> Connections
                            </span>
                        </div>
                    </div>

                    <!-- Enhanced Configuration Table -->
                    <div class="config-table-wrapper">
                        <table class="config-table enhanced-table" id="configTable">
                            <thead>
                                <tr>
                                    <th style="width: 18%;">
                                        <span class="material-icons">play_arrow</span>
                                        From Step
                                    </th>
                                    <th style="width: 18%;">
                                        <span class="material-icons">flag</span>
                                        To Step
                                    </th>
                                    <th style="width: 20%;">
                                        <span class="material-icons">touch_app</span>
                                        Action
                                    </th>
                                    <th style="width: 20%;">
                                        <span class="material-icons">group</span>
                                        Assigned Team/Role
                                    </th>
                                    <th style="width: 12%;">
                                        <span class="material-icons">category</span>
                                        Step Type
                                    </th>
                                    <th style="width: 8%;">
                                        <span class="material-icons">notifications</span>
                                        Notify
                                    </th>
                                    <th style="width: 4%;">
                                        <span class="material-icons">more_vert</span>
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="configTableBody">
                                <!-- Configuration rows will be added here -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Enhanced Add Row Button -->
                    <div class="add-row-section">
                        <button class="btn btn-secondary add-row-btn" onclick="addConfigRow()">
                            <span class="material-icons">add</span>
                            Add New Step
                        </button>
                    </div>
                </div>

                <!-- Enhanced Generation Controls -->
                <div class="generation-controls enhanced-controls">
                    <div class="generation-status-wrapper">
                        <div class="generation-status" id="generationStatus">
                            <span class="material-icons status-icon">info</span>
                            Configure workflow steps above to see live workflow preview below
                        </div>
                    </div>
                    <div class="generation-actions">
                        <button class="btn btn-secondary" onclick="validateConfiguration()">
                            <span class="material-icons">check_circle</span>
                            Validate
                        </button>
                        <button class="btn btn-secondary" onclick="previewConfiguration()">
                            <span class="material-icons">visibility</span>
                            Preview Details
                        </button>
                        <button class="btn btn-secondary" onclick="clearConfiguration()">
                            <span class="material-icons">clear_all</span>
                            Clear All
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Live Workflow Preview -->
        <div class="live-workflow-preview" id="liveWorkflowPreview">
            <div class="live-preview-header">
                <div class="live-preview-title">
                    <span class="material-icons">visibility</span>
                    Live Workflow Preview
                </div>
                <div class="live-preview-stats" id="livePreviewStats">
                    <span class="stat-item">
                        <span class="material-icons">layers</span>
                        <span id="liveStepCount">0</span> Steps
                    </span>
                    <span class="stat-item">
                        <span class="material-icons">link</span>
                        <span id="liveConnectionCount">0</span> Connections
                    </span>
                </div>
            </div>
            <div class="live-preview-content" id="livePreviewContent">
                <div class="empty-state" id="emptyState">
                    <span class="material-icons">account_tree</span>
                    <div class="empty-state-title">No Workflow Steps Configured</div>
                    <div class="empty-state-description">Add workflow steps in the configuration table above to see the
                        live preview</div>
                </div>

                <!-- Live Workflow Canvas -->
                <div class="live-workflow-canvas" id="liveWorkflowCanvas" style="display: none;">
                    <!-- Auto-generated workflow steps will appear here -->
                </div>
            </div>
        </div>
        </div>
        </div>

        <!-- Workflow Designer -->
        <div class="workflow-designer" id="workflowDesigner" style="display: none;">
            <div class="workflow-designer-header">
                <div class="workflow-designer-title">Workflow Designer - Auto-Generated Process</div>
                <div style="display: flex; gap: var(--spacing-sm);">
                    <button class="btn btn-secondary" onclick="showConfiguration()">
                        <span class="material-icons">settings</span>
                        Configure
                    </button>
                    <button class="btn btn-secondary" onclick="regenerateWorkflow()">
                        <span class="material-icons">refresh</span>
                        Regenerate
                    </button>
                    <button class="btn btn-secondary" onclick="saveWorkflow()">
                        <span class="material-icons">save</span>
                        Save
                    </button>
                    <button class="btn btn-secondary" onclick="previewWorkflow()">
                        <span class="material-icons">visibility</span>
                        Preview
                    </button>
                    <button class="btn btn-secondary" onclick="closeDesigner()">
                        <span class="material-icons">close</span>
                        Close
                    </button>
                </div>
            </div>
            <div class="workflow-canvas" id="workflowCanvas">
                <!-- Canvas Tools -->
                <div class="canvas-tools">
                    <div class="canvas-tool tooltip active" data-tooltip="Select Tool" onclick="setCanvasTool('select')"
                        id="selectTool">
                        <span class="material-icons">near_me</span>
                    </div>
                    <div class="canvas-tool tooltip" data-tooltip="Connection Tool" onclick="setCanvasTool('connect')"
                        id="connectTool">
                        <span class="material-icons">timeline</span>
                    </div>
                    <div class="canvas-tool tooltip" data-tooltip="Pan Tool" onclick="setCanvasTool('pan')"
                        id="panTool">
                        <span class="material-icons">pan_tool</span>
                    </div>
                    <div class="canvas-tool tooltip" data-tooltip="Auto Layout" onclick="autoLayoutWorkflow()">
                        <span class="material-icons">auto_fix_high</span>
                    </div>
                    <div class="canvas-tool tooltip" data-tooltip="Fit to Screen" onclick="fitToScreen()">
                        <span class="material-icons">fit_screen</span>
                    </div>
                </div>

                <!-- Zoom Controls -->
                <div class="zoom-controls">
                    <div class="zoom-control tooltip" data-tooltip="Zoom In" onclick="zoomCanvas(1.2)">
                        <span class="material-icons">add</span>
                    </div>
                    <div class="zoom-level" id="zoomLevel">100%</div>
                    <div class="zoom-control tooltip" data-tooltip="Zoom Out" onclick="zoomCanvas(0.8)">
                        <span class="material-icons">remove</span>
                    </div>
                    <div class="zoom-control tooltip" data-tooltip="Reset Zoom" onclick="resetZoom()">
                        <span class="material-icons">center_focus_strong</span>
                    </div>
                </div>

                <!-- Mini Map -->
                <div class="mini-map" id="miniMap">
                    <div class="mini-map-content">
                        <div class="mini-map-viewport" id="miniMapViewport"></div>
                    </div>
                </div>

                <!-- SVG for connection lines -->
                <svg id="connectionSvg"
                    style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;">
                    <defs>
                        <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                            <polygon points="0 0, 10 3.5, 0 7" fill="var(--accent-color)" />
                        </marker>
                        <marker id="arrowhead-success" markerWidth="10" markerHeight="7" refX="9" refY="3.5"
                            orient="auto">
                            <polygon points="0 0, 10 3.5, 0 7" fill="var(--success-color)" />
                        </marker>
                        <marker id="arrowhead-error" markerWidth="10" markerHeight="7" refX="9" refY="3.5"
                            orient="auto">
                            <polygon points="0 0, 10 3.5, 0 7" fill="var(--error-color)" />
                        </marker>
                    </defs>
                </svg>

                <!-- Connection Preview SVG -->
                <svg id="connectionPreview" class="connection-preview"
                    style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: none;">
                    <path class="connection-preview-line" />
                </svg>

                <!-- Workflow Steps -->
                <div class="workflow-step step-type-begin" id="step1" style="top: 50px; left: 50px;" data-step-id="1">
                    <!-- Connection Handles -->
                    <div class="connection-handle output" data-handle="output" onclick="startConnection(this)"></div>
                    <div class="connection-handle bottom" data-handle="bottom" onclick="startConnection(this)"></div>

                    <!-- Status Indicator -->
                    <div class="step-status-indicator completed">
                        <span class="material-icons" style="font-size: 0.75rem;">check</span>
                    </div>

                    <div class="step-content">
                        <div class="step-header">
                            <div class="step-type begin">Begin</div>
                            <span class="material-icons" style="cursor: pointer; color: var(--text-light);"
                                onclick="editStep(1)">edit</span>
                        </div>
                        <div class="step-title">Initiated (Orlando)</div>
                        <div class="step-status">Created</div>
                        <div class="step-actions">
                            <div class="step-action">Request for Warranty Claim</div>
                        </div>
                        <div style="margin-top: var(--spacing-sm); font-size: 0.75rem; color: var(--text-light);">
                            Role: Co-Ordinator - Orlando
                        </div>
                    </div>

                    <!-- Progress Bar -->
                    <div class="step-progress">
                        <div class="step-progress-fill" style="width: 100%;"></div>
                    </div>
                </div>

                <div class="workflow-step step-type-intermediate" id="step2" style="top: 50px; left: 300px;"
                    data-step-id="2">
                    <!-- Connection Handles -->
                    <div class="connection-handle input" data-handle="input" onclick="startConnection(this)"></div>
                    <div class="connection-handle output" data-handle="output" onclick="startConnection(this)"></div>
                    <div class="connection-handle bottom" data-handle="bottom" onclick="startConnection(this)"></div>

                    <!-- Status Indicator -->
                    <div class="step-status-indicator in-progress">
                        <span class="material-icons" style="font-size: 0.75rem;">sync</span>
                    </div>

                    <div class="step-content">
                        <div class="step-header">
                            <div class="step-type intermediate">Intermediate</div>
                            <span class="material-icons" style="cursor: pointer; color: var(--text-light);"
                                onclick="editStep(2)">edit</span>
                        </div>
                        <div class="step-title">Branch Manager Review</div>
                        <div class="step-status">Pending for Branch Manager Approval</div>
                        <div class="step-actions">
                            <div class="step-action">Review and Approve</div>
                            <div class="step-action">Adjust and Approve</div>
                            <div class="step-action">Reject</div>
                        </div>
                        <div style="margin-top: var(--spacing-sm); font-size: 0.75rem; color: var(--text-light);">
                            Role: Branch Mgr - Orlando
                        </div>
                    </div>

                    <!-- Progress Bar -->
                    <div class="step-progress">
                        <div class="step-progress-fill" style="width: 65%;"></div>
                    </div>
                </div>

                <div class="workflow-step step-type-intermediate" id="step3" style="top: 200px; left: 300px;"
                    data-step-id="3">
                    <!-- Connection Handles -->
                    <div class="connection-handle input" data-handle="input" onclick="startConnection(this)"></div>
                    <div class="connection-handle output" data-handle="output" onclick="startConnection(this)"></div>
                    <div class="connection-handle bottom" data-handle="bottom" onclick="startConnection(this)"></div>

                    <!-- Status Indicator -->
                    <div class="step-status-indicator pending">
                        <span class="material-icons" style="font-size: 0.75rem;">schedule</span>
                    </div>

                    <div class="step-content">
                        <div class="step-header">
                            <div class="step-type intermediate">Intermediate</div>
                            <span class="material-icons" style="cursor: pointer; color: var(--text-light);"
                                onclick="editStep(3)">edit</span>
                        </div>
                        <div class="step-title">Warranty Supervisor Review</div>
                        <div class="step-status">Pending for Warranty Sup. Approval</div>
                        <div class="step-actions">
                            <div class="step-action">Review and Approve</div>
                            <div class="step-action">Adjust and Approve</div>
                            <div class="step-action">Reject</div>
                        </div>
                        <div style="margin-top: var(--spacing-sm); font-size: 0.75rem; color: var(--text-light);">
                            Role: Warranty Supervisor - Orlando
                        </div>
                    </div>

                    <!-- Progress Bar -->
                    <div class="step-progress">
                        <div class="step-progress-fill" style="width: 30%;"></div>
                    </div>
                </div>

                <div class="workflow-step step-type-end" id="step4" style="top: 50px; left: 550px;" data-step-id="4">
                    <!-- Connection Handles -->
                    <div class="connection-handle input" data-handle="input" onclick="startConnection(this)"></div>

                    <!-- Status Indicator -->
                    <div class="step-status-indicator error">
                        <span class="material-icons" style="font-size: 0.75rem;">close</span>
                    </div>

                    <div class="step-content">
                        <div class="step-header">
                            <div class="step-type end">End</div>
                            <span class="material-icons" style="cursor: pointer; color: var(--text-light);"
                                onclick="editStep(4)">edit</span>
                        </div>
                        <div class="step-title">Rejected</div>
                        <div class="step-status">Rejected</div>
                        <div class="step-actions">
                            <div class="step-action">Rejected</div>
                        </div>
                    </div>

                    <!-- Progress Bar -->
                    <div class="step-progress">
                        <div class="step-progress-fill" style="width: 100%; background: var(--error-color);"></div>
                    </div>
                </div>

                <div class="workflow-step step-type-intermediate" id="step5" style="top: 350px; left: 300px;"
                    data-step-id="5">
                    <!-- Connection Handles -->
                    <div class="connection-handle input" data-handle="input" onclick="startConnection(this)"></div>
                    <div class="connection-handle output" data-handle="output" onclick="startConnection(this)"></div>
                    <div class="connection-handle top" data-handle="top" onclick="startConnection(this)"></div>

                    <!-- Status Indicator -->
                    <div class="step-status-indicator pending">
                        <span class="material-icons" style="font-size: 0.75rem;">schedule</span>
                    </div>

                    <div class="step-content">
                        <div class="step-header">
                            <div class="step-type intermediate">Intermediate</div>
                            <span class="material-icons" style="cursor: pointer; color: var(--text-light);"
                                onclick="editStep(5)">edit</span>
                        </div>
                        <div class="step-title">ADM Manager Review</div>
                        <div class="step-status">Pending for Warranty ADM Mgr. Approval</div>
                        <div class="step-actions">
                            <div class="step-action">Review and Approve</div>
                            <div class="step-action">Adjust and Approve</div>
                            <div class="step-action">Reject</div>
                        </div>
                        <div style="margin-top: var(--spacing-sm); font-size: 0.75rem; color: var(--text-light);">
                            Role: Warranty ADM Manager - Orlando
                        </div>
                    </div>

                    <!-- Progress Bar -->
                    <div class="step-progress">
                        <div class="step-progress-fill" style="width: 15%;"></div>
                    </div>
                </div>

                <div class="workflow-step step-type-end" id="step6" style="top: 350px; left: 550px;" data-step-id="6">
                    <!-- Connection Handles -->
                    <div class="connection-handle input" data-handle="input" onclick="startConnection(this)"></div>

                    <!-- Status Indicator -->
                    <div class="step-status-indicator completed">
                        <span class="material-icons" style="font-size: 0.75rem;">check</span>
                    </div>

                    <div class="step-content">
                        <div class="step-header">
                            <div class="step-type end">End</div>
                            <span class="material-icons" style="cursor: pointer; color: var(--text-light);"
                                onclick="editStep(6)">edit</span>
                        </div>
                        <div class="step-title">Completed</div>
                        <div class="step-status">Approved</div>
                        <div class="step-actions">
                            <div class="step-action">Final Approval</div>
                        </div>
                    </div>

                    <!-- Progress Bar -->
                    <div class="step-progress">
                        <div class="step-progress-fill" style="width: 100%;"></div>
                    </div>
                </div>
            </div>
        </div>


    </main>



    <!-- Footer -->
    <footer class="footer">
        <p>&copy; 2024 Multi-Tenant SaaS Workflow Management. All rights reserved.</p>
    </footer>

    <!-- Floating Action Button -->
    <button class="fab" onclick="showQuickActions()" id="fab">
        <span class="material-icons">add</span>
    </button>

    <!-- Context Menu -->
    <div class="context-menu" id="contextMenu">
        <div class="context-menu-item" onclick="duplicateStep()">
            <span class="material-icons">content_copy</span>
            Duplicate Step
        </div>
        <div class="context-menu-item" onclick="editStep()">
            <span class="material-icons">edit</span>
            Edit Step
        </div>
        <div class="context-menu-separator"></div>
        <div class="context-menu-item" onclick="addConnection()">
            <span class="material-icons">link</span>
            Add Connection
        </div>
        <div class="context-menu-item" onclick="removeConnection()">
            <span class="material-icons">link_off</span>
            Remove Connection
        </div>
        <div class="context-menu-separator"></div>
        <div class="context-menu-item" onclick="deleteStep()" style="color: var(--error-color);">
            <span class="material-icons">delete</span>
            Delete Step
        </div>
    </div>

    <!-- Enhanced Notification -->
    <div class="notification" id="notification">
        <div class="notification-header">
            <div class="notification-title" id="notificationTitle">Notification</div>
            <button class="notification-close" onclick="closeNotification()">
                <span class="material-icons">close</span>
            </button>
        </div>
        <div class="notification-content" id="notificationContent"></div>
        <div class="progress-bar" id="notificationProgress" style="display: none;">
            <div class="progress-fill" id="notificationProgressFill"></div>
        </div>
    </div>

    <script>
        // Global variables
        let currentWorkflow = null;
        let selectedStep = null;
        let isDragging = false;
        let dragOffset = { x: 0, y: 0 };
        let connections = [];

        // Sample workflow data based on your Excel data
        const workflowData = {
            "Warranty Claim": {
                company: "Prevost Car",
                branchCode: "177M",
                steps: [
                    {
                        id: 1,
                        name: "Initiated(Orlando)",
                        type: "Begin",
                        status: "Created",
                        actions: ["Request for Warranty Claim"],
                        role: "Co-Ordinator - Orlando",
                        position: { x: 50, y: 50 }
                    },
                    {
                        id: 2,
                        name: "Moved to Branch Mgr(Orlando)",
                        type: "InterMediate",
                        status: "Pending for Branch Manager Approval",
                        actions: ["Review and Approve", "Adjusted and Approved", "Rejected"],
                        role: "Branch Mgr - Orlando",
                        position: { x: 300, y: 50 }
                    }
                ],
                connections: [
                    { from: 1, to: 2, action: "Request for Warranty Claim" },
                    { from: 2, to: 4, action: "Rejected" },
                    { from: 2, to: 3, action: "Review and Approve" }
                ]
            }
        };

        // Enhanced global variables
        let currentView = 'dashboard';
        let searchFilters = ['all'];
        let stepCounter = 7;
        let notificationQueue = [];
        let isStepPaletteOpen = false;
        let contextMenuTarget = null;
        let currentCanvasTool = 'select';
        let isConnecting = false;
        let connectionSource = null;
        let canvasZoom = 1;
        let canvasOffset = { x: 0, y: 0 };
        let connectionPreviewActive = false;
        let workflowConfiguration = [];
        let generatedSteps = [];
        let autoStepCounter = 1;

        // Predefined workflow options for dropdowns
        const workflowSteps = [
            'Start',
            'Initiated',
            'Draft',
            'Submitted',
            'Under Review',
            'Pending Approval',
            'Manager Review',
            'Branch Manager Review',
            'Supervisor Review',
            'ADM Manager Review',
            'Finance Review',
            'Legal Review',
            'Technical Review',
            'Quality Check',
            'Final Review',
            'Approved',
            'Rejected',
            'On Hold',
            'Escalated',
            'Completed',
            'Closed',
            'Cancelled',
            'Returned',
            'Resubmitted'
        ];

        const workflowActions = [
            'Submit',
            'Submit Request',
            'Submit for Review',
            'Approve',
            'Reject',
            'Review',
            'Escalate',
            'Forward',
            'Return',
            'Resubmit',
            'Accept',
            'Deny',
            'Hold',
            'Release',
            'Complete',
            'Cancel',
            'Close',
            'Assign',
            'Reassign',
            'Validate',
            'Verify',
            'Process',
            'Finalize'
        ];

        const workflowTeams = [
            'Finance Team',
            'IT Team',
            'HR Team',
            'Legal Team',
            'Operations Team',
            'Quality Team',
            'Management Team',
            'Co-Ordinator - Orlando',
            'Branch Mgr - Orlando',
            'Warranty Supervisor - Orlando',
            'Warranty ADM Manager - Orlando',
            'Customer Service',
            'Technical Support',
            'Sales Team',
            'Marketing Team',
            'Procurement Team',
            'Security Team',
            'Compliance Team'
        ];

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function () {
            initializeWorkflowDesigner();
            initializeSearch();
            drawEnhancedConnections();
            updateMiniMap();

            // Initialize with warranty template
            setTimeout(() => {
                loadQuickTemplate('warranty');
                showEnhancedNotification('Enhanced Workflow Management System loaded successfully!', 'System Ready', 'success');
            }, 500);

            // Initialize keyboard shortcuts
            initializeKeyboardShortcuts();

            // Set up periodic mini map updates
            setInterval(updateMiniMap, 2000);
        });

        // Dashboard functions
        function showWorkflowConfiguration() {
            currentView = 'configuration';
            hideAllViews();
            document.getElementById('workflowConfigPanel').style.display = 'block';
            showEnhancedNotification('Workflow configuration opened', 'Configure your workflow steps', 'info');
        }

        function refreshData() {
            showNotification('Refreshing data...', 'info');
            setTimeout(() => {
                updateConfigStats();
                showNotification('Data refreshed successfully!', 'success');
            }, 1000);
        }

        // Workflow Designer functions
        function initializeWorkflowDesigner() {
            const canvas = document.getElementById('workflowCanvas');
            const steps = canvas.querySelectorAll('.workflow-step');

            steps.forEach(step => {
                makeDraggable(step);
                step.addEventListener('click', function (e) {
                    if (!isDragging) {
                        selectStep(step);
                    }
                });
            });
        }

        function makeDraggable(element) {
            element.addEventListener('mousedown', function (e) {
                if (e.target.closest('.material-icons')) return; // Don't drag when clicking edit icon

                isDragging = true;
                element.classList.add('dragging');

                const rect = element.getBoundingClientRect();
                const canvasRect = document.getElementById('workflowCanvas').getBoundingClientRect();

                dragOffset.x = e.clientX - rect.left;
                dragOffset.y = e.clientY - rect.top;

                document.addEventListener('mousemove', handleDrag);
                document.addEventListener('mouseup', handleDragEnd);

                e.preventDefault();
            });
        }

        function handleDrag(e) {
            if (!isDragging || !document.querySelector('.dragging')) return;

            const element = document.querySelector('.dragging');
            const canvas = document.getElementById('workflowCanvas');
            const canvasRect = canvas.getBoundingClientRect();

            const x = e.clientX - canvasRect.left - dragOffset.x;
            const y = e.clientY - canvasRect.top - dragOffset.y;

            // Keep element within canvas bounds
            const maxX = canvas.offsetWidth - element.offsetWidth;
            const maxY = canvas.offsetHeight - element.offsetHeight;

            element.style.left = Math.max(0, Math.min(x, maxX)) + 'px';
            element.style.top = Math.max(0, Math.min(y, maxY)) + 'px';

            // Redraw connections
            drawConnections();
        }

        function handleDragEnd() {
            isDragging = false;
            const draggingElement = document.querySelector('.dragging');
            if (draggingElement) {
                draggingElement.classList.remove('dragging');
            }

            document.removeEventListener('mousemove', handleDrag);
            document.removeEventListener('mouseup', handleDragEnd);
        }

        function selectStep(step) {
            // Remove previous selection
            document.querySelectorAll('.workflow-step').forEach(s => s.classList.remove('selected'));

            // Select current step
            step.classList.add('selected');
            selectedStep = step;
        }

        function drawConnections() {
            // Use the enhanced connection drawing
            drawEnhancedConnections();
        }

        // Step editing functions
        function editStep(stepId) {
            const step = document.querySelector(`[data-step-id="${stepId}"]`);
            if (step) {
                selectStep(step);
                openSidebar();
                populateStepForm(step);
            }
        }

        function openSidebar() {
            document.getElementById('stepEditSidebar').classList.add('open');
        }

        function closeSidebar() {
            document.getElementById('stepEditSidebar').classList.remove('open');
        }

        function populateStepForm(step) {
            const title = step.querySelector('.step-title').textContent;
            const status = step.querySelector('.step-status').textContent;
            const type = step.querySelector('.step-type').textContent.toLowerCase();

            document.getElementById('stepName').value = title;
            document.getElementById('stepStatus').value = status;
            document.getElementById('stepType').value = type;
        }

        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });

            // Remove active class from all tab buttons
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });

            // Show selected tab content
            document.getElementById(tabName + '-tab').classList.add('active');

            // Add active class to clicked tab button
            event.target.classList.add('active');
        }

        function addAction() {
            const actionsList = document.getElementById('actionsList');
            const actionDiv = document.createElement('div');
            actionDiv.style.display = 'flex';
            actionDiv.style.gap = 'var(--spacing-sm)';
            actionDiv.style.marginBottom = 'var(--spacing-sm)';
            actionDiv.innerHTML = `
                <input type="text" class="form-input" placeholder="Action name" style="flex: 1;">
                <button class="btn btn-danger" onclick="removeAction(this)">
                    <span class="material-icons">delete</span>
                </button>
            `;
            actionsList.appendChild(actionDiv);
        }

        function removeAction(button) {
            button.parentElement.remove();
        }

        function saveStepChanges() {
            showNotification('Step changes saved successfully!', 'success');
            closeSidebar();
        }

        function deleteStep() {
            if (confirm('Are you sure you want to delete this step?')) {
                if (selectedStep) {
                    selectedStep.remove();
                    drawConnections();
                    showNotification('Step deleted successfully!', 'success');
                    closeSidebar();
                }
            }
        }

        // Workflow functions
        function saveWorkflow() {
            showNotification('Workflow saved successfully!', 'success');
        }

        function previewWorkflow() {
            showNotification('Opening workflow preview...', 'info');
        }

        function closeDesigner() {
            document.getElementById('workflowDesigner').style.display = 'none';
            document.getElementById('queueContainer').style.display = 'grid';
        }

        // Queue functions
        function openWorkflowItem(itemId) {
            showNotification(`Opening workflow item: ${itemId}`, 'info');
        }

        // Workflow Configuration Functions

        function showWorkflowConfiguration() {
            currentView = 'configuration';
            hideAllViews();
            document.getElementById('workflowConfigPanel').style.display = 'block';

            // Initialize with sample data if empty
            if (workflowConfiguration.length === 0) {
                loadQuickTemplate('warranty');
            }

            showEnhancedNotification('Workflow configuration opened', 'Configure your workflow steps', 'info');
        }

        function showConfiguration() {
            showWorkflowConfiguration();
        }

        function addConfigRow() {
            const row = {
                id: Date.now(),
                fromStep: '',
                toStep: '',
                action: '',
                team: '',
                stepType: 'intermediate',
                notifications: false
            };

            workflowConfiguration.push(row);
            renderConfigurationTable();
            updateGenerationStatus();
            updateConfigStats();
            generateLiveWorkflowPreview();
            showEnhancedNotification('New row added', 'Configure the workflow step', 'success');

            // Focus on the first input of the new row
            setTimeout(() => {
                const newRowInputs = document.querySelectorAll('#configTableBody tr:last-child input');
                if (newRowInputs.length > 0) {
                    newRowInputs[0].focus();
                }
            }, 100);
        }

        async function removeConfigRow(id) {
            const result = await showCustomAlert(
                'Are you sure you want to remove this workflow step?',
                'Remove Step',
                'warning',
                ['Cancel', 'Remove']
            );

            if (result === 'Remove') {
                workflowConfiguration = workflowConfiguration.filter(row => row.id !== id);
                renderConfigurationTable();
                updateGenerationStatus();
                updateConfigStats();
                generateLiveWorkflowPreview();
                showEnhancedNotification('Row removed', 'Configuration updated', 'warning');
            }
        }

        function renderConfigurationTable() {
            const tbody = document.getElementById('configTableBody');
            tbody.innerHTML = '';

            workflowConfiguration.forEach((row, index) => {
                const tr = document.createElement('tr');
                tr.className = 'config-row-enter';
                tr.innerHTML = `
                    <td>
                        <input type="text" class="config-input" value="${row.fromStep}"
                               onchange="updateConfigRow(${row.id}, 'fromStep', this.value)"
                               placeholder="e.g., Start, Review, Initiated"
                               title="Enter the starting step name">
                    </td>
                    <td>
                        <input type="text" class="config-input" value="${row.toStep}"
                               onchange="updateConfigRow(${row.id}, 'toStep', this.value)"
                               placeholder="e.g., Approval, End, Completed"
                               title="Enter the destination step name">
                    </td>
                    <td>
                        <input type="text" class="config-input" value="${row.action}"
                               onchange="updateConfigRow(${row.id}, 'action', this.value)"
                               placeholder="e.g., Submit, Approve, Reject"
                               title="Enter the action that triggers this transition">
                    </td>
                    <td>
                        <select class="config-select" onchange="updateConfigRow(${row.id}, 'team', this.value)" title="Select the team or role responsible for this step">
                            <option value="">Select Team/Role</option>
                            <option value="Co-Ordinator - Orlando" ${row.team === 'Co-Ordinator - Orlando' ? 'selected' : ''}>Co-Ordinator - Orlando</option>
                            <option value="Branch Mgr - Orlando" ${row.team === 'Branch Mgr - Orlando' ? 'selected' : ''}>Branch Manager - Orlando</option>
                            <option value="Warranty Supervisor - Orlando" ${row.team === 'Warranty Supervisor - Orlando' ? 'selected' : ''}>Warranty Supervisor - Orlando</option>
                            <option value="Warranty ADM Manager - Orlando" ${row.team === 'Warranty ADM Manager - Orlando' ? 'selected' : ''}>Warranty ADM Manager - Orlando</option>
                            <option value="VP - Orlando" ${row.team === 'VP - Orlando' ? 'selected' : ''}>VP - Orlando</option>
                            <option value="Finance Team" ${row.team === 'Finance Team' ? 'selected' : ''}>Finance Team</option>
                            <option value="IT Team" ${row.team === 'IT Team' ? 'selected' : ''}>IT Team</option>
                            <option value="HR Team" ${row.team === 'HR Team' ? 'selected' : ''}>HR Team</option>
                            <option value="Quality Team" ${row.team === 'Quality Team' ? 'selected' : ''}>Quality Team</option>
                            <option value="Operations Team" ${row.team === 'Operations Team' ? 'selected' : ''}>Operations Team</option>
                        </select>
                    </td>
                    <td>
                        <select class="config-select" onchange="updateConfigRow(${row.id}, 'stepType', this.value)" title="Select the type of step">
                            <option value="begin" ${row.stepType === 'begin' ? 'selected' : ''}>Begin</option>
                            <option value="intermediate" ${row.stepType === 'intermediate' ? 'selected' : ''}>Intermediate</option>
                            <option value="end" ${row.stepType === 'end' ? 'selected' : ''}>End</option>
                            <option value="decision" ${row.stepType === 'decision' ? 'selected' : ''}>Decision</option>
                            <option value="approval" ${row.stepType === 'approval' ? 'selected' : ''}>Approval</option>
                        </select>
                    </td>
                    <td>
                        <select class="config-select" onchange="updateConfigRow(${row.id}, 'notifications', this.value === 'true')" title="Enable notifications for this step">
                            <option value="false" ${!row.notifications ? 'selected' : ''}>No</option>
                            <option value="true" ${row.notifications ? 'selected' : ''}>Yes</option>
                        </select>
                    </td>
                    <td>
                        <div class="row-actions">
                            <button class="row-btn add" onclick="addConfigRow()" title="Add New Row">
                                <span class="material-icons" style="font-size: 0.875rem;">add</span>
                            </button>
                            <button class="row-btn remove" onclick="removeConfigRow(${row.id})" title="Remove This Row">
                                <span class="material-icons" style="font-size: 0.875rem;">remove</span>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            // Update statistics
            updateConfigStats();
        }

        function updateConfigStats() {
            const stepCount = document.getElementById('stepCount');
            const connectionCount = document.getElementById('connectionCount');

            const uniqueSteps = new Set();
            workflowConfiguration.forEach(row => {
                if (row.fromStep) uniqueSteps.add(row.fromStep);
                if (row.toStep) uniqueSteps.add(row.toStep);
            });

            stepCount.textContent = uniqueSteps.size;
            connectionCount.textContent = workflowConfiguration.length;
        }

        function updateConfigRow(id, field, value) {
            const row = workflowConfiguration.find(r => r.id === id);
            if (row) {
                row[field] = value;
                updateGenerationStatus();
                updateConfigStats();
                // Auto-generate live workflow preview
                generateLiveWorkflowPreview();
            }
        }

        function updateGenerationStatus(type = null, message = null) {
            const status = document.getElementById('generationStatus');

            if (type && message) {
                // Custom message with type
                const icons = {
                    'info': 'info',
                    'success': 'check_circle',
                    'error': 'error',
                    'warning': 'warning'
                };

                status.innerHTML = `<span class="material-icons status-icon">${icons[type] || 'info'}</span>${message}`;
                status.className = `generation-status ${type}`;
                return;
            }

            // Default status based on configuration
            const validRows = workflowConfiguration.filter(row =>
                row.fromStep && row.toStep && row.action && row.team
            );

            if (validRows.length === 0) {
                status.innerHTML = '<span class="material-icons status-icon">info</span>Add workflow steps to generate diagram';
                status.className = 'generation-status';
            } else if (validRows.length < workflowConfiguration.length) {
                status.innerHTML = `<span class="material-icons status-icon">warning</span>${validRows.length} of ${workflowConfiguration.length} rows configured. Complete missing fields.`;
                status.className = 'generation-status error';
            } else {
                status.innerHTML = `<span class="material-icons status-icon">check_circle</span>${validRows.length} steps configured. Ready to generate workflow!`;
                status.className = 'generation-status success';
            }
        }

        function validateConfiguration() {
            const errors = [];
            const steps = new Set();

            workflowConfiguration.forEach((row, index) => {
                if (!row.fromStep) errors.push(`Row ${index + 1}: From Step is required`);
                if (!row.toStep) errors.push(`Row ${index + 1}: To Step is required`);
                if (!row.action) errors.push(`Row ${index + 1}: Action is required`);
                if (!row.team) errors.push(`Row ${index + 1}: Team/Role is required`);

                if (row.fromStep) steps.add(row.fromStep);
                if (row.toStep) steps.add(row.toStep);
            });

            if (errors.length > 0) {
                showEnhancedNotification(`Validation failed: ${errors.length} errors found`, 'Configuration Error', 'error');
                console.log('Validation errors:', errors);
            } else {
                showEnhancedNotification(`Configuration valid! ${steps.size} unique steps found`, 'Validation Success', 'success');
            }

            return errors.length === 0;
        }

        function generateWorkflow() {
            if (!validateConfiguration()) {
                return;
            }

            // Show progress
            showGenerationProgress();

            // Disable generate button
            const generateBtn = document.querySelector('.generate-btn');
            generateBtn.disabled = true;
            generateBtn.innerHTML = '<span class="material-icons">hourglass_empty</span> Generating...';

            // Clear existing generated steps
            clearGeneratedSteps();

            // Simulate generation steps with progress
            let progress = 0;
            const progressSteps = [
                { progress: 20, message: 'Analyzing workflow configuration...' },
                { progress: 40, message: 'Creating workflow steps...' },
                { progress: 60, message: 'Establishing connections...' },
                { progress: 80, message: 'Optimizing layout...' },
                { progress: 100, message: 'Finalizing workflow...' }
            ];

            let currentStep = 0;
            const progressInterval = setInterval(() => {
                if (currentStep < progressSteps.length) {
                    const step = progressSteps[currentStep];
                    updateGenerationProgress(step.progress, step.message);
                    currentStep++;
                } else {
                    clearInterval(progressInterval);

                    // Generate actual workflow
                    setTimeout(() => {
                        try {
                            // Clear any existing generated steps
                            clearGeneratedSteps();

                            // Create steps and connections
                            createStepsFromConfiguration();
                            createConnectionsFromConfiguration();

                            // Show the designer
                            hideAllViews();
                            document.getElementById('workflowDesigner').style.display = 'block';

                            // Ensure canvas is visible and properly sized
                            const canvas = document.getElementById('workflowCanvas');
                            if (canvas) {
                                canvas.style.display = 'block';
                                canvas.style.minHeight = '600px';
                            }

                            // Auto-layout the generated workflow
                            setTimeout(() => {
                                autoLayoutGeneratedWorkflow();
                                drawEnhancedConnections();
                                updateMiniMap();

                                // Hide progress and show success
                                hideGenerationProgress();

                                // Re-enable generate button
                                generateBtn.disabled = false;
                                generateBtn.innerHTML = '<span class="material-icons">auto_fix_high</span> Generate Workflow';

                                // Update generation status
                                updateGenerationStatus('success', `Workflow generated with ${generatedSteps.length} steps and ${workflowConfiguration.length} connections`);

                                showEnhancedNotification('Workflow generated successfully! Click on steps to edit them.', 'Generation Complete', 'success');
                            }, 500);
                        } catch (error) {
                            console.error('Error generating workflow:', error);

                            // Hide progress and show error
                            hideGenerationProgress();

                            // Re-enable generate button
                            generateBtn.disabled = false;
                            generateBtn.innerHTML = '<span class="material-icons">auto_fix_high</span> Generate Workflow';

                            updateGenerationStatus('error', 'Failed to generate workflow. Please check your configuration.');
                            showEnhancedNotification('Failed to generate workflow. Please check your configuration.', 'Generation Error', 'error');
                        }
                    }, 300);
                }
            }, 400);
        }

        function showGenerationProgress() {
            const progressDiv = document.getElementById('generationProgress');
            const statusDiv = document.getElementById('generationStatus');

            statusDiv.style.display = 'none';
            progressDiv.style.display = 'block';

            updateGenerationProgress(0, 'Initializing workflow generation...');
        }

        function updateGenerationProgress(percentage, message) {
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');

            progressFill.style.width = percentage + '%';
            progressText.textContent = message;
        }

        function hideGenerationProgress() {
            const progressDiv = document.getElementById('generationProgress');
            const statusDiv = document.getElementById('generationStatus');

            progressDiv.style.display = 'none';
            statusDiv.style.display = 'flex';
        }

        function previewConfiguration() {
            if (workflowConfiguration.length === 0) {
                showEnhancedNotification('No configuration to preview', 'Preview Error', 'warning');
                return;
            }

            // Create a preview summary
            const uniqueSteps = new Set();
            workflowConfiguration.forEach(row => {
                if (row.fromStep) uniqueSteps.add(row.fromStep);
                if (row.toStep) uniqueSteps.add(row.toStep);
            });

            const teamsInvolved = new Set(workflowConfiguration.map(r => r.team).filter(t => t)).size;
            const notificationSteps = workflowConfiguration.filter(r => r.notifications).length;

            // Create a detailed preview modal
            const previewModal = document.createElement('div');
            previewModal.className = 'preview-modal';
            previewModal.innerHTML = `
                <div class="preview-modal-content">
                    <div class="preview-modal-header">
                        <h3 style="margin: 0; display: flex; align-items: center; gap: var(--spacing-sm);">
                            <span class="material-icons">visibility</span>
                            Configuration Preview
                        </h3>
                        <button class="btn btn-secondary" onclick="closePreviewModal()" style="padding: var(--spacing-xs);">
                            <span class="material-icons">close</span>
                        </button>
                    </div>
                    <div class="preview-modal-body">
                        <div class="preview-stats">
                            <div class="preview-stat-card">
                                <div class="stat-number">${uniqueSteps.size}</div>
                                <div class="stat-label">Total Steps</div>
                            </div>
                            <div class="preview-stat-card">
                                <div class="stat-number">${workflowConfiguration.length}</div>
                                <div class="stat-label">Connections</div>
                            </div>
                            <div class="preview-stat-card">
                                <div class="stat-number">${teamsInvolved}</div>
                                <div class="stat-label">Teams Involved</div>
                            </div>
                            <div class="preview-stat-card">
                                <div class="stat-number">${notificationSteps}</div>
                                <div class="stat-label">Notification Steps</div>
                            </div>
                        </div>

                        <div class="preview-details">
                            <h4>Workflow Steps:</h4>
                            <div class="preview-steps-list">
                                ${Array.from(uniqueSteps).map(step => `
                                    <div class="preview-step-item">
                                        <span class="material-icons">radio_button_checked</span>
                                        ${step}
                                    </div>
                                `).join('')}
                            </div>

                            <h4>Workflow Flow:</h4>
                            <div class="preview-flow-list">
                                ${workflowConfiguration.map(config => `
                                    <div class="preview-flow-item">
                                        <span class="flow-from">${config.fromStep}</span>
                                        <span class="material-icons">arrow_forward</span>
                                        <span class="flow-action">${config.action}</span>
                                        <span class="material-icons">arrow_forward</span>
                                        <span class="flow-to">${config.toStep}</span>
                                        <span class="flow-team">(${config.team})</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                    <div class="preview-modal-footer">
                        <button class="btn btn-primary" onclick="generateWorkflow(); closePreviewModal();">
                            <span class="material-icons">auto_fix_high</span>
                            Generate Workflow
                        </button>
                        <button class="btn btn-secondary" onclick="closePreviewModal()">
                            Close Preview
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(previewModal);

            // Add styles for the modal
            if (!document.getElementById('previewModalStyles')) {
                const styles = document.createElement('style');
                styles.id = 'previewModalStyles';
                styles.textContent = `
                    .preview-modal {
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0, 0, 0, 0.5);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        z-index: 1000;
                        animation: fadeIn 0.3s ease;
                    }

                    .preview-modal-content {
                        background: var(--background-primary);
                        border-radius: var(--radius-lg);
                        max-width: 800px;
                        width: 90%;
                        max-height: 80vh;
                        overflow-y: auto;
                        box-shadow: var(--shadow-large);
                        animation: slideInFromTop 0.3s ease;
                    }

                    .preview-modal-header {
                        padding: var(--spacing-lg);
                        border-bottom: 1px solid var(--border-primary);
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        background: var(--background-tertiary);
                    }

                    .preview-modal-body {
                        padding: var(--spacing-lg);
                    }

                    .preview-modal-footer {
                        padding: var(--spacing-lg);
                        border-top: 1px solid var(--border-primary);
                        display: flex;
                        gap: var(--spacing-sm);
                        justify-content: flex-end;
                        background: var(--background-tertiary);
                    }

                    .preview-stats {
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                        gap: var(--spacing-md);
                        margin-bottom: var(--spacing-xl);
                    }

                    .preview-stat-card {
                        text-align: center;
                        padding: var(--spacing-lg);
                        background: var(--background-tertiary);
                        border-radius: var(--radius-md);
                        border: 1px solid var(--border-primary);
                    }

                    .stat-number {
                        font-size: 2rem;
                        font-weight: 700;
                        color: var(--accent-color);
                        margin-bottom: var(--spacing-xs);
                    }

                    .stat-label {
                        font-size: 0.875rem;
                        color: var(--text-secondary);
                    }

                    .preview-steps-list, .preview-flow-list {
                        background: var(--background-tertiary);
                        border-radius: var(--radius-md);
                        padding: var(--spacing-md);
                        margin-bottom: var(--spacing-md);
                    }

                    .preview-step-item {
                        display: flex;
                        align-items: center;
                        gap: var(--spacing-sm);
                        padding: var(--spacing-xs) 0;
                        color: var(--text-primary);
                    }

                    .preview-flow-item {
                        display: flex;
                        align-items: center;
                        gap: var(--spacing-sm);
                        padding: var(--spacing-sm) 0;
                        border-bottom: 1px solid var(--border-primary);
                        font-size: 0.875rem;
                    }

                    .preview-flow-item:last-child {
                        border-bottom: none;
                    }

                    .flow-from, .flow-to {
                        font-weight: 600;
                        color: var(--text-primary);
                    }

                    .flow-action {
                        background: var(--accent-color);
                        color: var(--text-white);
                        padding: var(--spacing-xs) var(--spacing-sm);
                        border-radius: var(--radius-sm);
                        font-size: 0.75rem;
                    }

                    .flow-team {
                        color: var(--text-secondary);
                        font-size: 0.75rem;
                    }

                    @keyframes fadeIn {
                        from { opacity: 0; }
                        to { opacity: 1; }
                    }

                    @keyframes slideInFromTop {
                        from { transform: translateY(-50px); opacity: 0; }
                        to { transform: translateY(0); opacity: 1; }
                    }
                `;
                document.head.appendChild(styles);
            }
        }

        function closePreviewModal() {
            const modal = document.querySelector('.preview-modal');
            if (modal) {
                modal.remove();
            }
        }

        function clearGeneratedSteps() {
            // Remove all auto-generated steps
            document.querySelectorAll('.workflow-step.auto-step').forEach(step => {
                step.remove();
            });

            // Clear connection labels
            document.querySelectorAll('.connection-label').forEach(label => {
                label.remove();
            });

            generatedSteps = [];
            autoStepCounter = 1;
        }

        function createStepsFromConfiguration() {
            const uniqueSteps = new Set();
            const stepData = new Map();

            // Collect all unique steps and their data
            workflowConfiguration.forEach(row => {
                if (row.fromStep && !uniqueSteps.has(row.fromStep)) {
                    uniqueSteps.add(row.fromStep);
                    stepData.set(row.fromStep, {
                        name: row.fromStep,
                        type: getStepTypeFromName(row.fromStep),
                        team: row.team,
                        actions: []
                    });
                }

                if (row.toStep && !uniqueSteps.has(row.toStep)) {
                    uniqueSteps.add(row.toStep);
                    stepData.set(row.toStep, {
                        name: row.toStep,
                        type: getStepTypeFromName(row.toStep),
                        team: findTeamForStep(row.toStep),
                        actions: []
                    });
                }

                // Add action to from step
                if (row.fromStep && stepData.has(row.fromStep)) {
                    stepData.get(row.fromStep).actions.push(row.action);
                }
            });

            // Create visual steps
            Array.from(uniqueSteps).forEach((stepName, index) => {
                const data = stepData.get(stepName);
                createAutoGeneratedStep(stepName, data, index);
            });
        }

        function getStepTypeFromName(stepName) {
            const name = stepName.toLowerCase();
            if (name.includes('start') || name.includes('initiat') || name.includes('begin')) return 'begin';
            if (name.includes('end') || name.includes('complet') || name.includes('finish') || name.includes('reject')) return 'end';
            if (name.includes('decision') || name.includes('choose')) return 'decision';
            if (name.includes('approval') || name.includes('approve')) return 'approval';
            return 'intermediate';
        }

        function findTeamForStep(stepName) {
            const config = workflowConfiguration.find(row => row.toStep === stepName);
            return config ? config.team : 'Unassigned';
        }

        // Add connection hover effects for live preview
        function addConnectionInteractivity() {
            const canvas = document.getElementById('liveWorkflowCanvas');
            if (!canvas) return;

            // Add hover effects to workflow steps
            const steps = canvas.querySelectorAll('.live-workflow-step');
            steps.forEach(step => {
                step.addEventListener('mouseenter', () => {
                    highlightConnectedSteps(step);
                });

                step.addEventListener('mouseleave', () => {
                    clearStepHighlights();
                });
            });

            // Add hover effects to connection lines
            const connections = canvas.querySelectorAll('.live-connection-line');
            connections.forEach(connection => {
                connection.addEventListener('mouseenter', () => {
                    connection.style.strokeWidth = '5';
                    connection.style.opacity = '1';
                });

                connection.addEventListener('mouseleave', () => {
                    connection.style.strokeWidth = '3';
                    connection.style.opacity = '0.8';
                });
            });
        }

        function highlightConnectedSteps(hoveredStep) {
            const stepName = hoveredStep.getAttribute('data-step-name');
            const canvas = document.getElementById('liveWorkflowCanvas');

            // Dim all steps first
            const allSteps = canvas.querySelectorAll('.live-workflow-step');
            allSteps.forEach(step => {
                step.style.opacity = '0.3';
            });

            // Highlight the hovered step
            hoveredStep.style.opacity = '1';
            hoveredStep.style.transform = 'scale(1.05)';

            // Find and highlight connected steps
            workflowConfiguration.forEach(row => {
                if (row.fromStep === stepName || row.toStep === stepName) {
                    const connectedStepName = row.fromStep === stepName ? row.toStep : row.fromStep;
                    const connectedStep = canvas.querySelector(`[data-step-name="${connectedStepName}"]`);
                    if (connectedStep) {
                        connectedStep.style.opacity = '1';
                    }
                }
            });

            // Highlight relevant connection lines
            const allConnections = canvas.querySelectorAll('.live-connection-line');
            allConnections.forEach(connection => {
                connection.style.opacity = '0.2';
            });
        }

        function clearStepHighlights() {
            const canvas = document.getElementById('liveWorkflowCanvas');
            if (!canvas) return;

            const allSteps = canvas.querySelectorAll('.live-workflow-step');
            allSteps.forEach(step => {
                step.style.opacity = '1';
                step.style.transform = 'scale(1)';
            });

            const allConnections = canvas.querySelectorAll('.live-connection-line');
            allConnections.forEach(connection => {
                connection.style.opacity = '0.8';
            });
        }

        function createAutoGeneratedStep(stepName, data, index) {
            const stepId = `auto-step-${autoStepCounter++}`;
            const canvas = document.getElementById('workflowCanvas');

            // Calculate position
            const x = 100 + (index % 4) * 280;
            const y = 100 + Math.floor(index / 4) * 200;

            const stepElement = document.createElement('div');
            stepElement.className = `workflow-step auto-step step-type-${data.type}`;
            stepElement.id = stepId;
            stepElement.setAttribute('data-step-name', stepName);
            stepElement.style.left = x + 'px';
            stepElement.style.top = y + 'px';

            const statusIcon = getStatusIcon(data.type);
            const statusClass = getStatusClass(data.type);

            stepElement.innerHTML = `
                <!-- Connection Handles -->
                <div class="connection-handle input" data-handle="input" onclick="startConnection(this)"></div>
                <div class="connection-handle output" data-handle="output" onclick="startConnection(this)"></div>
                <div class="connection-handle bottom" data-handle="bottom" onclick="startConnection(this)"></div>

                <!-- Status Indicator -->
                <div class="step-status-indicator ${statusClass}">
                    <span class="material-icons" style="font-size: 0.75rem;">${statusIcon}</span>
                </div>

                <div class="step-content">
                    <div class="step-header">
                        <div class="step-type ${data.type}">${data.type.charAt(0).toUpperCase() + data.type.slice(1)}</div>
                        <span class="material-icons" style="cursor: pointer; color: var(--text-light);" onclick="editAutoStep('${stepId}')">edit</span>
                    </div>
                    <div class="step-title">${stepName}</div>
                    <div class="step-status">Auto-Generated</div>
                    <div class="step-actions">
                        ${data.actions.map(action => `<div class="step-action">${action}</div>`).join('')}
                    </div>
                    <div style="margin-top: var(--spacing-sm); font-size: 0.75rem; color: var(--text-light);">
                        Role: ${data.team}
                    </div>
                </div>

                <!-- Progress Bar -->
                <div class="step-progress">
                    <div class="step-progress-fill" style="width: ${Math.random() * 100}%;"></div>
                </div>
            `;

            canvas.appendChild(stepElement);
            makeDraggable(stepElement);

            // Add to generated steps tracking
            generatedSteps.push({
                id: stepId,
                name: stepName,
                element: stepElement,
                data: data
            });
        }

        function getStatusIcon(type) {
            const icons = {
                'begin': 'play_arrow',
                'intermediate': 'sync',
                'end': 'check',
                'decision': 'help',
                'approval': 'thumb_up'
            };
            return icons[type] || 'sync';
        }

        function getStatusClass(type) {
            const classes = {
                'begin': 'completed',
                'intermediate': 'in-progress',
                'end': 'completed',
                'decision': 'pending',
                'approval': 'pending'
            };
            return classes[type] || 'pending';
        }

        function createConnectionsFromConfiguration() {
            workflowConfiguration.forEach(row => {
                if (row.fromStep && row.toStep) {
                    const fromStep = generatedSteps.find(s => s.name === row.fromStep);
                    const toStep = generatedSteps.find(s => s.name === row.toStep);

                    if (fromStep && toStep) {
                        // Connection will be drawn by drawEnhancedConnections
                        console.log(`Connection: ${row.fromStep} -> ${row.toStep} (${row.action})`);
                    }
                }
            });
        }

        function autoLayoutGeneratedWorkflow() {
            const steps = document.querySelectorAll('.workflow-step.auto-step');

            // Simple hierarchical layout
            const levels = new Map();
            const processed = new Set();

            // Find begin steps (level 0)
            steps.forEach(step => {
                const stepName = step.getAttribute('data-step-name');
                const isBegin = !workflowConfiguration.some(row => row.toStep === stepName);
                if (isBegin) {
                    levels.set(stepName, 0);
                    processed.add(stepName);
                }
            });

            // Assign levels based on dependencies
            let currentLevel = 0;
            while (processed.size < steps.length && currentLevel < 10) {
                workflowConfiguration.forEach(row => {
                    if (processed.has(row.fromStep) && !processed.has(row.toStep)) {
                        const fromLevel = levels.get(row.fromStep) || 0;
                        levels.set(row.toStep, fromLevel + 1);
                        processed.add(row.toStep);
                    }
                });
                currentLevel++;
            }

            // Position steps based on levels
            const levelCounts = new Map();
            steps.forEach(step => {
                const stepName = step.getAttribute('data-step-name');
                const level = levels.get(stepName) || 0;
                const count = levelCounts.get(level) || 0;

                const x = 100 + level * 300;
                const y = 100 + count * 180;

                step.style.left = x + 'px';
                step.style.top = y + 'px';

                levelCounts.set(level, count + 1);
            });
        }

        function regenerateWorkflow() {
            showEnhancedNotification('Regenerating workflow...', 'Please wait', 'info');
            generateWorkflow();
        }

        function showConfiguration() {
            hideAllViews();
            document.getElementById('workflowConfigPanel').style.display = 'block';
            showEnhancedNotification('Switched to configuration view', 'Configuration', 'info');
        }

        function closeDesigner() {
            hideAllViews();
            document.getElementById('workflowConfigPanel').style.display = 'block';
            showEnhancedNotification('Designer closed', 'Back to Configuration', 'info');
        }

        function saveWorkflow() {
            showEnhancedNotification('Workflow saved successfully!', 'Save Complete', 'success');
        }

        function previewWorkflow() {
            showEnhancedNotification('Workflow preview feature coming soon...', 'Preview', 'info');
        }

        function loadQuickTemplate(templateType) {
            // Clear existing configuration
            workflowConfiguration = [];

            // Remove active class from all templates
            document.querySelectorAll('.enhanced-template').forEach(option => {
                option.classList.remove('active');
            });

            // Add active class to selected template
            const selectedTemplate = document.querySelector(`[data-template="${templateType}"]`);
            if (selectedTemplate) {
                selectedTemplate.classList.add('active');
            }

            switch (templateType) {
                case 'warranty':
                    workflowConfiguration = [
                        { id: 1, fromStep: 'Initiated', toStep: 'Branch Manager Review', action: 'Submit Request', team: 'Co-Ordinator - Orlando', stepType: 'begin', notifications: true },
                        { id: 2, fromStep: 'Branch Manager Review', toStep: 'Warranty Supervisor Review', action: 'Approve', team: 'Branch Mgr - Orlando', stepType: 'intermediate', notifications: true },
                        { id: 3, fromStep: 'Branch Manager Review', toStep: 'Rejected', action: 'Reject', team: 'Branch Mgr - Orlando', stepType: 'intermediate', notifications: false },
                        { id: 4, fromStep: 'Warranty Supervisor Review', toStep: 'ADM Manager Review', action: 'Escalate', team: 'Warranty Supervisor - Orlando', stepType: 'intermediate', notifications: true },
                        { id: 5, fromStep: 'ADM Manager Review', toStep: 'Completed', action: 'Final Approve', team: 'Warranty ADM Manager - Orlando', stepType: 'intermediate', notifications: true }
                    ];
                    break;
                case 'approval':
                    workflowConfiguration = [
                        { id: 1, fromStep: 'Start', toStep: 'Review', action: 'Submit', team: 'Finance Team', stepType: 'begin', notifications: true },
                        { id: 2, fromStep: 'Review', toStep: 'Approved', action: 'Approve', team: 'Finance Team', stepType: 'approval', notifications: true },
                        { id: 3, fromStep: 'Review', toStep: 'Rejected', action: 'Reject', team: 'Finance Team', stepType: 'approval', notifications: false }
                    ];
                    break;
                case 'review':
                    workflowConfiguration = [
                        { id: 1, fromStep: 'Draft', toStep: 'Peer Review', action: 'Submit for Review', team: 'IT Team', stepType: 'begin', notifications: true },
                        { id: 2, fromStep: 'Peer Review', toStep: 'Manager Review', action: 'Pass Review', team: 'IT Team', stepType: 'intermediate', notifications: true },
                        { id: 3, fromStep: 'Manager Review', toStep: 'Published', action: 'Approve', team: 'IT Team', stepType: 'end', notifications: true }
                    ];
                    break;
                case 'escalation':
                    workflowConfiguration = [
                        { id: 1, fromStep: 'Issue Reported', toStep: 'L1 Support', action: 'Assign', team: 'IT Team', stepType: 'begin', notifications: true },
                        { id: 2, fromStep: 'L1 Support', toStep: 'L2 Support', action: 'Escalate', team: 'IT Team', stepType: 'intermediate', notifications: true },
                        { id: 3, fromStep: 'L2 Support', toStep: 'L3 Support', action: 'Escalate', team: 'IT Team', stepType: 'intermediate', notifications: true },
                        { id: 4, fromStep: 'L3 Support', toStep: 'Resolved', action: 'Resolve', team: 'IT Team', stepType: 'end', notifications: true }
                    ];
                    break;
                default:
                    addConfigRow();
                    break;
            }

            renderConfigurationTable();
            updateGenerationStatus();
            updateConfigStats();
            // Auto-generate live workflow preview
            generateLiveWorkflowPreview();
            showEnhancedNotification(`${templateType.charAt(0).toUpperCase() + templateType.slice(1)} template loaded`, 'Template Applied', 'success');
        }

        // Live Workflow Preview Functions
        function generateLiveWorkflowPreview() {
            const emptyState = document.getElementById('emptyState');
            const liveCanvas = document.getElementById('liveWorkflowCanvas');
            const liveStepCount = document.getElementById('liveStepCount');
            const liveConnectionCount = document.getElementById('liveConnectionCount');

            // Clear existing preview
            liveCanvas.innerHTML = '';

            if (workflowConfiguration.length === 0) {
                emptyState.style.display = 'flex';
                liveCanvas.style.display = 'none';
                liveStepCount.textContent = '0';
                liveConnectionCount.textContent = '0';
                return;
            }

            emptyState.style.display = 'none';
            liveCanvas.style.display = 'block';

            // Generate live workflow steps
            const uniqueSteps = new Set();
            const stepData = new Map();

            // Collect all unique steps and their data
            workflowConfiguration.forEach(row => {
                if (row.fromStep && row.fromStep.trim()) {
                    uniqueSteps.add(row.fromStep);
                    if (!stepData.has(row.fromStep)) {
                        stepData.set(row.fromStep, {
                            name: row.fromStep,
                            type: getStepTypeFromName(row.fromStep),
                            team: row.team || 'Unassigned',
                            actions: []
                        });
                    }
                    if (row.action && row.action.trim()) {
                        stepData.get(row.fromStep).actions.push(row.action);
                    }
                }

                if (row.toStep && row.toStep.trim()) {
                    uniqueSteps.add(row.toStep);
                    if (!stepData.has(row.toStep)) {
                        stepData.set(row.toStep, {
                            name: row.toStep,
                            type: getStepTypeFromName(row.toStep),
                            team: findTeamForStep(row.toStep) || 'Unassigned',
                            actions: []
                        });
                    }
                }
            });

            // Update stats
            liveStepCount.textContent = uniqueSteps.size;
            liveConnectionCount.textContent = workflowConfiguration.length;

            // Create SVG for connections
            const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svg.className = 'live-connection-svg';
            svg.style.position = 'absolute';
            svg.style.top = '0';
            svg.style.left = '0';
            svg.style.width = '100%';
            svg.style.height = '100%';
            svg.style.pointerEvents = 'none';
            svg.style.zIndex = '1';
            svg.innerHTML = `
                <defs>
                    <marker id="live-arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                        <polygon points="0 0, 10 3.5, 0 7" fill="#007AFF" />
                    </marker>
                </defs>
            `;
            liveCanvas.appendChild(svg);

            // Create visual steps with auto-layout
            const stepElements = new Map();
            Array.from(uniqueSteps).forEach((stepName, index) => {
                const data = stepData.get(stepName);
                const stepElement = createLiveWorkflowStep(stepName, data, index);
                stepElements.set(stepName, stepElement);
                liveCanvas.appendChild(stepElement);
            });

            // Auto-layout steps
            autoLayoutLiveSteps(stepElements);

            // Draw connections with delay to ensure steps are positioned
            setTimeout(() => {
                console.log('Starting to draw connections...');
                drawLiveConnections(stepElements, svg);
                // Add interactivity after connections are drawn
                setTimeout(() => {
                    addConnectionInteractivity();
                }, 300);
            }, 500);
        }

        function createLiveWorkflowStep(stepName, data, index) {
            const stepElement = document.createElement('div');
            stepElement.className = 'live-workflow-step live-step-enter';
            stepElement.setAttribute('data-step-name', stepName);

            stepElement.innerHTML = `
                <div class="live-step-header">
                    <div class="live-step-type ${data.type}">${data.type}</div>
                </div>
                <div class="live-step-title">${stepName}</div>
                <div class="live-step-team">${data.team}</div>
                <div class="live-step-actions">
                    ${data.actions.map(action => `<div class="live-step-action">${action}</div>`).join('')}
                </div>
            `;

            return stepElement;
        }

        function autoLayoutLiveSteps(stepElements) {
            const steps = Array.from(stepElements.values());
            const levels = new Map();
            const processed = new Set();
            const canvas = document.getElementById('liveWorkflowCanvas');
            const canvasWidth = canvas.offsetWidth - 80; // Account for padding
            const canvasHeight = canvas.offsetHeight - 80;

            // Find begin steps (level 0)
            steps.forEach(step => {
                const stepName = step.getAttribute('data-step-name');
                const isBegin = !workflowConfiguration.some(row => row.toStep === stepName);
                if (isBegin) {
                    levels.set(stepName, 0);
                    processed.add(stepName);
                }
            });

            // Assign levels based on dependencies
            let currentLevel = 0;
            while (processed.size < steps.length && currentLevel < 10) {
                workflowConfiguration.forEach(row => {
                    if (processed.has(row.fromStep) && !processed.has(row.toStep)) {
                        const fromLevel = levels.get(row.fromStep) || 0;
                        levels.set(row.toStep, fromLevel + 1);
                        processed.add(row.toStep);
                    }
                });
                currentLevel++;
            }

            // Group steps by level and calculate optimal layout
            const levelSteps = new Map();
            const maxLevel = Math.max(...Array.from(levels.values()), 0);

            steps.forEach(step => {
                const stepName = step.getAttribute('data-step-name');
                const level = levels.get(stepName) || 0;
                if (!levelSteps.has(level)) {
                    levelSteps.set(level, []);
                }
                levelSteps.get(level).push({ step, stepName });
            });

            // Calculate optimal spacing
            const stepWidth = 220;
            const stepHeight = 120;
            const minHorizontalSpacing = 100;
            const minVerticalSpacing = 60;

            const horizontalSpacing = Math.max(minHorizontalSpacing,
                maxLevel > 0 ? (canvasWidth - stepWidth * (maxLevel + 1)) / maxLevel : minHorizontalSpacing);

            // Position steps with dynamic spacing and alignment
            levelSteps.forEach((stepsInLevel, level) => {
                const totalLevelHeight = stepsInLevel.length * stepHeight + (stepsInLevel.length - 1) * minVerticalSpacing;
                const startY = Math.max(40, (canvasHeight - totalLevelHeight) / 2);

                stepsInLevel.forEach((stepInfo, index) => {
                    // Calculate positions with proper alignment
                    const x = 40 + level * (stepWidth + horizontalSpacing);
                    const y = startY + index * (stepHeight + minVerticalSpacing);

                    // Apply positioning with smooth animation
                    stepInfo.step.style.left = x + 'px';
                    stepInfo.step.style.top = y + 'px';
                    stepInfo.step.style.opacity = '0';
                    stepInfo.step.style.transform = 'scale(0.8) translateY(20px)';

                    // Add staggered entrance animation
                    const delay = level * 200 + index * 100;
                    setTimeout(() => {
                        stepInfo.step.style.transition = 'all 0.6s cubic-bezier(0.4, 0, 0.2, 1)';
                        stepInfo.step.style.opacity = '1';
                        stepInfo.step.style.transform = 'scale(1) translateY(0)';
                    }, delay);

                    // Add step type class for enhanced styling
                    const stepType = getStepTypeFromName(stepInfo.stepName);
                    stepInfo.step.classList.add(stepType);
                });
            });

            // Update canvas height if needed
            const maxY = Math.max(...Array.from(levelSteps.values()).flat().map((stepInfo, index) => {
                const level = levels.get(stepInfo.stepName) || 0;
                const levelStepsCount = levelSteps.get(level).length;
                const totalLevelHeight = levelStepsCount * stepHeight + (levelStepsCount - 1) * minVerticalSpacing;
                const startY = Math.max(40, (canvasHeight - totalLevelHeight) / 2);
                return startY + index * (stepHeight + minVerticalSpacing) + stepHeight;
            }));

            if (maxY > canvasHeight) {
                canvas.style.minHeight = (maxY + 80) + 'px';
            }
        }

        function drawLiveConnections(stepElements, svg) {
            console.log('Drawing live connections...', stepElements.size, 'steps');

            // Clear existing connections and labels
            svg.innerHTML = `
                <defs>
                    <marker id="live-arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                        <polygon points="0 0, 10 3.5, 0 7" fill="#007AFF" />
                    </marker>
                    <marker id="live-arrowhead-success" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                        <polygon points="0 0, 10 3.5, 0 7" fill="#22C55E" />
                    </marker>
                    <marker id="live-arrowhead-error" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                        <polygon points="0 0, 10 3.5, 0 7" fill="#EF4444" />
                    </marker>
                    <marker id="live-arrowhead-warning" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                        <polygon points="0 0, 10 3.5, 0 7" fill="#F59E0B" />
                    </marker>
                </defs>
            `;

            // Remove existing labels
            const existingLabels = svg.parentElement.querySelectorAll('.live-connection-label');
            existingLabels.forEach(label => label.remove());

            workflowConfiguration.forEach((row, index) => {
                if (row.fromStep && row.toStep) {
                    const fromStep = stepElements.get(row.fromStep);
                    const toStep = stepElements.get(row.toStep);

                    if (fromStep && toStep) {
                        console.log(`Creating connection: ${row.fromStep} -> ${row.toStep}`);

                        // Get step positions using offsetLeft/offsetTop (more reliable)
                        const fromX = fromStep.offsetLeft + fromStep.offsetWidth;
                        const fromY = fromStep.offsetTop + fromStep.offsetHeight / 2;
                        const toX = toStep.offsetLeft;
                        const toY = toStep.offsetTop + toStep.offsetHeight / 2;

                        console.log(`Connection coordinates: (${fromX}, ${fromY}) -> (${toX}, ${toY})`);

                        // Create the connection path
                        const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                        path.className = 'live-connection-line';

                        // Create simple straight line for testing
                        const pathData = `M ${fromX} ${fromY} L ${toX} ${toY}`;
                        path.setAttribute('d', pathData);

                        // Set basic styling
                        path.setAttribute('stroke', '#007AFF');
                        path.setAttribute('stroke-width', '2');
                        path.setAttribute('fill', 'none');
                        path.setAttribute('marker-end', 'url(#live-arrowhead)');

                        // Determine connection color based on action
                        if (row.action) {
                            const action = row.action.toLowerCase();
                            if (action.includes('reject') || action.includes('deny')) {
                                path.setAttribute('stroke', '#EF4444');
                                path.setAttribute('marker-end', 'url(#live-arrowhead-error)');
                            } else if (action.includes('approve') || action.includes('accept') || action.includes('complete')) {
                                path.setAttribute('stroke', '#22C55E');
                                path.setAttribute('marker-end', 'url(#live-arrowhead-success)');
                            } else if (action.includes('escalate') || action.includes('review') || action.includes('pending')) {
                                path.setAttribute('stroke', '#F59E0B');
                                path.setAttribute('marker-end', 'url(#live-arrowhead-warning)');
                            }
                        }

                        svg.appendChild(path);
                        console.log('Connection path added to SVG');

                        // Enhanced dotted connection line
                        const connectionLine = document.createElement('div');
                        connectionLine.className = 'simple-connection-line';

                        // Calculate connection properties
                        const deltaX = toX - fromX;
                        const deltaY = toY - fromY;
                        const angle = Math.atan2(deltaY, deltaX) * 180 / Math.PI;
                        const length = Math.sqrt(deltaX * deltaX + deltaY * deltaY);

                        // Position and style the connection line
                        connectionLine.style.position = 'absolute';
                        connectionLine.style.left = fromX + 'px';
                        connectionLine.style.top = (fromY - 1.5) + 'px'; // Center the line
                        connectionLine.style.width = length + 'px';
                        connectionLine.style.height = '3px';
                        connectionLine.style.transformOrigin = '0 50%';
                        connectionLine.style.transform = `rotate(${angle}deg)`;
                        connectionLine.style.zIndex = '2';

                        // Add connection type styling
                        if (row.action) {
                            const action = row.action.toLowerCase();
                            if (action.includes('reject') || action.includes('deny')) {
                                connectionLine.classList.add('error');
                            } else if (action.includes('approve') || action.includes('accept') || action.includes('complete')) {
                                connectionLine.classList.add('success');
                            } else if (action.includes('escalate') || action.includes('review') || action.includes('pending')) {
                                connectionLine.classList.add('warning');
                            }
                        }

                        // Add entrance animation
                        connectionLine.style.opacity = '0';
                        connectionLine.style.transform = `rotate(${angle}deg) scaleX(0)`;

                        svg.parentElement.appendChild(connectionLine);

                        // Animate the connection line appearance
                        setTimeout(() => {
                            connectionLine.style.transition = 'all 0.8s cubic-bezier(0.4, 0, 0.2, 1)';
                            connectionLine.style.opacity = '0.9';
                            connectionLine.style.transform = `rotate(${angle}deg) scaleX(1)`;
                        }, index * 300 + 500);

                        console.log('Enhanced connection line added');

                        // Add enhanced connection label
                        if (row.action) {
                            const label = document.createElement('div');
                            label.className = 'live-connection-label enhanced';
                            label.textContent = row.action;

                            // Position label at the midpoint
                            const midX = (fromX + toX) / 2;
                            const midY = (fromY + toY) / 2;

                            label.style.position = 'absolute';
                            label.style.left = midX + 'px';
                            label.style.top = midY + 'px';
                            label.style.transform = 'translate(-50%, -50%)';
                            label.style.zIndex = '15';
                            label.style.whiteSpace = 'nowrap';
                            label.style.fontSize = '11px';
                            label.style.fontWeight = '600';
                            label.style.padding = '6px 12px';
                            label.style.borderRadius = '20px';
                            label.style.border = '1px solid rgba(255, 255, 255, 0.2)';
                            label.style.backdropFilter = 'blur(10px)';
                            label.style.boxShadow = '0 2px 8px rgba(0, 0, 0, 0.15)';
                            label.style.opacity = '0';
                            label.style.transform = 'translate(-50%, -50%) scale(0.8)';

                            // Set color based on action type
                            if (row.action) {
                                const action = row.action.toLowerCase();
                                if (action.includes('reject') || action.includes('deny')) {
                                    label.style.background = '#EF4444';
                                    label.style.color = 'white';
                                } else if (action.includes('approve') || action.includes('accept') || action.includes('complete')) {
                                    label.style.background = '#22C55E';
                                    label.style.color = 'white';
                                } else if (action.includes('escalate') || action.includes('review') || action.includes('pending')) {
                                    label.style.background = '#F59E0B';
                                    label.style.color = 'white';
                                } else {
                                    label.style.background = '#007AFF';
                                    label.style.color = 'white';
                                }
                            }

                            svg.parentElement.appendChild(label);

                            // Animate label appearance
                            setTimeout(() => {
                                label.style.transition = 'all 0.5s cubic-bezier(0.4, 0, 0.2, 1)';
                                label.style.opacity = '1';
                                label.style.transform = 'translate(-50%, -50%) scale(1)';
                            }, index * 300 + 800);

                            console.log('Enhanced connection label added');
                        }
                    }
                }
            });
        }

        function createLiveConnectionPath(x1, y1, x2, y2) {
            const dx = x2 - x1;
            const dy = y2 - y1;
            const distance = Math.sqrt(dx * dx + dy * dy);

            // Create curved path
            const controlOffset = Math.min(distance * 0.3, 80);
            const cx1 = x1 + controlOffset;
            const cy1 = y1;
            const cx2 = x2 - controlOffset;
            const cy2 = y2;

            return `M ${x1} ${y1} C ${cx1} ${cy1}, ${cx2} ${cy2}, ${x2} ${y2}`;
        }

        async function clearConfiguration() {
            const result = await showCustomAlert(
                'Are you sure you want to clear all configuration data? This action cannot be undone.',
                'Clear Configuration',
                'warning',
                ['Cancel', 'Clear All']
            );

            if (result === 'Clear All') {
                workflowConfiguration = [];
                renderConfigurationTable();
                updateGenerationStatus();
                updateConfigStats();
                generateLiveWorkflowPreview();
                showEnhancedNotification('Configuration cleared', 'All data removed', 'warning');
            }
        }

        function importExcelData() {
            // Simulate Excel import with sample data
            const excelData = [
                { fromStep: 'Initiated(Orlando)', toStep: 'Created(Orlando)', action: 'Request for Warranty Claim', team: 'Co-Ordinator - Orlando' },
                { fromStep: 'Moved to Branch Mgr(Orlando)', toStep: 'Rejected', action: 'Rejected', team: 'Branch Mgr - Orlando' },
                { fromStep: 'Moved to Branch Mgr(Orlando)', toStep: 'Review and Approved by Branch Mgr(Orlando)', action: 'Review and Approve', team: 'Branch Mgr - Orlando' }
            ];

            workflowConfiguration = excelData.map((row, index) => ({
                id: Date.now() + index,
                fromStep: row.fromStep,
                toStep: row.toStep,
                action: row.action,
                team: row.team,
                stepType: 'intermediate',
                notifications: false
            }));

            renderConfigurationTable();
            updateGenerationStatus();
            updateConfigStats();
            generateLiveWorkflowPreview();
            showEnhancedNotification('Excel data imported successfully', 'Import Complete', 'success');
        }

        function editAutoStep(stepId) {
            const step = document.getElementById(stepId);
            if (step) {
                selectStep(step);
                openSidebar();
                populateStepForm(step);
            }
        }

        // Enhanced Workflow Designer Functions

        // Canvas Tool Management
        function setCanvasTool(tool) {
            currentCanvasTool = tool;

            // Update tool buttons
            document.querySelectorAll('.canvas-tool').forEach(btn => btn.classList.remove('active'));
            document.getElementById(tool + 'Tool').classList.add('active');

            // Update canvas cursor
            const canvas = document.getElementById('workflowCanvas');
            canvas.classList.remove('connection-mode');

            if (tool === 'connect') {
                canvas.classList.add('connection-mode');
                showEnhancedNotification('Connection mode activated', 'Click connection handles to connect steps', 'info');
            } else if (tool === 'pan') {
                showEnhancedNotification('Pan mode activated', 'Drag to move the canvas', 'info');
            } else {
                showEnhancedNotification('Select mode activated', 'Click to select and drag steps', 'info');
            }

            // Reset connection state
            resetConnectionState();
        }

        // Connection Management
        function startConnection(handle) {
            if (currentCanvasTool !== 'connect') {
                setCanvasTool('connect');
                return;
            }

            const step = handle.closest('.workflow-step');
            const handleType = handle.dataset.handle;

            if (!isConnecting) {
                // Start connection
                isConnecting = true;
                connectionSource = { step: step, handle: handleType };

                // Visual feedback
                step.classList.add('connection-source');
                handle.classList.add('active');

                // Show connection preview
                document.addEventListener('mousemove', updateConnectionPreview);
                document.getElementById('connectionPreview').style.display = 'block';

                showEnhancedNotification('Connection started', 'Click another handle to complete', 'info');

                // Highlight possible targets
                highlightConnectionTargets(step);

            } else {
                // Complete connection
                if (connectionSource.step !== step) {
                    createConnection(connectionSource, { step: step, handle: handleType });
                }
                resetConnectionState();
            }
        }

        function updateConnectionPreview(e) {
            if (!isConnecting || !connectionSource) return;

            const canvas = document.getElementById('workflowCanvas');
            const canvasRect = canvas.getBoundingClientRect();
            const sourceStep = connectionSource.step;
            const sourceRect = sourceStep.getBoundingClientRect();

            const sourceX = sourceRect.left - canvasRect.left + sourceRect.width / 2;
            const sourceY = sourceRect.top - canvasRect.top + sourceRect.height / 2;
            const targetX = e.clientX - canvasRect.left;
            const targetY = e.clientY - canvasRect.top;

            const preview = document.querySelector('#connectionPreview path');
            const d = createConnectionPath(sourceX, sourceY, targetX, targetY);
            preview.setAttribute('d', d);
        }

        function createConnection(source, target) {
            const connectionId = `conn_${source.step.id}_${target.step.id}`;

            // Check if connection already exists
            if (document.getElementById(connectionId)) {
                showEnhancedNotification('Connection already exists', 'Connection Error', 'warning');
                return;
            }

            // Create connection data
            const connection = {
                id: connectionId,
                from: source.step.id,
                to: target.step.id,
                fromHandle: source.handle,
                toHandle: target.handle,
                label: 'Default Action'
            };

            // Add to connections array
            connections.push(connection);

            // Redraw connections
            drawEnhancedConnections();

            showEnhancedNotification('Connection created successfully', 'Connection Added', 'success');
        }

        function resetConnectionState() {
            isConnecting = false;
            connectionSource = null;

            // Remove visual feedback
            document.querySelectorAll('.workflow-step').forEach(step => {
                step.classList.remove('connection-source', 'connection-target', 'can-connect');
            });

            document.querySelectorAll('.connection-handle').forEach(handle => {
                handle.classList.remove('active');
            });

            // Hide connection preview
            document.getElementById('connectionPreview').style.display = 'none';
            document.removeEventListener('mousemove', updateConnectionPreview);
        }

        function highlightConnectionTargets(sourceStep) {
            document.querySelectorAll('.workflow-step').forEach(step => {
                if (step !== sourceStep) {
                    step.classList.add('can-connect');
                }
            });
        }

        function createConnectionPath(x1, y1, x2, y2) {
            const dx = x2 - x1;
            const dy = y2 - y1;
            const distance = Math.sqrt(dx * dx + dy * dy);

            // Create curved path
            const controlOffset = Math.min(distance * 0.3, 100);
            const cx1 = x1 + controlOffset;
            const cy1 = y1;
            const cx2 = x2 - controlOffset;
            const cy2 = y2;

            return `M ${x1} ${y1} C ${cx1} ${cy1}, ${cx2} ${cy2}, ${x2} ${y2}`;
        }

        // Enhanced Connection Drawing
        function drawEnhancedConnections() {
            const svg = document.getElementById('connectionSvg');
            svg.innerHTML = `
                <defs>
                    <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                        <polygon points="0 0, 10 3.5, 0 7" fill="var(--accent-color)" />
                    </marker>
                    <marker id="arrowhead-success" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                        <polygon points="0 0, 10 3.5, 0 7" fill="var(--success-color)" />
                    </marker>
                    <marker id="arrowhead-error" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                        <polygon points="0 0, 10 3.5, 0 7" fill="var(--error-color)" />
                    </marker>
                </defs>
            `;

            // Clear existing connection labels
            document.querySelectorAll('.connection-label').forEach(label => {
                if (!label.hasAttribute('data-keep')) {
                    label.remove();
                }
            });

            // Draw connections from configuration if available
            if (workflowConfiguration.length > 0) {
                drawConfigurationConnections();
            } else {
                // Draw sample connections for manual steps
                drawSampleConnections();
            }
        }

        function drawConfigurationConnections() {
            workflowConfiguration.forEach(row => {
                if (row.fromStep && row.toStep) {
                    const fromStep = generatedSteps.find(s => s.name === row.fromStep);
                    const toStep = generatedSteps.find(s => s.name === row.toStep);

                    if (fromStep && toStep) {
                        const fromElement = fromStep.element;
                        const toElement = toStep.element;

                        if (fromElement && toElement) {
                            drawConnection(fromElement, toElement, row.action, getConnectionType(row.action));
                        }
                    }
                }
            });
        }

        function drawSampleConnections() {
            const enhancedConnections = [
                { from: 'step1', to: 'step2', type: 'success', label: 'Submit Request' },
                { from: 'step2', to: 'step3', type: 'default', label: 'Approve' },
                { from: 'step2', to: 'step4', type: 'error', label: 'Reject' },
                { from: 'step3', to: 'step5', type: 'default', label: 'Escalate' },
                { from: 'step5', to: 'step6', type: 'success', label: 'Final Approve' }
            ];

            enhancedConnections.forEach(conn => {
                const fromElement = document.getElementById(conn.from);
                const toElement = document.getElementById(conn.to);

                if (fromElement && toElement) {
                    drawConnection(fromElement, toElement, conn.label, conn.type);
                }
            });
        }

        function drawConnection(fromElement, toElement, label, type = 'default') {
            const fromRect = fromElement.getBoundingClientRect();
            const toRect = toElement.getBoundingClientRect();
            const canvasRect = document.getElementById('workflowCanvas').getBoundingClientRect();

            const fromX = fromRect.left - canvasRect.left + fromRect.width;
            const fromY = fromRect.top - canvasRect.top + fromRect.height / 2;
            const toX = toRect.left - canvasRect.left;
            const toY = toRect.top - canvasRect.top + toRect.height / 2;

            // Create connection line
            const svg = document.getElementById('connectionSvg');
            const line = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            const d = createConnectionPath(fromX, fromY, toX, toY);
            line.setAttribute('d', d);
            line.setAttribute('class', `connection-line auto-connection ${type || 'default'}`);
            line.setAttribute('stroke-width', '2.5');
            line.setAttribute('fill', 'none');
            line.setAttribute('marker-end', `url(#arrowhead${type && type !== 'default' ? '-' + type : ''})`);
            line.setAttribute('data-connection-id', `${fromElement.id}-${toElement.id}`);

            // Add click handler for connection selection
            line.addEventListener('click', function () {
                selectConnection(this);
            });

            svg.appendChild(line);

            // Create connection label
            if (label) {
                const labelX = (fromX + toX) / 2;
                const labelY = (fromY + toY) / 2;

                const labelElement = document.createElement('div');
                labelElement.className = 'connection-label';
                labelElement.textContent = label;
                labelElement.style.left = labelX + 'px';
                labelElement.style.top = labelY + 'px';
                labelElement.setAttribute('data-connection-id', `${fromElement.id}-${toElement.id}`);

                document.getElementById('workflowCanvas').appendChild(labelElement);
            }
        }

        function getConnectionType(action) {
            const actionLower = action.toLowerCase();
            if (actionLower.includes('reject') || actionLower.includes('deny') || actionLower.includes('cancel')) {
                return 'error';
            } else if (actionLower.includes('approve') || actionLower.includes('accept') || actionLower.includes('complete')) {
                return 'success';
            }
            return 'default';
        }

        function selectConnection(connectionElement) {
            // Remove previous selection
            document.querySelectorAll('.connection-line').forEach(line => {
                line.classList.remove('selected');
            });

            // Select current connection
            connectionElement.classList.add('selected');

            showEnhancedNotification('Connection selected', 'Press Delete to remove', 'info');
        }

        // Canvas Zoom and Pan
        function zoomCanvas(factor) {
            canvasZoom *= factor;
            canvasZoom = Math.max(0.1, Math.min(canvasZoom, 3)); // Limit zoom range

            const canvas = document.getElementById('workflowCanvas');
            canvas.style.transform = `scale(${canvasZoom}) translate(${canvasOffset.x}px, ${canvasOffset.y}px)`;

            // Update zoom level display
            document.getElementById('zoomLevel').textContent = Math.round(canvasZoom * 100) + '%';

            // Redraw connections after zoom
            setTimeout(drawEnhancedConnections, 100);
        }

        function resetZoom() {
            canvasZoom = 1;
            canvasOffset = { x: 0, y: 0 };

            const canvas = document.getElementById('workflowCanvas');
            canvas.style.transform = 'scale(1) translate(0px, 0px)';

            document.getElementById('zoomLevel').textContent = '100%';

            setTimeout(drawEnhancedConnections, 100);
            showEnhancedNotification('Zoom reset to 100%', 'Canvas Reset', 'info');
        }

        function fitToScreen() {
            const canvas = document.getElementById('workflowCanvas');
            const steps = canvas.querySelectorAll('.workflow-step');

            if (steps.length === 0) return;

            // Calculate bounding box of all steps
            let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;

            steps.forEach(step => {
                const rect = step.getBoundingClientRect();
                const canvasRect = canvas.getBoundingClientRect();
                const x = rect.left - canvasRect.left;
                const y = rect.top - canvasRect.top;

                minX = Math.min(minX, x);
                minY = Math.min(minY, y);
                maxX = Math.max(maxX, x + rect.width);
                maxY = Math.max(maxY, y + rect.height);
            });

            // Calculate zoom to fit
            const padding = 50;
            const availableWidth = canvas.offsetWidth - padding * 2;
            const availableHeight = canvas.offsetHeight - padding * 2;
            const contentWidth = maxX - minX;
            const contentHeight = maxY - minY;

            const zoomX = availableWidth / contentWidth;
            const zoomY = availableHeight / contentHeight;
            canvasZoom = Math.min(zoomX, zoomY, 1); // Don't zoom in beyond 100%

            // Center content
            canvasOffset.x = (availableWidth - contentWidth * canvasZoom) / 2 - minX * canvasZoom;
            canvasOffset.y = (availableHeight - contentHeight * canvasZoom) / 2 - minY * canvasZoom;

            canvas.style.transform = `scale(${canvasZoom}) translate(${canvasOffset.x}px, ${canvasOffset.y}px)`;
            document.getElementById('zoomLevel').textContent = Math.round(canvasZoom * 100) + '%';

            setTimeout(drawEnhancedConnections, 100);
            showEnhancedNotification('Workflow fitted to screen', 'Auto Layout', 'success');
        }

        function autoLayoutWorkflow() {
            const steps = document.querySelectorAll('.workflow-step');
            const canvas = document.getElementById('workflowCanvas');

            // Simple auto-layout algorithm
            const startX = 100;
            const startY = 100;
            const stepSpacing = 250;
            const levelSpacing = 200;

            let currentX = startX;
            let currentY = startY;
            let level = 0;

            steps.forEach((step, index) => {
                if (index > 0 && index % 3 === 0) {
                    level++;
                    currentX = startX;
                    currentY = startY + (level * levelSpacing);
                }

                step.style.left = currentX + 'px';
                step.style.top = currentY + 'px';

                currentX += stepSpacing;
            });

            // Redraw connections
            setTimeout(drawEnhancedConnections, 100);
            showEnhancedNotification('Workflow auto-arranged', 'Auto Layout Complete', 'success');
        }

        // Mini Map Functions
        function updateMiniMap() {
            const miniMap = document.getElementById('miniMap');
            const canvas = document.getElementById('workflowCanvas');
            const steps = canvas.querySelectorAll('.workflow-step');

            // Clear existing mini map steps
            miniMap.querySelectorAll('.mini-map-step').forEach(step => step.remove());

            // Add steps to mini map
            steps.forEach(step => {
                const rect = step.getBoundingClientRect();
                const canvasRect = canvas.getBoundingClientRect();

                const miniStep = document.createElement('div');
                miniStep.className = 'mini-map-step';

                // Scale position to mini map
                const scaleX = miniMap.offsetWidth / canvas.offsetWidth;
                const scaleY = miniMap.offsetHeight / canvas.offsetHeight;

                miniStep.style.left = (rect.left - canvasRect.left) * scaleX + 'px';
                miniStep.style.top = (rect.top - canvasRect.top) * scaleY + 'px';

                miniMap.querySelector('.mini-map-content').appendChild(miniStep);
            });
        }

        // Enhanced Features Functions



        // Search Functions
        function initializeSearch() {
            const searchInput = document.getElementById('globalSearch');
            searchInput.addEventListener('input', handleSearch);
            searchInput.addEventListener('keydown', function (e) {
                if (e.key === 'Enter') {
                    performAdvancedSearch();
                }
            });
        }

        function handleSearch(e) {
            const query = e.target.value.toLowerCase();
            if (query.length > 2) {
                // Simulate search results
                console.log('Searching for:', query);
                // In a real application, this would filter workflows, tasks, etc.
            }
        }

        function toggleFilter(element, filterType) {
            // Remove active from all filters
            document.querySelectorAll('.filter-chip').forEach(chip => {
                chip.classList.remove('active');
            });

            // Add active to clicked filter
            element.classList.add('active');

            // Update search filters
            searchFilters = [filterType];

            showEnhancedNotification(`Filter applied: ${filterType}`, 'Search Updated', 'info');
        }

        function performAdvancedSearch() {
            const query = document.getElementById('globalSearch').value;
            showEnhancedNotification(`Searching for: "${query}"`, 'Advanced Search', 'info');
        }

        // Context Menu Functions
        function initializeContextMenu() {
            document.addEventListener('click', hideContextMenu);

            // Add context menu to existing steps
            document.querySelectorAll('.workflow-step').forEach(step => {
                step.addEventListener('contextmenu', function (e) {
                    e.preventDefault();
                    showContextMenu(e, step);
                });
            });
        }

        function showContextMenu(e, target) {
            const contextMenu = document.getElementById('contextMenu');
            contextMenuTarget = target;

            contextMenu.style.display = 'block';
            contextMenu.style.left = e.pageX + 'px';
            contextMenu.style.top = e.pageY + 'px';
        }

        function hideContextMenu() {
            document.getElementById('contextMenu').style.display = 'none';
            contextMenuTarget = null;
        }

        function duplicateStep() {
            if (contextMenuTarget) {
                const rect = contextMenuTarget.getBoundingClientRect();
                const canvas = document.getElementById('workflowCanvas');
                const canvasRect = canvas.getBoundingClientRect();

                const x = rect.left - canvasRect.left + 200;
                const y = rect.top - canvasRect.top;

                createNewStep('intermediate', x, y);
                hideContextMenu();
            }
        }

        function addConnection() {
            showEnhancedNotification('Connection mode activated', 'Click two steps to connect', 'info');
            hideContextMenu();
        }

        function removeConnection() {
            showEnhancedNotification('Connection removed', 'Connection Deleted', 'warning');
            hideContextMenu();
        }



        // Keyboard Shortcuts
        function initializeKeyboardShortcuts() {
            document.addEventListener('keydown', function (e) {
                // Ctrl/Cmd + S: Save workflow
                if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                    e.preventDefault();
                    saveWorkflow();
                }

                // Ctrl/Cmd + N: New workflow
                if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
                    e.preventDefault();
                    createNewWorkflow();
                }

                // Ctrl/Cmd + F: Focus search
                if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
                    e.preventDefault();
                    document.getElementById('globalSearch').focus();
                }

                // P: Toggle step palette
                if (e.key === 'p' && !e.ctrlKey && !e.metaKey) {
                    toggleStepPalette();
                }

                // Escape: Close modals/panels
                if (e.key === 'Escape') {
                    closeSidebar();
                    hideContextMenu();
                    if (isStepPaletteOpen) toggleStepPalette();
                }

                // Delete: Delete selected step
                if (e.key === 'Delete' && selectedStep) {
                    deleteStep();
                }
            });
        }

        // Quick Actions
        function showQuickActions() {
            const fab = document.getElementById('fab');
            const icon = fab.querySelector('.material-icons');

            if (icon.textContent === 'add') {
                // Show quick action menu
                icon.textContent = 'close';
                showEnhancedNotification('Quick actions available', 'Use keyboard shortcuts', 'info');
            } else {
                // Hide quick action menu
                icon.textContent = 'add';
            }
        }

        // View Management
        function hideAllViews() {
            document.getElementById('workflowDesigner').style.display = 'none';
            document.getElementById('workflowConfigPanel').style.display = 'none';
        }

        // Enhanced Notification System
        function showEnhancedNotification(message, title = 'Notification', type = 'info', duration = 3000) {
            // Remove any existing notifications first
            const existingNotifications = document.querySelectorAll('.enhanced-notification');
            existingNotifications.forEach(notif => {
                notif.classList.add('hiding');
                setTimeout(() => notif.remove(), 200);
            });

            // Create new notification element
            const notification = document.createElement('div');
            notification.className = `enhanced-notification ${type}`;

            const icon = getNotificationIcon(type);

            notification.innerHTML = `
                <div class="notification-icon">
                    <span class="material-icons">${icon}</span>
                </div>
                <div class="notification-content">
                    <div class="notification-title">${title}</div>
                    <div class="notification-message">${message}</div>
                </div>
                <button class="notification-close" onclick="closeEnhancedNotification(this.parentElement)">
                    <span class="material-icons">close</span>
                </button>
                ${duration > 2000 ? `
                    <div class="notification-progress">
                        <div class="notification-progress-fill"></div>
                    </div>
                ` : ''}
            `;

            // Add to document
            document.body.appendChild(notification);

            // Trigger entrance animation
            setTimeout(() => {
                notification.classList.add('show');
            }, 10);

            // Show progress bar for longer notifications
            if (duration > 2000) {
                const progressFill = notification.querySelector('.notification-progress-fill');
                if (progressFill) {
                    progressFill.style.width = '100%';
                    progressFill.style.transition = `width ${duration}ms linear`;

                    setTimeout(() => {
                        progressFill.style.width = '0%';
                    }, 100);
                }
            }

            // Auto-hide notification
            setTimeout(() => {
                closeEnhancedNotification(notification);
            }, duration);

            return notification;
        }

        function closeEnhancedNotification(notification) {
            if (notification && notification.parentElement) {
                notification.classList.remove('show');
                notification.classList.add('hiding');

                // Completely remove the element after animation
                setTimeout(() => {
                    if (notification.parentElement) {
                        notification.remove();
                    }
                }, 300);
            }
        }

        function getNotificationIcon(type) {
            const icons = {
                'success': 'check_circle',
                'error': 'error',
                'warning': 'warning',
                'info': 'info'
            };
            return icons[type] || 'info';
        }

        function closeNotification() {
            document.getElementById('notification').classList.remove('show');
        }

        // Utility functions
        function showNotification(message, type = 'info') {
            showEnhancedNotification(message, 'Notification', type);
        }

        function showHelp() {
            showNotification('Help documentation coming soon...', 'info');
        }

        function toggleSettings() {
            showNotification('Settings panel coming soon...', 'info');
        }

        // Custom Alert System
        function showCustomAlert(message, title = 'Alert', type = 'info', buttons = ['OK']) {
            return new Promise((resolve) => {
                // Remove existing alerts
                const existingAlerts = document.querySelectorAll('.custom-alert-overlay');
                existingAlerts.forEach(alert => alert.remove());

                const overlay = document.createElement('div');
                overlay.className = 'custom-alert-overlay';

                const alertBox = document.createElement('div');
                alertBox.className = `custom-alert-box ${type}`;

                const icon = getNotificationIcon(type);

                alertBox.innerHTML = `
                    <div class="alert-header">
                        <div class="alert-icon">
                            <span class="material-icons">${icon}</span>
                        </div>
                        <div class="alert-title">${title}</div>
                    </div>
                    <div class="alert-message">${message}</div>
                    <div class="alert-buttons">
                        ${buttons.map((button, index) =>
                    `<button class="alert-btn ${index === buttons.length - 1 ? 'primary' : 'secondary'}" data-result="${button}">${button}</button>`
                ).join('')}
                    </div>
                `;

                overlay.appendChild(alertBox);
                document.body.appendChild(overlay);

                // Add styles if not already added
                if (!document.getElementById('customAlertStyles')) {
                    addCustomAlertStyles();
                }

                // Add event listeners
                const buttons_elements = alertBox.querySelectorAll('.alert-btn');
                buttons_elements.forEach(btn => {
                    btn.addEventListener('click', () => {
                        const result = btn.getAttribute('data-result');
                        overlay.classList.add('fade-out');
                        setTimeout(() => {
                            overlay.remove();
                            resolve(result);
                        }, 200);
                    });
                });

                // Show with animation
                setTimeout(() => {
                    overlay.classList.add('show');
                }, 10);

                // Close on escape key
                const escapeHandler = (e) => {
                    if (e.key === 'Escape') {
                        overlay.classList.add('fade-out');
                        setTimeout(() => {
                            overlay.remove();
                            resolve(buttons[0]); // Return first button as default
                        }, 200);
                        document.removeEventListener('keydown', escapeHandler);
                    }
                };
                document.addEventListener('keydown', escapeHandler);
            });
        }

        function addCustomAlertStyles() {
            const styles = document.createElement('style');
            styles.id = 'customAlertStyles';
            styles.textContent = `
                .custom-alert-overlay {
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.6);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 10001;
                    opacity: 0;
                    transition: opacity 0.3s ease;
                    backdrop-filter: blur(4px);
                }

                .custom-alert-overlay.show {
                    opacity: 1;
                }

                .custom-alert-overlay.fade-out {
                    opacity: 0;
                }

                .custom-alert-box {
                    background: var(--background-primary);
                    border-radius: var(--radius-lg);
                    padding: var(--spacing-xl);
                    max-width: 450px;
                    width: 90%;
                    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
                    transform: scale(0.9) translateY(-20px);
                    transition: transform 0.3s ease;
                    border: 1px solid var(--border-primary);
                }

                .custom-alert-overlay.show .custom-alert-box {
                    transform: scale(1) translateY(0);
                }

                .alert-header {
                    display: flex;
                    align-items: center;
                    gap: var(--spacing-md);
                    margin-bottom: var(--spacing-lg);
                }

                .alert-icon {
                    width: 48px;
                    height: 48px;
                    border-radius: 50%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    color: var(--text-white);
                    flex-shrink: 0;
                }

                .custom-alert-box.success .alert-icon {
                    background: var(--success-color);
                }

                .custom-alert-box.error .alert-icon {
                    background: var(--error-color);
                }

                .custom-alert-box.warning .alert-icon {
                    background: var(--warning-color);
                }

                .custom-alert-box.info .alert-icon {
                    background: var(--info-color);
                }

                .alert-title {
                    font-size: 1.25rem;
                    font-weight: 600;
                    color: var(--text-primary);
                }

                .alert-message {
                    color: var(--text-secondary);
                    line-height: 1.6;
                    margin-bottom: var(--spacing-xl);
                    font-size: 0.95rem;
                }

                .alert-buttons {
                    display: flex;
                    gap: var(--spacing-sm);
                    justify-content: flex-end;
                }

                .alert-btn {
                    padding: var(--spacing-sm) var(--spacing-lg);
                    border: none;
                    border-radius: var(--radius-md);
                    font-weight: 500;
                    cursor: pointer;
                    transition: all var(--transition-fast);
                    min-width: 80px;
                    font-size: 0.9rem;
                }

                .alert-btn.primary {
                    background: var(--accent-color);
                    color: var(--text-white);
                }

                .alert-btn.primary:hover {
                    background: #0056b3;
                    transform: translateY(-1px);
                    box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3);
                }

                .alert-btn.secondary {
                    background: var(--background-tertiary);
                    color: var(--text-primary);
                    border: 1px solid var(--border-primary);
                }

                .alert-btn.secondary:hover {
                    background: var(--background-secondary);
                    transform: translateY(-1px);
                    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
                }

                @media (max-width: 768px) {
                    .custom-alert-box {
                        margin: 20px;
                        max-width: none;
                    }

                    .alert-buttons {
                        flex-direction: column;
                    }

                    .alert-btn {
                        width: 100%;
                    }
                }
            `;
            document.head.appendChild(styles);
        }

        function getNotificationIcon(type) {
            const icons = {
                'success': 'check_circle',
                'error': 'error',
                'warning': 'warning',
                'info': 'info'
            };
            return icons[type] || 'info';
        }

        // Enhanced UI Features and Functionalities

        // Theme Toggle
        function toggleTheme() {
            const body = document.body;
            const themeIcon = document.getElementById('themeIcon');
            const isDark = body.classList.contains('dark-theme');

            if (isDark) {
                body.classList.remove('dark-theme');
                themeIcon.textContent = 'dark_mode';
                localStorage.setItem('theme', 'light');
                showEnhancedNotification('Light theme activated', 'Theme Changed', 'success');
            } else {
                body.classList.add('dark-theme');
                themeIcon.textContent = 'light_mode';
                localStorage.setItem('theme', 'dark');
                showEnhancedNotification('Dark theme activated', 'Theme Changed', 'success');
            }
        }

        // Global Search Functionality
        function setupGlobalSearch() {
            const searchInput = document.getElementById('globalSearch');
            const searchClear = document.querySelector('.search-clear');
            const searchSuggestions = document.getElementById('searchSuggestions');

            searchInput.addEventListener('input', function (e) {
                const query = e.target.value.trim();

                if (query.length > 0) {
                    searchClear.style.display = 'block';
                    showSearchSuggestions(query);
                } else {
                    searchClear.style.display = 'none';
                    hideSearchSuggestions();
                }
            });

            searchInput.addEventListener('keydown', function (e) {
                if (e.key === 'Enter') {
                    performGlobalSearch(e.target.value);
                }
            });
        }

        function showSearchSuggestions(query) {
            const suggestions = [
                'Warranty Claim Process',
                'Approval Workflow',
                'Review Process',
                'Escalation Workflow',
                'Branch Manager Review',
                'Supervisor Approval',
                'Submit Request',
                'Approve Action',
                'Reject Action',
                'Escalate Action'
            ];

            const filtered = suggestions.filter(item =>
                item.toLowerCase().includes(query.toLowerCase())
            );

            const suggestionsContainer = document.getElementById('searchSuggestions');

            if (filtered.length > 0) {
                suggestionsContainer.innerHTML = filtered.map(item =>
                    `<div class="search-suggestion" onclick="selectSuggestion('${item}')">${item}</div>`
                ).join('');
                suggestionsContainer.style.display = 'block';
            } else {
                hideSearchSuggestions();
            }
        }

        function hideSearchSuggestions() {
            document.getElementById('searchSuggestions').style.display = 'none';
        }

        function selectSuggestion(suggestion) {
            document.getElementById('globalSearch').value = suggestion;
            hideSearchSuggestions();
            performGlobalSearch(suggestion);
        }

        function performGlobalSearch(query) {
            showEnhancedNotification(`Searching for: "${query}"`, 'Search', 'info');
            // Implement actual search logic here
            hideSearchSuggestions();
        }

        function clearGlobalSearch() {
            document.getElementById('globalSearch').value = '';
            document.querySelector('.search-clear').style.display = 'none';
            hideSearchSuggestions();
        }

        // Fullscreen Toggle
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().then(() => {
                    showEnhancedNotification('Entered fullscreen mode', 'Fullscreen', 'info');
                });
            } else {
                document.exitFullscreen().then(() => {
                    showEnhancedNotification('Exited fullscreen mode', 'Fullscreen', 'info');
                });
            }
        }

        // Notifications Panel
        function showNotifications() {
            const notifications = [
                { id: 1, title: 'Workflow Approved', message: 'Warranty claim workflow has been approved', time: '2 min ago', type: 'success' },
                { id: 2, title: 'Pending Review', message: 'Branch manager review is pending', time: '15 min ago', type: 'warning' },
                { id: 3, title: 'New Template', message: 'Escalation template has been updated', time: '1 hour ago', type: 'info' }
            ];

            showNotificationPanel(notifications);
        }

        function showNotificationPanel(notifications) {
            const panel = document.createElement('div');
            panel.className = 'notification-panel';
            panel.innerHTML = `
                <div class="notification-panel-header">
                    <h3>Notifications</h3>
                    <button onclick="closeNotificationPanel()" class="btn btn-icon">
                        <span class="material-icons">close</span>
                    </button>
                </div>
                <div class="notification-panel-content">
                    ${notifications.map(notif => `
                        <div class="notification-item ${notif.type}">
                            <div class="notification-icon">
                                <span class="material-icons">${getNotificationIcon(notif.type)}</span>
                            </div>
                            <div class="notification-content">
                                <div class="notification-title">${notif.title}</div>
                                <div class="notification-message">${notif.message}</div>
                                <div class="notification-time">${notif.time}</div>
                            </div>
                        </div>
                    `).join('')}
                </div>
                <div class="notification-panel-footer">
                    <button class="btn btn-secondary" onclick="markAllAsRead()">Mark All as Read</button>
                </div>
            `;

            document.body.appendChild(panel);
            setTimeout(() => panel.classList.add('show'), 10);
        }

        function closeNotificationPanel() {
            const panel = document.querySelector('.notification-panel');
            if (panel) {
                panel.classList.remove('show');
                setTimeout(() => panel.remove(), 300);
            }
        }

        function markAllAsRead() {
            showEnhancedNotification('All notifications marked as read', 'Notifications', 'success');
            closeNotificationPanel();
        }

        // Workflow Library
        function showWorkflowLibrary() {
            const library = [
                { name: 'Warranty Claim Process', category: 'Claims', steps: 5, status: 'Active', lastModified: '2 days ago' },
                { name: 'Employee Onboarding', category: 'HR', steps: 8, status: 'Draft', lastModified: '1 week ago' },
                { name: 'Purchase Approval', category: 'Finance', steps: 4, status: 'Active', lastModified: '3 days ago' },
                { name: 'IT Support Escalation', category: 'IT', steps: 6, status: 'Active', lastModified: '5 days ago' }
            ];

            showWorkflowLibraryModal(library);
        }

        function showWorkflowLibraryModal(workflows) {
            const modal = document.createElement('div');
            modal.className = 'workflow-library-modal';
            modal.innerHTML = `
                <div class="modal-overlay" onclick="closeWorkflowLibrary()"></div>
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>Workflow Library</h2>
                        <button onclick="closeWorkflowLibrary()" class="btn btn-icon">
                            <span class="material-icons">close</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="library-filters">
                            <input type="text" placeholder="Search workflows..." class="library-search" id="librarySearch">
                            <select class="library-category-filter" id="libraryCategoryFilter">
                                <option value="">All Categories</option>
                                <option value="Claims">Claims</option>
                                <option value="HR">HR</option>
                                <option value="Finance">Finance</option>
                                <option value="IT">IT</option>
                            </select>
                        </div>
                        <div class="library-grid" id="libraryGrid">
                            ${renderWorkflowItems(workflows)}
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
            setTimeout(() => modal.classList.add('show'), 10);

            // Add event listeners for search and filter
            setupLibraryFilters(workflows);
        }

        function renderWorkflowItems(workflows) {
            return workflows.map(workflow => `
                <div class="library-item" onclick="loadWorkflowFromLibrary('${workflow.name}')">
                    <div class="library-item-header">
                        <h4>${workflow.name}</h4>
                        <span class="status-badge ${workflow.status.toLowerCase()}">${workflow.status}</span>
                    </div>
                    <div class="library-item-details">
                        <div class="detail-item">
                            <span class="material-icons">category</span>
                            ${workflow.category}
                        </div>
                        <div class="detail-item">
                            <span class="material-icons">layers</span>
                            ${workflow.steps} steps
                        </div>
                        <div class="detail-item">
                            <span class="material-icons">schedule</span>
                            ${workflow.lastModified}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function setupLibraryFilters(workflows) {
            const searchInput = document.getElementById('librarySearch');
            const categoryFilter = document.getElementById('libraryCategoryFilter');
            const libraryGrid = document.getElementById('libraryGrid');

            function filterWorkflows() {
                const searchTerm = searchInput.value.toLowerCase();
                const selectedCategory = categoryFilter.value;

                const filtered = workflows.filter(workflow => {
                    const matchesSearch = workflow.name.toLowerCase().includes(searchTerm) ||
                        workflow.category.toLowerCase().includes(searchTerm);
                    const matchesCategory = !selectedCategory || workflow.category === selectedCategory;

                    return matchesSearch && matchesCategory;
                });

                libraryGrid.innerHTML = renderWorkflowItems(filtered);

                if (filtered.length === 0) {
                    libraryGrid.innerHTML = `
                        <div style="grid-column: 1 / -1; text-align: center; padding: var(--spacing-xl); color: var(--text-secondary);">
                            <span class="material-icons" style="font-size: 3rem; margin-bottom: var(--spacing-md); opacity: 0.5;">search_off</span>
                            <div style="font-size: 1.1rem; margin-bottom: var(--spacing-sm);">No workflows found</div>
                            <div style="font-size: 0.875rem;">Try adjusting your search or filter criteria</div>
                        </div>
                    `;
                }
            }

            searchInput.addEventListener('input', filterWorkflows);
            categoryFilter.addEventListener('change', filterWorkflows);
        }

        function closeWorkflowLibrary() {
            const modal = document.querySelector('.workflow-library-modal');
            if (modal) {
                modal.classList.remove('show');
                setTimeout(() => modal.remove(), 300);
            }
        }

        function loadWorkflowFromLibrary(workflowName) {
            showEnhancedNotification(`Loading workflow: ${workflowName}`, 'Library', 'info');
            closeWorkflowLibrary();
            // Implement workflow loading logic
        }

        // User Menu
        function toggleUserMenu() {
            showEnhancedNotification('User menu functionality coming soon', 'User Menu', 'info');
        }

        // Enhanced Export Functionality
        function showExportOptions() {
            const exportModal = document.createElement('div');
            exportModal.className = 'export-modal';
            exportModal.innerHTML = `
                <div class="modal-overlay" onclick="closeExportModal()"></div>
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>Export Workflow</h2>
                        <button onclick="closeExportModal()" class="btn btn-icon">
                            <span class="material-icons">close</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="export-options">
                            <div class="export-option" onclick="exportWorkflow('pdf')">
                                <span class="material-icons">picture_as_pdf</span>
                                <div class="export-option-text">
                                    <h4>PDF Document</h4>
                                    <p>Export as a formatted PDF document</p>
                                </div>
                            </div>
                            <div class="export-option" onclick="exportWorkflow('excel')">
                                <span class="material-icons">table_chart</span>
                                <div class="export-option-text">
                                    <h4>Excel Spreadsheet</h4>
                                    <p>Export configuration as Excel file</p>
                                </div>
                            </div>
                            <div class="export-option" onclick="exportWorkflow('json')">
                                <span class="material-icons">code</span>
                                <div class="export-option-text">
                                    <h4>JSON Format</h4>
                                    <p>Export as JSON for system integration</p>
                                </div>
                            </div>
                            <div class="export-option" onclick="exportWorkflow('image')">
                                <span class="material-icons">image</span>
                                <div class="export-option-text">
                                    <h4>Image (PNG)</h4>
                                    <p>Export workflow diagram as image</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(exportModal);
            setTimeout(() => exportModal.classList.add('show'), 10);
        }

        function closeExportModal() {
            const modal = document.querySelector('.export-modal');
            if (modal) {
                modal.classList.remove('show');
                setTimeout(() => modal.remove(), 300);
            }
        }

        function exportWorkflow(format) {
            showEnhancedNotification(`Exporting workflow as ${format.toUpperCase()}...`, 'Export', 'info');
            closeExportModal();

            // Simulate export process
            setTimeout(() => {
                showEnhancedNotification(`Workflow exported successfully as ${format.toUpperCase()}`, 'Export Complete', 'success');
            }, 2000);
        }

        // Initialize enhanced features
        function initializeEnhancedFeatures() {
            setupGlobalSearch();

            // Load saved theme
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-theme');
                document.getElementById('themeIcon').textContent = 'light_mode';
            }

            // Add keyboard shortcuts
            document.addEventListener('keydown', function (e) {
                if (e.ctrlKey || e.metaKey) {
                    switch (e.key) {
                        case 'k':
                            e.preventDefault();
                            document.getElementById('globalSearch').focus();
                            break;
                        case 's':
                            e.preventDefault();
                            showExportOptions();
                            break;
                        case 'f':
                            e.preventDefault();
                            toggleFullscreen();
                            break;
                    }
                }
            });

            showEnhancedNotification('Enhanced features loaded successfully', 'System Ready', 'success');
        }

        // Resize handler for responsive connections
        window.addEventListener('resize', function () {
            setTimeout(drawEnhancedConnections, 100);
            setTimeout(updateMiniMap, 200);
        });

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', initializeEnhancedFeatures);
    </script>
</body>

</html>