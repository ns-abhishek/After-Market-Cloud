<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - Aftermarket Software</title>

    <!-- Google Material Design Web Components -->
    <script src="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.js"></script>
    <link href="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.css" rel="stylesheet">

    <!-- Google Material Icons -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* Base styles */
        :root {
            --primary-color: #212529;
            --secondary-color: #f8f9fa;
            --accent-color: #757575;
            --border-color: #e0e0e0;
            --hover-color: #e9e9e9;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
            --border-radius: 8px;
            --success-color: #4caf50;
            --warning-color: #ff9800;
            --error-color: #f44336;
            --info-color: #2196f3;
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideInUp {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(33, 37, 41, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(33, 37, 41, 0); }
            100% { box-shadow: 0 0 0 0 rgba(33, 37, 41, 0); }
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Poppins', 'Roboto', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e8eb 100%);
            color: #333;
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .login-container {
            width: 100%;
            max-width: 420px;
            animation: fadeIn 0.5s ease;
            position: relative;
        }

        .login-card {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            animation: slideInUp 0.5s ease;
            position: relative;
        }

        .login-header {
            background-color: var(--primary-color);
            color: white;
            padding: 30px 20px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .login-header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 70%);
            transform: rotate(30deg);
        }

        .login-logo {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            position: relative;
        }

        .logo-icon {
            font-size: 32px;
            animation: pulse 2s infinite;
            background-color: white;
            color: var(--primary-color);
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .login-subtitle {
            font-size: 16px;
            opacity: 0.9;
            font-weight: 300;
        }

        .login-form {
            padding: 30px;
        }

        .form-group {
            margin-bottom: 24px;
            position: relative;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            font-size: 14px;
            color: #555;
        }

        .form-input {
            width: 100%;
            padding: 14px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 16px;
            transition: var(--transition);
            background-color: #f9f9f9;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(33, 37, 41, 0.1);
            background-color: white;
        }

        .password-container {
            position: relative;
        }

        .toggle-password {
            position: absolute;
            right: 14px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--accent-color);
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            transition: var(--transition);
        }

        .toggle-password:hover {
            background-color: rgba(0,0,0,0.05);
        }

        .remember-me {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 24px;
            user-select: none;
        }

        .remember-me input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--primary-color);
        }

        .login-button {
            width: 100%;
            padding: 14px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            text-transform: uppercase;
            letter-spacing: 1px;
            position: relative;
            overflow: hidden;
        }

        .login-button:hover {
            background-color: #343a40;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .login-button:active {
            transform: translateY(0);
            box-shadow: none;
        }

        .login-button:disabled {
            background-color: var(--accent-color);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .login-button::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 5px;
            height: 5px;
            background: rgba(255, 255, 255, 0.5);
            opacity: 0;
            border-radius: 100%;
            transform: scale(1, 1) translate(-50%);
            transform-origin: 50% 50%;
        }

        .login-button:focus:not(:active)::after {
            animation: ripple 1s ease-out;
        }

        @keyframes ripple {
            0% {
                transform: scale(0, 0);
                opacity: 0.5;
            }
            20% {
                transform: scale(25, 25);
                opacity: 0.3;
            }
            100% {
                opacity: 0;
                transform: scale(40, 40);
            }
        }

        .login-footer {
            padding: 20px 30px;
            text-align: center;
            border-top: 1px solid var(--border-color);
            background-color: #fafafa;
        }

        .forgot-password {
            color: var(--primary-color);
            text-decoration: none;
            transition: var(--transition);
            font-weight: 500;
            position: relative;
            display: inline-block;
        }

        .forgot-password:hover {
            color: #000;
        }

        .forgot-password::after {
            content: '';
            position: absolute;
            width: 100%;
            transform: scaleX(0);
            height: 2px;
            bottom: -2px;
            left: 0;
            background-color: var(--primary-color);
            transform-origin: bottom right;
            transition: transform 0.3s ease-out;
        }

        .forgot-password:hover::after {
            transform: scaleX(1);
            transform-origin: bottom left;
        }

        .error-message {
            color: var(--error-color);
            margin-top: 6px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .error-message i {
            font-size: 16px;
        }

        .mfa-container {
            display: none;
        }

        .mfa-code {
            letter-spacing: 8px;
            font-size: 24px;
            text-align: center;
            font-weight: 600;
        }

        .language-selector {
            position: absolute;
            top: 20px;
            right: 20px;
            background-color: white;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 8px 12px;
            font-size: 14px;
            cursor: pointer;
            z-index: 10;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: var(--transition);
        }

        .language-selector:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(33, 37, 41, 0.1);
        }

        /* Responsive */
        @media (max-width: 480px) {
            body {
                padding: 10px;
            }

            .login-container {
                max-width: 100%;
            }

            .login-form {
                padding: 20px;
            }

            .language-selector {
                top: 10px;
                right: 10px;
            }
        }
    </style>
</head>
<body>
    <select id="languageSelector" class="language-selector">
        <option value="en">English</option>
        <option value="es">Español</option>
        <option value="fr">Français</option>
    </select>

    <div class="login-container">
        <div class="login-card">
            <div class="login-header">
                <div class="login-logo">
                    <div class="logo-icon">
                        <i class="material-icons">build</i>
                    </div>
                    <span data-i18n="aftermarket_software">Aftermarket Software</span>
                </div>
                <div class="login-subtitle" data-i18n="login_subtitle">Secure access to your account</div>
            </div>
            <div class="login-form">
                <!-- Login Form -->
                <div id="loginForm">
                    <div class="form-group">
                        <label for="username" class="form-label" data-i18n="username">Username</label>
                        <input type="text" id="username" class="form-input" placeholder="Enter your username" data-i18n-placeholder="username_placeholder" autocomplete="username">
                        <div id="usernameError" class="error-message"></div>
                    </div>
                    <div class="form-group">
                        <label for="password" class="form-label" data-i18n="password">Password</label>
                        <div class="password-container">
                            <input type="password" id="password" class="form-input" placeholder="Enter your password" data-i18n-placeholder="password_placeholder" autocomplete="current-password">
                            <button type="button" class="toggle-password" id="togglePassword" aria-label="Toggle password visibility">
                                <i class="material-icons">visibility_off</i>
                            </button>
                        </div>
                        <div id="passwordError" class="error-message"></div>
                    </div>
                    <div class="remember-me">
                        <input type="checkbox" id="rememberMe">
                        <label for="rememberMe" data-i18n="remember_me">Remember me</label>
                    </div>
                    <button type="button" id="loginButton" class="login-button" data-i18n="login">
                        <span>Login</span>
                    </button>
                </div>

                <!-- MFA Form -->
                <div id="mfaForm" class="mfa-container">
                    <div class="form-group">
                        <label for="mfaCode" class="form-label" data-i18n="mfa_code">Authentication Code</label>
                        <input type="text" id="mfaCode" class="form-input mfa-code" placeholder="000000" maxlength="6" autocomplete="one-time-code" inputmode="numeric">
                        <div id="mfaError" class="error-message"></div>
                    </div>
                    <p style="margin-bottom: 20px; font-size: 14px; color: var(--accent-color);" data-i18n="mfa_instructions">
                        Please enter the 6-digit code from your authenticator app.
                    </p>
                    <button type="button" id="verifyMfaButton" class="login-button" data-i18n="verify">Verify</button>
                    <button type="button" id="backToLoginButton" class="login-button" style="background-color: transparent; color: var(--primary-color); margin-top: 16px; border: 1px solid var(--border-color);" data-i18n="back">Back</button>
                </div>
            </div>
            <div class="login-footer">
                <a href="#" class="forgot-password" data-i18n="forgot_password">Forgot your password?</a>
            </div>
        </div>
        <div style="text-align: center; margin-top: 20px; color: var(--accent-color); font-size: 14px;">
            <p>© 2023 Aftermarket Software. All rights reserved.</p>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0,0,0,0.5); z-index: 9999; justify-content: center; align-items: center;">
        <div style="background-color: white; padding: 30px; border-radius: var(--border-radius); box-shadow: var(--shadow); text-align: center;">
            <div class="material-icons" style="font-size: 48px; color: var(--primary-color); animation: spin 1.5s linear infinite;">sync</div>
            <p style="margin-top: 16px; font-weight: 500;">Logging in...</p>
        </div>
    </div>

    <style>
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>

    <!-- JavaScript -->
    <script src="data-service.js"></script>
    <script src="security-service.js"></script>
    <script src="translations.js"></script>
    <script src="navigation-controller.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize language
            initLanguage();

            // Check if already logged in
            if (SecurityService.isLoggedIn()) {
                navigateToDashboard();
                return;
            }

            // Check for remembered username
            const rememberedUsername = localStorage.getItem('rememberedUsername');
            if (rememberedUsername) {
                document.getElementById('username').value = rememberedUsername;
                document.getElementById('rememberMe').checked = true;
                // Focus on password field instead
                setTimeout(() => document.getElementById('password').focus(), 100);
            } else {
                // Focus on username field
                setTimeout(() => document.getElementById('username').focus(), 100);
            }

            // Set up event listeners
            setupEventListeners();
        });

        // Function to initialize language
        function initLanguage() {
            // Get preferred language from localStorage or use browser language
            const preferredLanguage = localStorage.getItem('preferredLanguage') ||
                                     navigator.language.split('-')[0] ||
                                     'en';

            // Set the language selector value
            const languageSelector = document.getElementById('languageSelector');
            if (languageSelector) {
                languageSelector.value = preferredLanguage;
            }

            // Translate the UI
            translateUI(preferredLanguage);
        }

        // Function to set up event listeners
        function setupEventListeners() {
            // Language selector
            const languageSelector = document.getElementById('languageSelector');
            if (languageSelector) {
                languageSelector.addEventListener('change', function() {
                    const selectedLanguage = this.value;
                    localStorage.setItem('preferredLanguage', selectedLanguage);
                    translateUI(selectedLanguage);
                });
            }

            // Toggle password visibility
            const togglePassword = document.getElementById('togglePassword');
            const passwordInput = document.getElementById('password');

            if (togglePassword && passwordInput) {
                togglePassword.addEventListener('click', function() {
                    const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                    passwordInput.setAttribute('type', type);

                    // Toggle icon
                    const icon = this.querySelector('i');
                    icon.textContent = type === 'password' ? 'visibility_off' : 'visibility';
                });
            }

            // Login button
            const loginButton = document.getElementById('loginButton');
            if (loginButton) {
                loginButton.addEventListener('click', handleLogin);

                // Also handle Enter key press
                document.getElementById('username').addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        document.getElementById('password').focus();
                    }
                });

                document.getElementById('password').addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        handleLogin();
                    }
                });
            }

            // MFA verification button
            const verifyMfaButton = document.getElementById('verifyMfaButton');
            if (verifyMfaButton) {
                verifyMfaButton.addEventListener('click', handleMfaVerification);

                // Also handle Enter key press
                document.getElementById('mfaCode').addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        handleMfaVerification();
                    }
                });

                // Auto-format MFA code with spaces
                document.getElementById('mfaCode').addEventListener('input', function(e) {
                    // Remove non-digits
                    let value = this.value.replace(/\D/g, '');

                    // Limit to 6 digits
                    if (value.length > 6) {
                        value = value.substring(0, 6);
                    }

                    // Update the input value
                    this.value = value;
                });
            }

            // Back to login button
            const backToLoginButton = document.getElementById('backToLoginButton');
            if (backToLoginButton) {
                backToLoginButton.addEventListener('click', function() {
                    showLoginForm();
                });
            }

            // Forgot password link
            const forgotPasswordLink = document.querySelector('.forgot-password');
            if (forgotPasswordLink) {
                forgotPasswordLink.addEventListener('click', function(e) {
                    e.preventDefault();

                    // Show a more user-friendly message using NavigationController if available
                    if (typeof NavigationController !== 'undefined') {
                        NavigationController.showNotification('Password reset functionality would be implemented here.', 'info');
                    } else {
                        alert('Password reset functionality would be implemented here.');
                    }
                });
            }
        }

        // Function to handle login
        function handleLogin() {
            // Clear previous errors
            document.getElementById('usernameError').textContent = '';
            document.getElementById('passwordError').textContent = '';

            // Get form values
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            const rememberMe = document.getElementById('rememberMe').checked;

            // Validate form
            let isValid = true;

            if (!username) {
                document.getElementById('usernameError').innerHTML = '<i class="material-icons">error_outline</i> Username is required';
                isValid = false;
            }

            if (!password) {
                document.getElementById('passwordError').innerHTML = '<i class="material-icons">error_outline</i> Password is required';
                isValid = false;
            }

            if (!isValid) {
                return;
            }

            // Show loading overlay
            const loadingOverlay = document.getElementById('loadingOverlay');
            loadingOverlay.style.display = 'flex';

            // Disable login button
            const loginButton = document.getElementById('loginButton');
            loginButton.disabled = true;

            // Simulate network delay for better UX (remove in production)
            setTimeout(() => {
                // Attempt login
                const result = SecurityService.login(username, password);

                // Hide loading overlay
                loadingOverlay.style.display = 'none';

                // Re-enable login button
                loginButton.disabled = false;

                // Handle login result
                if (result.success) {
                    // If remember me is checked, store username
                    if (rememberMe) {
                        localStorage.setItem('rememberedUsername', username);
                    } else {
                        localStorage.removeItem('rememberedUsername');
                    }

                    // Show success message before navigating
                    if (typeof NavigationController !== 'undefined') {
                        NavigationController.showNotification('Login successful! Redirecting...', 'success');
                    }

                    // Navigate to dashboard after a short delay
                    setTimeout(() => navigateToDashboard(), 500);
                } else if (result.requireMfa) {
                    // Show MFA form
                    showMfaForm(result.mfaMethod);
                } else {
                    // Show error message
                    document.getElementById('passwordError').innerHTML = '<i class="material-icons">error_outline</i> ' + result.message;

                    // Shake the login form to indicate error
                    const loginForm = document.querySelector('.login-card');
                    loginForm.style.animation = 'none';
                    setTimeout(() => {
                        loginForm.style.animation = 'shake 0.5s cubic-bezier(.36,.07,.19,.97) both';
                    }, 10);
                }
            }, 800); // Simulate network delay
        }

        // Function to handle MFA verification
        function handleMfaVerification() {
            // Clear previous errors
            document.getElementById('mfaError').textContent = '';

            // Get form values
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            const mfaCode = document.getElementById('mfaCode').value.trim();

            // Validate form
            if (!mfaCode) {
                document.getElementById('mfaError').innerHTML = '<i class="material-icons">error_outline</i> Authentication code is required';
                return;
            }

            if (!/^\d{6}$/.test(mfaCode)) {
                document.getElementById('mfaError').innerHTML = '<i class="material-icons">error_outline</i> Please enter a valid 6-digit code';
                return;
            }

            // Show loading overlay
            const loadingOverlay = document.getElementById('loadingOverlay');
            loadingOverlay.style.display = 'flex';

            // Disable verify button
            const verifyMfaButton = document.getElementById('verifyMfaButton');
            verifyMfaButton.disabled = true;

            // Simulate network delay for better UX (remove in production)
            setTimeout(() => {
                // Attempt login with MFA
                const result = SecurityService.login(username, password, mfaCode);

                // Hide loading overlay
                loadingOverlay.style.display = 'none';

                // Re-enable verify button
                verifyMfaButton.disabled = false;

                // Handle login result
                if (result.success) {
                    // Show success message before navigating
                    if (typeof NavigationController !== 'undefined') {
                        NavigationController.showNotification('Verification successful! Redirecting...', 'success');
                    }

                    // Navigate to dashboard after a short delay
                    setTimeout(() => navigateToDashboard(), 500);
                } else {
                    // Show error message
                    document.getElementById('mfaError').innerHTML = '<i class="material-icons">error_outline</i> ' + result.message;

                    // Shake the form to indicate error
                    const mfaForm = document.querySelector('.login-card');
                    mfaForm.style.animation = 'none';
                    setTimeout(() => {
                        mfaForm.style.animation = 'shake 0.5s cubic-bezier(.36,.07,.19,.97) both';
                    }, 10);
                }
            }, 800); // Simulate network delay
        }

        // Function to show MFA form
        function showMfaForm(mfaMethod) {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('mfaForm').style.display = 'block';

            // Update MFA instructions based on method
            const mfaInstructions = document.querySelector('[data-i18n="mfa_instructions"]');
            if (mfaInstructions) {
                switch (mfaMethod) {
                    case 'app':
                        mfaInstructions.textContent = 'Please enter the 6-digit code from your authenticator app.';
                        break;
                    case 'sms':
                        mfaInstructions.textContent = 'Please enter the 6-digit code sent to your phone.';
                        break;
                    case 'email':
                        mfaInstructions.textContent = 'Please enter the 6-digit code sent to your email.';
                        break;
                }
            }

            // Focus on MFA code input
            setTimeout(() => document.getElementById('mfaCode').focus(), 100);

            // Add shake animation for the form
            if (!document.querySelector('style#animationStyles')) {
                const styleElement = document.createElement('style');
                styleElement.id = 'animationStyles';
                styleElement.textContent = `
                    @keyframes shake {
                        10%, 90% { transform: translate3d(-1px, 0, 0); }
                        20%, 80% { transform: translate3d(2px, 0, 0); }
                        30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
                        40%, 60% { transform: translate3d(4px, 0, 0); }
                    }
                `;
                document.head.appendChild(styleElement);
            }
        }

        // Function to show login form
        function showLoginForm() {
            document.getElementById('mfaForm').style.display = 'none';
            document.getElementById('loginForm').style.display = 'block';

            // Clear MFA code
            document.getElementById('mfaCode').value = '';
            document.getElementById('mfaError').textContent = '';

            // Focus on password input
            setTimeout(() => document.getElementById('password').focus(), 100);
        }

        // Function to navigate to dashboard
        function navigateToDashboard() {
            if (typeof NavigationController !== 'undefined') {
                NavigationController.navigateTo('DASHBOARD');
            } else {
                window.location.href = 'party-portal.html';
            }
        }
    </script>
</body>
</html>
